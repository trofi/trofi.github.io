<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>trofi's blog: -fno-common legacy</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/code.css" />
        <link rel="stylesheet" type="text/css" href="../css/highlighting-kate.css" />

        <link rel="alternate" type="application/atom+xml" href="../feed/atom.xml" title="Atom 1.0" />
        <link rel="alternate" type="application/rss+xml" href="../feed/rss.xml" title="RSS 2.0" />
        <link rel="shortcut icon" href="../images/favicon.ico" />
    </head>
    <body>
        <div id="navigation">
            <a href="../">/</a>
            <a href="../archive.html">/archive</a>
            <a href="../feed/atom.xml">/atom</a>
            <a href="../feed/rss.xml">/rss</a>
        </div>

        <div id="content">
            <h1>-fno-common legacy</h1>

            <p>Around January 2020 (more than 2 years ago) <strong>gcc</strong> development version
switched from <strong>-fcommon</strong> to <strong>-fno-common</strong> by default:
<a href="https://gcc.gnu.org/PR85678" class="uri">https://gcc.gnu.org/PR85678</a>.</p>
<p>I personally like <strong>-fno-common</strong> default as it catches accidental
global variable sharing like the one in
<a href="https://github.com/FreeSpacenav/spacenavd/commit/7c271fa265613bd7d47601daaeb0e08e7c5b5a75">spacenavd</a>
or <strong>iozone</strong>. Occasional upstreams’
<a href="https://github.com/FreeSpacenav/spacenavd/issues/17">reluctance</a>
to make code <strong>-fno-common</strong>-clean was a bigsurprise to me. I just don’t
see any benefits of commoning like that. Luckily such reluctance is rare.</p>
<p>When I built my system with <strong>-fno-common</strong> toolchains I found 16 buggy
packages: <strong>syslinux</strong>, <strong>tftp-hpa</strong>, <strong>minicom</strong>, <strong>freeglut</strong>, <strong>openrc</strong>,
<strong>iproute2</strong>, <strong>gpm</strong>, <strong>xorg-server</strong>, <strong>logrotate</strong>, <strong>gnupg</strong>, <strong>libtirpc</strong>,
<strong>gdbm</strong>, <strong>cpio</strong>, <strong>postfix</strong>, <strong>xfsprogs</strong> and even <strong>glibc</strong>.</p>
<p>Some are very high profile packages. I would not expect such bugs in them.
My excuse for myself was that those are ancient code bases. Perhaps they
were initially written in a style that did not expect large size of project
and were never cleaned up later?</p>
<p>I had ~2K packages installed locally. I extrapolated 16 failures to 20K packages
of the whole repository (~10x) and hoped that we won’t get more than 160
failures. My intuition was saying that most of those packages should
be <strong>python</strong>, <strong>ruby</strong>, <strong>perl</strong>, <strong>php</strong> packages (probably unaffeched)
and thus the final number would be lower than 100.</p>
<p>When Toralf ran <strong>CFLAGS=-fno-common</strong> <strong>tinderbox</strong> build test
on the repository he started discovering more failures. I proposed fixes for
first few ten and was quickly overwhelmed. After a few weeks of <strong>tinderbox</strong>
run the bug list
contained ~800 failures! That is 5 times worse than I expected. Some of those
reports are probably duplicates but vast majority are unique real failures.
If I knew it’s so widespread I might have taken another way to roll it out.
Alas. Anyway, by now <strong>-fno-common</strong> is a fixed problem for Gentoo.</p>
<p>A few weeks ago I got commit access to <strong>nixpkgs</strong>. I’m feeling a bit uneasy
about it as I don’t formally maintain any packages there. At least I have
a few PRs to merge :)</p>
<p>Scrolling through pull requests I noticed that <strong>nixpkgs</strong> actually flipped
<strong>gcc-10</strong> (and <strong>llvm-11</strong>) back to <strong>-fcommon</strong> to avoid widespread breakage
and there was a PR to restore the default:
<a href="https://github.com/NixOS/nixpkgs/pull/110571" class="uri">https://github.com/NixOS/nixpkgs/pull/110571</a>. Now having a bit more
collaborative tools at my disposal I decided to sort it out for <strong>nixpkgs</strong>.
I did it once before :)</p>
<p><strong>gcc-10.1.0</strong> was released on May 7. That makes it almost exactly 2 years ago.
Some projects incorporated <strong>-fno-common</strong> fixes uptream and released
newer versions. But some did not. What would be the ratio of those?</p>
<p>So far I found <strong>80</strong> still broken packages in <strong>nixpkgs</strong>:
<a href="https://github.com/NixOS/nixpkgs/pull/110571#issuecomment-1119343199">incomplete list</a>.
From the list we can see that upstream mostly caught up.
That is only 10% from what we saw 2 years before. The caveat is that
it’s also an incomplete list of failures. It’s what I managed to build
in past 4 days. Once we sort most of there out I’ll request one full
hydra run.</p>
<p>We can see that vast majority of high-profile packages are fixed and
released. But there still are counterexamples like <strong>cpio</strong> (fixed in
git, no release yet) and <strong>syslinux</strong> (no fix upstream).</p>
<p>Some of packages are completely abandoned and should be removed like
a standalone <strong>dirmngr</strong> package.</p>
<p>For still broken packages I usually write a patch against dormant
upstream and attach it to the bug tracker so others could use patch
as is even if patch does not get merged in any form.</p>
<p>Sometimes there is no place upstream to make patch publicly available.
Then I have to resort to <strong>NIX_CFLAGS_COMPILE = “-fcommon”</strong> in <strong>.nix</strong>
expressions. So far I had to do it in 10 packages (maybe 30% of all
I tried to fix?). I hope it will save some time to others.</p>
<p>If you are the author of a package that had no release in past 2 years
and have a few minor tweaks then consider releasing it. You might save
some time for others. Maybe you even have a <strong>-fno-common</strong> fix pending?
:)</p>
<p>If you’d like to contribute to <strong>nixpkgs</strong> consider fixing a
<strong>-fno-common</strong> bug from the list above :) TO get you started the
reproducer is usually simple. Something like:</p>
<pre><code>$ nix build -L --impure --expr 'with import &lt;nixpkgs&gt; {}; jfsutils.overrideAttrs (oa: { NIX_CFLAGS_COMPILE = ([&quot;-fno-common&quot;] ++ [oa.NIX_CFLAGS_COMPILE or &quot;&quot;]); })'
...
jfsutils&gt; /nix/store/rs684lgm8k7akkgbisb49z4vpxxc2zns-binutils-2.38/bin/ld: extract.o:/build/jfsutils-1.1.15/fscklog/extract.c:67: multiple definition of `xchklog_buffer'; display.o:/build/jfsutils-1.1.15/fscklog/display.c:57: first defined here
jfsutils&gt; collect2: error: ld returned 1 exit status
jfsutils&gt; make[2]: *** [Makefile:373: jfs_fscklog] Error 1
jfsutils&gt; make[2]: Leaving directory '/build/jfsutils-1.1.15/fscklog'
jfsutils&gt; make[1]: *** [Makefile:363: all-recursive] Error 1
jfsutils&gt; make[1]: Leaving directory '/build/jfsutils-1.1.15'
jfsutils&gt; make: *** [Makefile:302: all] Error 2
error: builder for '/nix/store/cp4wavdy1x3rpbswzx141g794m0qsca7-jfsutils-1.1.15.drv' failed with exit code 2;</code></pre>
<p>That should get you started. See <a href="https://discourse.nixos.org/t/help-disabling-fno-common-hack/19031" class="uri">https://discourse.nixos.org/t/help-disabling-fno-common-hack/19031</a>
for more details.</p>
<p>Have fun!</p>

<div class="info">
    Posted on May 13, 2022 by trofi. <a href="mailto:slyich@gmail.com">Email</a>,
    <a href="https://github.com/trofi/trofi.github.io.gen">pull requests or comments</a>
    are welcome!
</div>

        </div>
        <div id="footer">
            powered by <a href="http://jaspervdj.be/hakyll">hakyll</a>
        </div>
    </body>
</html>
