<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>gcc-14 bugs, pile 2</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/code.css" />
        <link rel="stylesheet" type="text/css" href="../css/skylighting.css" />

        <link rel="alternate" type="application/atom+xml" href="../feed/atom.xml" title="Atom 1.0" />
        <link rel="alternate" type="application/rss+xml" href="../feed/rss.xml" title="RSS 2.0" />
        <link rel="shortcut icon" href="../images/favicon.ico" />
    </head>
    <body>
        <div id="navigation">
            <a href="../">home</a>
            <a href="../blog.html">blog</a>
            <a href="../log.html">log</a>
            <a href="../feed/atom.xml">atom</a>
            <a href="../feed/rss.xml">rss</a>
            <a href="../about.html">about</a>
            <a href="../contact.html">contact</a>
        </div>

        <div id="content">
            <h1>gcc-14 bugs, pile 2</h1>
            
                <div class="info">September  6, 2023</div>
            

            <p>Two more months of <code>gcc-14</code> development have passed. The bug rate slowed
down considerably. Let’s look at the new bugs since. This time it is
mere <code>10</code> bugs.</p>
<h2 id="summary">Summary</h2>
<p>Here are the bugs themselves:</p>
<ul>
<li><a href="https://gcc.gnu.org/PR110652"><code>tree-optimization/110652</code></a>: bootstrap failure for <code>-Werror</code>.</li>
<li><a href="https://gcc.gnu.org/PR110697"><code>middle-end/110697</code></a>: bootstrap failure for <code>-Werror</code>.</li>
<li><a href="https://gcc.gnu.org/PR110726"><code>tree-optimization/110726</code></a>: wrong code on <code>llvm</code>: <code>a |= a == 0</code>.</li>
<li><a href="https://gcc.gnu.org/PR110790"><code>target/110787</code></a>: wrong code on <code>gmp</code></li>
<li><a href="https://gcc.gnu.org/PR110838"><code>tree-optimization/110838</code></a>: wrong code on <code>x365</code></li>
<li><a href="https://gcc.gnu.org/PR110880"><code>target/110880</code></a>: <code>aarch64</code> ICE on <code>highway-1.0.5</code></li>
<li><a href="https://gcc.gnu.org/PR111009"><code>tree-optimization/111009</code></a>: wrong code on <code>perf</code> from <code>linux</code></li>
<li><a href="https://gcc.gnu.org/PR111048"><code>tree-optimization/111048</code></a>: wrong code on <code>highway-1.0.6</code></li>
<li><a href="https://gcc.gnu.org/PR111051"><code>target/111051</code></a>: <code>gcc</code> fails to use <code>avx2</code> primitives
on <code>avx512</code> targeted functions on <code>highway-1.0.6</code></li>
<li><a href="https://gcc.gnu.org/PR111060"><code>target/111060</code></a>: <code>i686-linux</code> <code>gcc</code> fails to build
it’s own <code>libbstdc++</code> due to missing <code>Float16</code> support.</li>
</ul>
<p>Histograms time!</p>
<p>Type of bugs:</p>
<ul>
<li><code>wrong-code</code>: 5</li>
<li><code>other</code>: 4</li>
<li><code>ICEs</code>: 1</li>
</ul>
<p>This was an unusual cycle: most of the bugs were related to the wrong
code generated by <code>gcc</code>. Some of them (like <code>gmp</code> and <code>perf</code> ones) were
very nasty to extract and report.</p>
<p>Subsystems:</p>
<ul>
<li><code>tree-optimization</code>: 5</li>
<li><code>target</code>: 4</li>
<li><code>middle-end</code>: 1</li>
</ul>
<p>As usual half the bugs are lurking in <code>tree-optimization</code> part of the
compiler. Though this time <code>target</code>-specific bugs are frequent as well.</p>
<h2 id="a-note-on-highway">A note on highway</h2>
<p>3 out of 10 bugs were exposed by a <code>highway</code> library. It’s such a great
vectorizer benchmark for <code>gcc</code>!
Initially I was a bit upset by the amount of C++ template indirections
<code>highway</code> uses on its implementation.
It exercises all the possible vector units available for the platform
(<code>SSE{2,3,4}</code>, <code>AVX{1,2}</code> and many others). It was hard for me to narrow
down to a single failing unit type: attempts to remove code for one of
them fails the build for others.</p>
<p>But! I found an easy way to deal with it! We can disable most irrelevant
targets in <code>hwy/detect_targets.h</code> by adding all the irrelevant targets
to <code>HWY_BROKEN_TARGETS</code> define. I usually add everything except the
broken target (usually <code>HWY_AVX2</code> :).
And then reduction becomes trivial: I expand all the templates and get
the simple function with a failure.</p>
<h2 id="parting-words">Parting words</h2>
<p><code>gcc</code> <code>master</code> still yields new bugs. It is still quite a bit of fun to
get and extract build compiler failures from real world usage.</p>
<p>I liked <a href="https://gcc.gnu.org/PR111048"><code>PR111048</code></a> the most. There <code>gcc</code> generated
wrong code for <code>highway-1.0.6</code> library in <code>-mavx2</code> mode.
When handling the following loop:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>u8 in_lanes<span class="op">[</span><span class="dv">32</span><span class="op">];</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">32</span><span class="op">;</span> i <span class="op">+=</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  in_lanes<span class="op">[</span>i <span class="op">+</span> <span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  in_lanes<span class="op">[</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="op">((</span>u8<span class="op">)</span><span class="bn">0xff</span><span class="op">)</span> <span class="op">&gt;&gt;</span> <span class="op">(</span>i <span class="op">&amp;</span> <span class="dv">7</span><span class="op">);</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>gcc</code> broke <code>i = 12;</code> iteration and instead of <code>i[13] = 0xf;</code>
(<code>0xff &gt;&gt; 4</code>) stored something like <code>i[13] = 0xef;</code> there. <code>gcc</code> was
able to fully constant-fold the loop (and did it slightly incorrectly).</p>
<p>Have fun!</p>
        </div>
    </body>
</html>
