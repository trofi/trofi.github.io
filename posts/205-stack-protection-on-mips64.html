<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>trofi's blog: Stack protection on mips64</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/code.css" />
        <link rel="stylesheet" type="text/css" href="../css/skylighting.css" />

        <link rel="alternate" type="application/atom+xml" href="../feed/atom.xml" title="Atom 1.0" />
        <link rel="alternate" type="application/rss+xml" href="../feed/rss.xml" title="RSS 2.0" />
        <link rel="shortcut icon" href="../images/favicon.ico" />
    </head>
    <body>
        <div id="navigation">
            <a href="../">/</a>
            <a href="../archive.html">/archive</a>
            <a href="../feed/atom.xml">/atom</a>
            <a href="../feed/rss.xml">/rss</a>
        </div>

        <div id="content">
            <h1>Stack protection on mips64</h1>

            <h1 id="bug">Bug</h1>
<p>On <strong>#gentoo-toolchain</strong> Matt Turner reported an obscure
<strong>SIGSEGV</strong> of <strong>top</strong> program on one of <strong>mips</strong> boxes:</p>
<pre class><code>07:01 &lt;@mattst88&gt; since upgrading to &gt;=glibc-2.25 on mips:
07:01 &lt;@mattst88&gt; bcm91250a-be ~ # top
07:01 &lt;@mattst88&gt; *** stack smashing detected ***: &lt;unknown&gt; terminated
07:01 &lt;@mattst88&gt; Aborted</code></pre>
<p>A simple (but widely used) tool seemingly managed to overwrite it’s stack.
Looks straightforward, right? Let’s see!</p>
<h1 id="reproducing">Reproducing</h1>
<p>As I don’t have any <strong>mips</strong> hardware I will fake some:</p>
<pre class><code># crossdev -t mips64-unknown-linux-gnu
# &lt;set a few profile variables&gt;
# mips64-unknown-linux-gnu-emerge -1 procps</code></pre>
<p>We’ve built a toolchain that targets <strong>mips64</strong> (<strong>N32</strong> ABI). Checking
if it crashes:</p>
<pre class><code>$ LD_LIBRARY_PATH=/lib64 qemu-mipsn32 -L /usr/mips64-unknown-linux-gnu /usr/mips64-unknown-linux-gnu/usr/bin/top
qemu: uncaught target signal 11 (Segmentation fault) - core dumped
Segmentation fault</code></pre>
<p>This is not exactly stack smash. But who knows, maybe my set of tools is slightly
different from Matt’s and the same bug manifests in a slightly different way.</p>
<h1 id="first-workaround">First workaround</h1>
<p>Gentoo recently enabled stack protection and already <a href="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=81996">exposed a bug</a>
at least on <strong>powerpc32</strong>.</p>
<p>First, let’s check if it’s related to stack protector option:</p>
<pre class><code># EXTRA_ECONF=--enable-stack-protector=no emerge -v1 cross-mips64-unknown-linux-gnu/glibc
$ LD_LIBRARY_PATH=/lib64 qemu-mipsn32 -L /usr/mips64-unknown-linux-gnu /usr/mips64-unknown-linux-gnu/usr/bin/top
&lt;running top&gt;</code></pre>
<p>That worked! To unbreak <strong>mips</strong> users I disabled <strong>glibc</strong> stack self-protection by
passing <a href="https://gitweb.gentoo.org/repo/gentoo.git/commit/sys-libs/glibc?id=b14c692fa08dc7bc53a81d32d36ddb1231769040">–enable-stack-protector=no</a>.</p>
<h1 id="into-the-rabbit-hole">Into the rabbit hole</h1>
<p>Now let’s try to find out what is at fault here. In case of <strong>powerpc</strong> it was bad <strong>gcc</strong>
code generation. Could it be something similar here?</p>
<p>First, we need a backtrace from <strong>qemu</strong>. Unfortunately <strong>qemu</strong>-generated <strong>.core</strong> files are truncated
and are not directly readable by <strong>gdb</strong>:</p>
<pre class><code>$ gdb --quiet /usr/mips64-unknown-linux-gnu/usr/bin/top qemu_top_20171216-220221_14697.core
Reading symbols from /usr/mips64-unknown-linux-gnu/usr/bin/top...done.
BFD: Warning: /home/slyfox/qemu_top_20171216-220221_14697.core is truncated: expected core file size &gt;= 8867840, found: 1504.</code></pre>
<p>Let’s try <strong>gdbserver</strong> mode instead. Running <strong>qemu</strong> with <strong>-g 12345</strong> to wait for <strong>gdb</strong> session:</p>
<pre class><code>$ LD_LIBRARY_PATH=/lib64 qemu-mipsn32 -g 12345 -L /usr/mips64-unknown-linux-gnu /usr/mips64-unknown-linux-gnu/usr/bin/top</code></pre>
<p>And in second terminal fire up <strong>gdb</strong>:</p>
<pre class><code>$ gdb --quiet /usr/mips64-unknown-linux-gnu/usr/bin/top
Reading symbols from /usr/mips64-unknown-linux-gnu/usr/bin/top...done.
(gdb) set sysroot /usr/mips64-unknown-linux-gnu
(gdb) target remote :12345
Remote debugging using :12345
Reading symbols from /usr/mips64-unknown-linux-gnu/lib32/ld.so.1...
Reading symbols from /usr/lib64/debug//usr/mips64-unknown-linux-gnu/lib32/ld-2.26.so.debug...done.
done.
0x40801d10 in __start () from /usr/mips64-unknown-linux-gnu/lib32/ld.so.1
(gdb) continue 
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x408cb908 in _dlerror_run (operate=operate@entry=0x408cadf0 &lt;dlopen_doit&gt;, args=args@entry=0x407feb58)
    at dlerror.c:163
163       result-&gt;errcode = _dl_catch_error (&amp;result-&gt;objname, &amp;result-&gt;errstring,
(gdb) bt
#0  0x408cb908 in _dlerror_run (operate=operate@entry=0x408cadf0 &lt;dlopen_doit&gt;, args=args@entry=0x407feb58)
    at dlerror.c:163
#1  0x408caf4c in __dlopen (file=file@entry=0x10012d58 &quot;libnuma.so&quot;, mode=mode@entry=1) at dlopen.c:87
#2  0x1000306c in before (me=0x407ff3b6 &quot;/usr/mips64-unknown-linux-gnu/usr/bin/top&quot;) at top/top.c:3308
#3  0x10001a10 in main (dont_care_argc=&lt;optimized out&gt;, argv=0x407ff1d4) at top/top.c:5721</code></pre>
<p>Woohoo! Nice backtrace! Matt confirmed he sees the same backtrace.</p>
<p>Curious fact: <strong>top</strong> tries to load <strong>libnuma.so</strong> opportunistically (<strong>top/top.c</strong>):</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef NUMA_DISABLE</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#if defined(PRETEND_NUMA) || defined(PRETEND8CPUS)</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>   Numa_node_tot <span class="op">=</span> Numa_max_node<span class="op">()</span> <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>   <span class="co">// we'll try for the most recent version, then a version we know works...</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>   <span class="cf">if</span> <span class="op">((</span>Libnuma_handle <span class="op">=</span> dlopen<span class="op">(</span><span class="st">&quot;libnuma.so&quot;</span><span class="op">,</span> RTLD_LAZY<span class="op">))</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">||</span> <span class="op">(</span>Libnuma_handle <span class="op">=</span> dlopen<span class="op">(</span><span class="st">&quot;libnuma.so.1&quot;</span><span class="op">,</span> RTLD_LAZY<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>      Numa_max_node <span class="op">=</span> dlsym<span class="op">(</span>Libnuma_handle<span class="op">,</span> <span class="st">&quot;numa_max_node&quot;</span><span class="op">);</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>      Numa_node_of_cpu <span class="op">=</span> dlsym<span class="op">(</span>Libnuma_handle<span class="op">,</span> <span class="st">&quot;numa_node_of_cpu&quot;</span><span class="op">);</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>Numa_max_node <span class="op">&amp;&amp;</span> Numa_node_of_cpu<span class="op">)</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>         Numa_node_tot <span class="op">=</span> Numa_max_node<span class="op">()</span> <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>         dlclose<span class="op">(</span>Libnuma_handle<span class="op">);</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>         Libnuma_handle <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span></code></pre></div>
<p>As I did not have <strong>libnuma</strong> installed it should not matter which library we try to load.
I tried to write a minimal reproducer that only calls <strong>dlopen()</strong>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;dlfcn.h&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">// mips64-unknown-linux-gnu-gcc dlopen-bug.c -o dlopen-bug -ldl</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> h <span class="op">=</span> dlopen<span class="op">(</span><span class="st">&quot;libdoes-not-exist.so&quot;</span><span class="op">,</span> RTLD_LAZY<span class="op">);</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<pre class><code>$ mips64-unknown-linux-gnu-gcc dlopen-bug.c -o dlopen-bug -ldl
$ qemu-mipsn32 -L /usr/mips64-unknown-linux-gnu ./dlopen-bug
qemu: uncaught target signal 11 (Segmentation fault) - core dumped
Segmentation fault</code></pre>
<p>The backtrace is the same. OK, that’s bad. If it’s a stack overflow it definitely happens
somewhere in <strong>glibc</strong> internals and not in the client.</p>
<h1 id="reproducing-on-master">Reproducing on master</h1>
<p>Chances are we will need to fix <strong>glibc</strong> to get our stack protection back. I tried to
reproduce the same failure on <strong>master</strong> branch:</p>
<pre class><code>$ ../glibc/configure \
      --enable-stack-protector=all \
      --enable-stackguard-randomization \
      --enable-kernel=3.2.0 \
      --enable-add-ons=libidn \
      --without-selinux \
      --without-cvs \
      --disable-werror \
      --enable-bind-now \
      --build=x86_64-pc-linux-gnu \
      --host=mips64-unknown-linux-gnu \
      --disable-profile \
      --without-gd \
      --with-headers=/usr/mips64-unknown-linux-gnu/usr/include \
      --prefix=/usr \
      --sysconfdir=/etc \
      --localstatedir=/var \
      --libdir='$(prefix)/lib32' \
      --mandir='$(prefix)/share/man' \
      --infodir='$(prefix)/share/info' \
      --libexecdir='$(libdir)/misc/glibc' \
      --disable-multi-arch \
      --disable-systemtap \
      --disable-nscd \
      --disable-timezone-tools \
      CFLAGS=&quot;-O2 -ggdb3&quot;
$ make
$ qemu-mipsn32 ./elf/ld.so --library-path .:dlfcn ~/tmp/dlopen-bug</code></pre>
<p>No failure. It could mean the bug was fixed in <strong>master</strong> or something else introduces the error.</p>
<p>I checked out <strong>glibc-2.26</strong> and retried above:</p>
<pre class><code>$ qemu-mipsn32 ./elf/ld.so --library-path .:dlfcn ~/tmp/dlopen-bug
qemu: uncaught target signal 11 (Segmentation fault) - core dumped
Segmentation fault</code></pre>
<p>Aha, the problem is still there in latest release.</p>
<p>I bisected glibc from <strong>2.26</strong> to <strong>master</strong> to find the commit that fixes <strong>SIGSEGV</strong>.
My bisection stopped at <a href="https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=2449ae7b2da24c9940962304a3e44bc80e389265">commit 2449ae7b</a></p>
<pre class><code>commit 2449ae7b2da24c9940962304a3e44bc80e389265
Author: Florian Weimer &lt;fweimer@redhat.com&gt;
Date:   Thu Aug 10 13:40:22 2017 +0200

    ld.so: Introduce struct dl_exception

    This commit separates allocating and raising exceptions.  This
    simplifies catching and re-raising them because it is no longer
    necessary to make a temporary, on-stack copy of the exception message.</code></pre>
<p>Looking hard at that commit I have found nothing that could fix a bug.
The change shuffled a few things around but did not change behaviour too much.</p>
<p>I decided to fetch <a href="https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=f87cc2bfba9b844da48a63441c6099342b1551c7">parent commit f87cc2bfb</a>
and spend some time to understand the failure mode.</p>
<p>First, the crash happens in <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=dlfcn/dlerror.c;h=c0ead7dcb64e782ac4f2bee67d6117dc68a8314f;hb=f87cc2bfba9b844da48a63441c6099342b1551c7#l124">_dlerror_run()</a> code:</p>
<pre class><code>0x40801c70 in __start () from /home/slyfox/tmp/lib32/ld.so.1
(gdb) continue 
Continuing.

Program received signal SIGSEGV, Segmentation fault.
_dlerror_run (operate=operate@entry=0x40838df0 &lt;dlopen_doit&gt;, args=args@entry=0x407ff058) at dlerror.c:163
163       result-&gt;errcode = _dl_catch_error (&amp;result-&gt;objname, &amp;result-&gt;errstring,
(gdb) bt
#0  _dlerror_run (operate=operate@entry=0x40838df0 &lt;dlopen_doit&gt;, args=args@entry=0x407ff058) at dlerror.c:163
#1  0x40838f4c in __dlopen (file=&lt;optimized out&gt;, mode=&lt;optimized out&gt;) at dlopen.c:87
#2  0x1000076c in main ()
(gdb) list
158           if (result-&gt;malloced)
159             free ((char *) result-&gt;errstring);
160           result-&gt;errstring = NULL;
161         }
162
163       result-&gt;errcode = _dl_catch_error (&amp;result-&gt;objname, &amp;result-&gt;errstring,
164                                          &amp;result-&gt;malloced, operate, args);
165
166       /* If no error we mark that no error string is available.  */
167       result-&gt;returned = result-&gt;errstring == NULL;</code></pre>
<p>Simplified version of <strong>_dlerror_run()</strong> looks like this:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> dl_action_result last_result<span class="op">;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> dl_action_result <span class="op">*</span>static_buf <span class="op">=</span> <span class="op">&amp;</span>last_result</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>internal_function</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>_dlerror_run <span class="op">(</span><span class="dt">void</span> <span class="op">(*</span>operate<span class="op">)</span> <span class="op">(</span><span class="dt">void</span> <span class="op">*),</span> <span class="dt">void</span> <span class="op">*</span>args<span class="op">)</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> dl_action_result <span class="op">*</span>result<span class="op">;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  result <span class="op">=</span> static_buf<span class="op">;</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>result<span class="op">-&gt;</span>errstring <span class="op">!=</span> NULL<span class="op">)</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>     <span class="cf">if</span> <span class="op">(</span>result<span class="op">-&gt;</span>malloced<span class="op">)</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>       free <span class="op">((</span><span class="dt">char</span> <span class="op">*)</span> result<span class="op">-&gt;</span>errstring<span class="op">);</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>     result<span class="op">-&gt;</span>errstring <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  result<span class="op">-&gt;</span>errcode <span class="op">=</span> _dl_catch_error <span class="op">(&amp;</span>result<span class="op">-&gt;</span>objname<span class="op">,</span> <span class="op">&amp;</span>result<span class="op">-&gt;</span>errstring<span class="op">,</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>                                     <span class="op">&amp;</span>result<span class="op">-&gt;</span>malloced<span class="op">,</span> operate<span class="op">,</span> args<span class="op">);</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* If no error we mark that no error string is available.  */</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  result<span class="op">-&gt;</span>returned <span class="op">=</span> result<span class="op">-&gt;</span>errstring <span class="op">==</span> NULL<span class="op">;</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">-&gt;</span>errstring <span class="op">!=</span> NULL<span class="op">;</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The <strong>SIGSEGV</strong> happens when we try to store result of <strong>_dl_catch_error()</strong>
into <strong>result-&gt;errcode</strong>.</p>
<p>I poked in <strong>gdb</strong> at the values of <strong>result</strong> right before <strong>_dl_catch_error()</strong>
call and after it. And values are different! Time to look at where <strong>result</strong> is physically
stored:</p>
<pre class><code>(gdb) disassemble /s _dlerror_run
163       result-&gt;errcode = _dl_catch_error (&amp;result-&gt;objname, &amp;result-&gt;errstring,
=&gt; 0x40839918 &lt;+184&gt;:   sw      v0,0(s0)
(gdb) print (void*)$s0
$1 = (void *) 0x40834c44 &lt;__stack_chk_guard&gt;</code></pre>
<p>The instruction stores single word(32 bits) at address of <strong>s0</strong> register. But <strong>s0</strong>
points not to <strong>last_result</strong> (it did right before the call) but at <strong>__stack_chk_guard</strong>.</p>
<h1 id="how-stack-checks-work-on-mips">How stack checks work on mips</h1>
<p>What is <strong>__stack_chk_guard</strong>? Has to do something about stack checks. Short answer: it’s a read-only
variable that holds stack canary value. <strong>glibc</strong> is not supposed to write to it after it
is initialized. Something leaked out address of that variable into <strong>s0</strong> (callee-save register).</p>
<p>Let’s familiarize ourselves with <strong>mips</strong> ABI a bit and look at how stack checks look
in generated code in a simple example:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> g<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{}</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">; mips64-unknown-linux-gnu-gcc -S b.c -fno-stack-protector -O1</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>.<span class="dt">file</span>   <span class="dv">1</span> <span class="st">&quot;b.c&quot;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>.<span class="bu">section</span> <span class="op">.</span>mdebug<span class="op">.</span>abiN32</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>.previous</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>.nan    legacy</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>.module fp<span class="op">=</span><span class="dv">64</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>.module oddspreg</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>.abicalls</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>.text</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>.<span class="bu">align</span>  <span class="dv">2</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>.globl  g</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>.<span class="bu">set</span>    nomips16</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>.<span class="bu">set</span>    nomicromips</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>.ent    g</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>.type   g<span class="op">,</span> <span class="fu">@f</span>unction</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="fu">g:</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    .frame  <span class="op">$</span>sp<span class="op">,</span><span class="dv">0</span><span class="op">,$</span><span class="bn">31</span>               <span class="op">#</span> vars<span class="op">=</span> <span class="dv">0</span><span class="op">,</span> regs<span class="op">=</span> <span class="dv">0</span><span class="op">/</span><span class="dv">0</span><span class="op">,</span> args<span class="op">=</span> <span class="dv">0</span><span class="op">,</span> gp<span class="op">=</span> <span class="dv">0</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    .mask   <span class="bn">0x00000000</span><span class="op">,</span><span class="dv">0</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    .fmask  <span class="bn">0x00000000</span><span class="op">,</span><span class="dv">0</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">set</span>    noreorder</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">set</span>    nomacro</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    jr      <span class="op">$</span><span class="bn">31</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>     <span class="bu">nop</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>.<span class="bu">set</span>    macro</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>.<span class="bu">set</span>    reorder</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>.<span class="pp">end</span>    g</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>.size   g<span class="op">,</span> <span class="op">.-</span>g</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>.ident  <span class="st">&quot;GCC: (Gentoo 7.2.0 p1.1) 7.2.0&quot;</span></span></code></pre></div>
<p><strong>31</strong> register is also known as <strong>ra</strong>, return address. The code has a lot of pragmas
but they are needed only for debugging. The real code is two insructions: <strong>jr $31; nop</strong>.</p>
<p>Let’s check what <strong>fstack-protector-all</strong> does with our code:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">; mips64-unknown-linux-gnu-gcc -S b.c -fstack-protector-all -O1</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>.<span class="dt">file</span>   <span class="dv">1</span> <span class="st">&quot;b.c&quot;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>.<span class="bu">section</span> <span class="op">.</span>mdebug<span class="op">.</span>abiN32</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>.previous</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>.nan    legacy</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>.module fp<span class="op">=</span><span class="dv">64</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>.module oddspreg</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>.abicalls</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>.text</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>.<span class="bu">align</span>  <span class="dv">2</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>.globl  g</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>.<span class="bu">set</span>    nomips16</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>.<span class="bu">set</span>    nomicromips</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>.ent    g</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>.type   g<span class="op">,</span> <span class="fu">@f</span>unction</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="fu">g:</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    .frame  <span class="op">$</span>sp<span class="op">,</span><span class="dv">32</span><span class="op">,$</span><span class="bn">31</span>              <span class="op">#</span> vars<span class="op">=</span> <span class="dv">16</span><span class="op">,</span> regs<span class="op">=</span> <span class="dv">2</span><span class="op">/</span><span class="dv">0</span><span class="op">,</span> args<span class="op">=</span> <span class="dv">0</span><span class="op">,</span> gp<span class="op">=</span> <span class="dv">0</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    .mask   <span class="bn">0x90000000</span><span class="op">,-</span><span class="dv">8</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    .fmask  <span class="bn">0x00000000</span><span class="op">,</span><span class="dv">0</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">set</span>    noreorder</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">set</span>    nomacro</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    addiu   <span class="op">$</span>sp<span class="op">,$</span>sp<span class="op">,-</span><span class="dv">32</span>                 <span class="co">; allocate 32 bytes on stack</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    sd      <span class="op">$</span><span class="bn">31</span><span class="op">,</span><span class="dv">24</span><span class="op">($</span>sp<span class="op">)</span>                 <span class="co">; backup $31 (ra)</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    sd      <span class="op">$</span><span class="bn">28</span><span class="op">,</span><span class="dv">16</span><span class="op">($</span>sp<span class="op">)</span>                 <span class="co">; backup $28 (gp)</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    lui     <span class="op">$</span><span class="bn">28</span><span class="op">,%</span>hi<span class="op">(</span>__gnu_local_gp<span class="op">)</span>     <span class="co">; compute address of GOT</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    addiu   <span class="op">$</span><span class="bn">28</span><span class="op">,$</span><span class="bn">28</span><span class="op">,%</span>lo<span class="op">(</span>__gnu_local_gp<span class="op">)</span> <span class="co">; (requires two instructions</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    lw      <span class="op">$</span><span class="bn">2</span><span class="op">,%</span>got_disp<span class="op">(</span>__stack_chk_guard<span class="op">)($</span><span class="bn">28</span><span class="op">)</span> <span class="co">; read offset of __stack_chk_guard in GOT</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    lw      <span class="op">$</span><span class="bn">3</span><span class="op">,</span><span class="dv">0</span><span class="op">($</span><span class="bn">2</span><span class="op">)</span>                    <span class="co">; read canary value of __stack_chk_guard</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    sw      <span class="op">$</span><span class="bn">3</span><span class="op">,</span><span class="dv">12</span><span class="op">($</span>sp<span class="op">)</span>                  <span class="co">; store canary on stack</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>                                        <span class="co">; ... time to check our canary!</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    lw      <span class="op">$</span><span class="bn">3</span><span class="op">,</span><span class="dv">12</span><span class="op">($</span>sp<span class="op">)</span>                  <span class="co">; load canary from stack</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    lw      <span class="op">$</span><span class="bn">2</span><span class="op">,</span><span class="dv">0</span><span class="op">($</span><span class="bn">2</span><span class="op">)</span>                    <span class="co">; load canary from __stack_chk_guard</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    bne     <span class="op">$</span><span class="bn">3</span><span class="op">,$</span><span class="bn">2</span><span class="op">,.</span>L4                   <span class="co">; check canary value and crash the program</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    ld      <span class="op">$</span><span class="bn">31</span><span class="op">,</span><span class="dv">24</span><span class="op">($</span>sp<span class="op">)</span>                 <span class="co">; restore return address</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    ld      <span class="op">$</span><span class="bn">28</span><span class="op">,</span><span class="dv">16</span><span class="op">($</span>sp<span class="op">)</span>                 <span class="co">; restore gp</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    jr      <span class="op">$</span><span class="bn">31</span>                         <span class="co">; (restore stack pointer and) return</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>     addiu   <span class="op">$</span>sp<span class="op">,$</span>sp<span class="op">,</span><span class="dv">32</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="fu">.L4:</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>    lw      <span class="op">$</span><span class="bn">25</span><span class="op">,%</span>call16<span class="op">(</span>__stack_chk_fail<span class="op">)($</span><span class="bn">28</span><span class="op">)</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    .reloc  <span class="fl">1</span><span class="bn">f</span><span class="op">,</span>R_MIPS_JALR<span class="op">,</span>__stack_chk_fail</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>1:      jalr    <span class="op">$</span><span class="bn">25</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">nop</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>.<span class="bu">set</span>    macro</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>.<span class="bu">set</span>    reorder</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>.<span class="pp">end</span>    g</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>.size   g<span class="op">,</span> <span class="op">.-</span>g</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>.ident  <span class="st">&quot;GCC: (Gentoo 7.2.0 p1.1) 7.2.0&quot;</span></span></code></pre></div>
<p>Here is a quick <a href="https://www.cs.umd.edu/class/sum2003/cmsc311/Notes/Mips/altReg.html">table</a> of <strong>mips</strong> registers.</p>
<p>15 instructions are doing the following: intermediate registers to hold canary value <strong>2</strong>(<strong>v0</strong>) and <strong>3</strong>(<strong>v1</strong>)
are written on stack (<strong>sp</strong> register), read back and checked against value stored in <strong>__stack_chk_guard</strong>.</p>
<p>Quite straightforward.</p>
<h1 id="who-broke-s0">Who broke s0?</h1>
<p>Back to our <strong>_dl_catch_error()</strong> why did <strong>s0</strong> change? <strong>mips</strong> <strong>ABI</strong> says <strong>s0</strong> is callee-save.
It means <strong>s0</strong> should not be changed by callee functions.</p>
<p>To get more clues we need to dive into <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=elf/dl-error-skeleton.c;h=8e5888d4bdf7e325358bc737000b31573f000736;hb=f87cc2bfba9b844da48a63441c6099342b1551c7#l171">**_dl_catch_error()**</a></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> catch</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">char</span> <span class="op">**</span>objname<span class="op">;</span>       <span class="co">/* Object/File name.  */</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">char</span> <span class="op">**</span>errstring<span class="op">;</span>     <span class="co">/* Error detail filled in here.  */</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bool</span> <span class="op">*</span>malloced<span class="op">;</span>             <span class="co">/* Nonzero if the string is malloced</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">                                 by the libc malloc.  */</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">volatile</span> <span class="dt">int</span> <span class="op">*</span>errcode<span class="op">;</span>      <span class="co">/* Return value of _dl_signal_error.  */</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  jmp_buf env<span class="op">;</span>                <span class="co">/* longjmp here on error.  */</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>internal_function</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>_dl_catch_error <span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">**</span>objname<span class="op">,</span> <span class="dt">const</span> <span class="dt">char</span> <span class="op">**</span>errstring<span class="op">,</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>                 <span class="dt">bool</span> <span class="op">*</span>mallocedp<span class="op">,</span> <span class="dt">void</span> <span class="op">(*</span>operate<span class="op">)</span> <span class="op">(</span><span class="dt">void</span> <span class="op">*),</span> <span class="dt">void</span> <span class="op">*</span>args<span class="op">)</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* We need not handle `receiver' since setting a `catch' is handled</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="co">     before it.  */</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Only this needs to be marked volatile, because it is the only local</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="co">     variable that gets changed between the setjmp invocation and the</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="co">     longjmp call.  All others are just set here (before setjmp) and read</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co">     in _dl_signal_error (before longjmp).  */</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">volatile</span> <span class="dt">int</span> errcode<span class="op">;</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> catch c<span class="op">;</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Don't use an initializer since we don't need to clear C.env.  */</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>  c<span class="op">.</span>objname <span class="op">=</span> objname<span class="op">;</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>  c<span class="op">.</span>errstring <span class="op">=</span> errstring<span class="op">;</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>  c<span class="op">.</span>malloced <span class="op">=</span> mallocedp<span class="op">;</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>  c<span class="op">.</span>errcode <span class="op">=</span> <span class="op">&amp;</span>errcode<span class="op">;</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> catch <span class="op">*</span><span class="dt">const</span> old <span class="op">=</span> catch_hook<span class="op">;</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>  catch_hook <span class="op">=</span> <span class="op">&amp;</span>c<span class="op">;</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Do not save the signal mask.  */</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>__builtin_expect <span class="op">(</span>__sigsetjmp <span class="op">(</span>c<span class="op">.</span>env<span class="op">,</span> <span class="dv">0</span><span class="op">),</span> <span class="dv">0</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>      <span class="op">(*</span>operate<span class="op">)</span> <span class="op">(</span>args<span class="op">);</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>      catch_hook <span class="op">=</span> old<span class="op">;</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>      <span class="op">*</span>objname <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>      <span class="op">*</span>errstring <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>      <span class="op">*</span>mallocedp <span class="op">=</span> false<span class="op">;</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* We get here only if we longjmp'd out of OPERATE.  _dl_signal_error has</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a><span class="co">     already stored values into *OBJNAME, *ERRSTRING, and *MALLOCEDP.  */</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>  catch_hook <span class="op">=</span> old<span class="op">;</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> errcode<span class="op">;</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This code is straightforward (but very scary): it wraps call of <strong>operate</strong> callback
into <strong>__sigsetjmp()</strong> (really just a <strong>setjmp()</strong>).</p>
<p><strong>setjmp()</strong> is a simple-ish function: it stores most of current registers into <strong>c.env()</strong>
and later <strong>longjmp()</strong> restores them. Caller-saves are not saved because <strong>longjmp()</strong>
looks like a normal C function call.</p>
<p>Normally <strong>longjmp()</strong> is called only when error condition happens. In our case it’s called
when <strong>dlopen()</strong> fails (we are opening non-existent file). <strong>longjmp()</strong> restores
all registers stored by <strong>setjmp()</strong> including instruction pointer <strong>pc</strong>, stack pointer <strong>sp</strong>,
caller-saves <strong>s0..s7</strong> and others.</p>
<p>The question arises: why and where do we lose <strong>s0</strong> register? At save (<strong>setjmp()</strong>)
or at restore (<strong>longjmp()</strong>)?</p>
<p>As we can see <strong>setjmp()</strong> and <strong>longjmp()</strong> are functions very sensitive to <strong>ABI</strong>. Let’s check how
<strong>__sigsetjmp()</strong> is implemented at <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=sysdeps/mips/mips64/setjmp.S;h=3e4120e1ea8db9e41f48d7efe17bd2f2ea8c38c5;hb=f87cc2bfba9b844da48a63441c6099342b1551c7#l22">sysdeps/mips/mips64/setjmp.S</a></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ENTRY</span> <span class="op">(</span>__sigsetjmp<span class="op">)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    SETUP_GP</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    SETUP_GP64_REG <span class="op">(</span>v0<span class="op">,</span> C_SYMBOL_NAME <span class="op">(</span>__sigsetjmp<span class="op">))</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    move a2<span class="op">,</span> <span class="kw">sp</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    move a3<span class="op">,</span> fp</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    PTR_LA t9<span class="op">,</span> __sigsetjmp_aux</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    RESTORE_GP64_REG</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    move a4<span class="op">,</span> gp</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    jr t9</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="pp">END</span> <span class="op">(</span>__sigsetjmp<span class="op">)</span></span></code></pre></div>
<p>Note how <strong>__sigsetjmp</strong> does almost nothing here: only saves <strong>gp</strong>, <strong>sp</strong> and <strong>fp</strong>
and defers everything to <strong>__sigsetjmp_aux</strong>. Let’s peek at that in
<a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=sysdeps/mips/mips64/setjmp_aux.c;h=b43c36a7d50d82da6d1e47c31a052e03e94f6aff;hb=f87cc2bfba9b844da48a63441c6099342b1551c7#l27">sysdeps/mips/mips64/setjmp_aux.c</a></p>
<p>Suddenly, its implementation is in C:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>__sigsetjmp_aux <span class="op">(</span>jmp_buf env<span class="op">,</span> <span class="dt">int</span> savemask<span class="op">,</span> <span class="dt">long</span> <span class="dt">long</span> sp<span class="op">,</span> <span class="dt">long</span> <span class="dt">long</span> fp<span class="op">,</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                 <span class="dt">long</span> <span class="dt">long</span> gp<span class="op">)</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Store the floating point callee-saved registers...  */</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;s.d $f20, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__fpregs<span class="op">[</span><span class="dv">0</span><span class="op">]));</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;s.d $f22, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__fpregs<span class="op">[</span><span class="dv">1</span><span class="op">]));</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;s.d $f24, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__fpregs<span class="op">[</span><span class="dv">2</span><span class="op">]));</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;s.d $f26, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__fpregs<span class="op">[</span><span class="dv">3</span><span class="op">]));</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;s.d $f28, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__fpregs<span class="op">[</span><span class="dv">4</span><span class="op">]));</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;s.d $f30, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__fpregs<span class="op">[</span><span class="dv">5</span><span class="op">]));</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* .. and the PC;  */</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;sd $31, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__pc<span class="op">));</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* .. and the stack pointer;  */</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>  env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__sp <span class="op">=</span> sp<span class="op">;</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* .. and the FP; it'll be in s8. */</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>  env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__fp <span class="op">=</span> fp<span class="op">;</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* .. and the GP; */</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__gp <span class="op">=</span> gp<span class="op">;</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* .. and the callee-saved registers; */</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;sd $16, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__regs<span class="op">[</span><span class="dv">0</span><span class="op">]));</span></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;sd $17, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__regs<span class="op">[</span><span class="dv">1</span><span class="op">]));</span></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;sd $18, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__regs<span class="op">[</span><span class="dv">2</span><span class="op">]));</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;sd $19, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__regs<span class="op">[</span><span class="dv">3</span><span class="op">]));</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;sd $20, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__regs<span class="op">[</span><span class="dv">4</span><span class="op">]));</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;sd $21, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__regs<span class="op">[</span><span class="dv">5</span><span class="op">]));</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;sd $22, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__regs<span class="op">[</span><span class="dv">6</span><span class="op">]));</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>  asm <span class="dt">volatile</span> <span class="op">(</span><span class="st">&quot;sd $23, %0&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;m&quot;</span> <span class="op">(</span>env<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__jmpbuf<span class="op">[</span><span class="dv">0</span><span class="op">].</span>__regs<span class="op">[</span><span class="dv">7</span><span class="op">]));</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* Save the signal mask if requested.  */</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> __sigjmp_save <span class="op">(</span>env<span class="op">,</span> savemask<span class="op">);</span></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The function duly stores every caller-save (including <strong>16</strong> aka <strong>s0</strong>)
and more into <strong>c.env</strong>. But what happens when that function is being compiled
with <strong>-fstack-protector-all</strong>? How does it preserve original registers?</p>
<p>Unfortunately the answer is: it does not.</p>
<p>Let’s compare assembly output with and without <strong>-fstack-protector-all</strong>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">; **-fno-stack-protector**:</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>Dump of assembler code for function __sigsetjmp_aux<span class="op">:</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>addiu   <span class="kw">sp</span><span class="op">,</span><span class="kw">sp</span><span class="op">,-</span><span class="dv">16</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>sd      gp<span class="op">,</span><span class="dv">0</span><span class="op">(</span><span class="kw">sp</span><span class="op">)</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>lui     gp<span class="op">,</span><span class="bn">0x16</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>addu    gp<span class="op">,</span>gp<span class="op">,</span>t9</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>sd      ra<span class="op">,</span><span class="dv">8</span><span class="op">(</span><span class="kw">sp</span><span class="op">)</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>addiu   gp<span class="op">,</span>gp<span class="op">,</span><span class="dv">7248</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>sdc1    <span class="op">$</span>f20<span class="op">,</span><span class="dv">104</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>sdc1    <span class="op">$</span>f22<span class="op">,</span><span class="dv">112</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>sdc1    <span class="op">$</span>f24<span class="op">,</span><span class="dv">120</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>sdc1    <span class="op">$</span>f26<span class="op">,</span><span class="dv">128</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>sdc1    <span class="op">$</span>f28<span class="op">,</span><span class="dv">136</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>sdc1    <span class="op">$</span>f30<span class="op">,</span><span class="dv">144</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>sd      ra<span class="op">,</span><span class="dv">0</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>sd      a2<span class="op">,</span><span class="dv">8</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>sd      a3<span class="op">,</span><span class="dv">80</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>sd      a4<span class="op">,</span><span class="dv">88</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>sd      s0<span class="op">,</span><span class="dv">16</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>sd      s1<span class="op">,</span><span class="dv">24</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>sd      s2<span class="op">,</span><span class="dv">32</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>sd      s3<span class="op">,</span><span class="dv">40</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>sd      s4<span class="op">,</span><span class="dv">48</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>sd      s5<span class="op">,</span><span class="dv">56</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>sd      s6<span class="op">,</span><span class="dv">64</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>sd      s7<span class="op">,</span><span class="dv">72</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>lw      t9<span class="op">,-</span><span class="dv">32236</span><span class="op">(</span>gp<span class="op">)</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>bal     <span class="bn">0x30000</span> <span class="op">&lt;</span>__sigjmp_save<span class="op">&gt;</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="bu">nop</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>ld      ra<span class="op">,</span><span class="dv">8</span><span class="op">(</span><span class="kw">sp</span><span class="op">)</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>ld      gp<span class="op">,</span><span class="dv">0</span><span class="op">(</span><span class="kw">sp</span><span class="op">)</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>jr      ra</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>addiu   <span class="kw">sp</span><span class="op">,</span><span class="kw">sp</span><span class="op">,</span><span class="dv">16</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">; **-fstack-protector-all**:</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>Dump of assembler code for function __sigsetjmp_aux<span class="op">:</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>addiu   <span class="kw">sp</span><span class="op">,</span><span class="kw">sp</span><span class="op">,-</span><span class="dv">48</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>sd      gp<span class="op">,</span><span class="dv">32</span><span class="op">(</span><span class="kw">sp</span><span class="op">)</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>lui     gp<span class="op">,</span><span class="bn">0x18</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>addu    gp<span class="op">,</span>gp<span class="op">,</span>t9</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>addiu   gp<span class="op">,</span>gp<span class="op">,-</span><span class="dv">23968</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>sd      s0<span class="op">,</span><span class="dv">24</span><span class="op">(</span><span class="kw">sp</span><span class="op">)</span>     <span class="co">; here we backup s0</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>lw      s0<span class="op">,-</span><span class="dv">27824</span><span class="op">(</span>gp<span class="op">)</span> <span class="co">; and load into s0 stack canary address</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>sd      ra<span class="op">,</span><span class="dv">40</span><span class="op">(</span><span class="kw">sp</span><span class="op">)</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>lw      v1<span class="op">,</span><span class="dv">0</span><span class="op">(</span>s0<span class="op">)</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>sw      v1<span class="op">,</span><span class="dv">12</span><span class="op">(</span><span class="kw">sp</span><span class="op">)</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>sdc1    <span class="op">$</span>f20<span class="op">,</span><span class="dv">104</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>sdc1    <span class="op">$</span>f22<span class="op">,</span><span class="dv">112</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>sdc1    <span class="op">$</span>f24<span class="op">,</span><span class="dv">120</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>sdc1    <span class="op">$</span>f26<span class="op">,</span><span class="dv">128</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>sdc1    <span class="op">$</span>f28<span class="op">,</span><span class="dv">136</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>sdc1    <span class="op">$</span>f30<span class="op">,</span><span class="dv">144</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>sd      ra<span class="op">,</span><span class="dv">0</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>sd      a2<span class="op">,</span><span class="dv">8</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>sd      a3<span class="op">,</span><span class="dv">80</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>sd      a4<span class="op">,</span><span class="dv">88</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>sd      s0<span class="op">,</span><span class="dv">16</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>sd      s1<span class="op">,</span><span class="dv">24</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>sd      s2<span class="op">,</span><span class="dv">32</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>sd      s3<span class="op">,</span><span class="dv">40</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>sd      s4<span class="op">,</span><span class="dv">48</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>sd      s5<span class="op">,</span><span class="dv">56</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>sd      s6<span class="op">,</span><span class="dv">64</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>sd      s7<span class="op">,</span><span class="dv">72</span><span class="op">(</span>a0<span class="op">)</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>lw      t9<span class="op">,-</span><span class="dv">32100</span><span class="op">(</span>gp<span class="op">)</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>bal     <span class="bn">0x31940</span> <span class="op">&lt;</span>__sigjmp_save<span class="op">&gt;</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="bu">nop</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>lw      a0<span class="op">,</span><span class="dv">12</span><span class="op">(</span><span class="kw">sp</span><span class="op">)</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>lw      v1<span class="op">,</span><span class="dv">0</span><span class="op">(</span>s0<span class="op">)</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>bne     a0<span class="op">,</span>v1<span class="op">,</span><span class="bn">0x31c7c</span> <span class="op">&lt;</span>__sigsetjmp_aux<span class="op">+</span><span class="dv">156</span><span class="op">&gt;</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>ld      ra<span class="op">,</span><span class="dv">40</span><span class="op">(</span><span class="kw">sp</span><span class="op">)</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>ld      gp<span class="op">,</span><span class="dv">32</span><span class="op">(</span><span class="kw">sp</span><span class="op">)</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>ld      s0<span class="op">,</span><span class="dv">24</span><span class="op">(</span><span class="kw">sp</span><span class="op">)</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>jr      ra</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>addiu   <span class="kw">sp</span><span class="op">,</span><span class="kw">sp</span><span class="op">,</span><span class="dv">48</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>lw      t9<span class="op">,-</span><span class="dv">32644</span><span class="op">(</span>gp<span class="op">)</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>jalr    t9</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="bu">nop</span></span></code></pre></div>
<p>Or in diff form:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode Diff"><code class="sourceCode diff"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- no-sp       2017-12-16 23:53:51.591627849 +0000</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ spa 2017-12-16 23:53:37.952647838 +0000</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -1 +1 @@</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="st">-    ; **-fno-stack-protector**:</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="va">+    ; **-fstack-protector-all**:</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -3,3 +3,3 @@</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="st">-    addiu   sp,sp,-16</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="st">-    sd      gp,0(sp)</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="st">-    lui     gp,0x16</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="va">+    addiu   sp,sp,-48</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="va">+    sd      gp,32(sp)</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="va">+    lui     gp,0x18</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -7,2 +7,6 @@</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="st">-    sd      ra,8(sp)</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="st">-    addiu   gp,gp,7248</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="va">+    addiu   gp,gp,-23968</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="va">+    sd      s0,24(sp)     ; here we backup s0</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="va">+    lw      s0,-27824(gp) ; and load into s0 stack canary address</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="va">+    sd      ra,40(sp)</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="va">+    lw      v1,0(s0)</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="va">+    sw      v1,12(sp)</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -27,2 +31,2 @@</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="st">-    lw      t9,-32236(gp)</span></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="st">-    bal     0x30000 &lt;__sigjmp_save&gt;</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="va">+    lw      t9,-32100(gp)</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="va">+    bal     0x31940 &lt;__sigjmp_save&gt;</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -30,2 +34,6 @@</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="st">-    ld      ra,8(sp)</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="st">-    ld      gp,0(sp)</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="va">+    lw      a0,12(sp)</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="va">+    lw      v1,0(s0)</span></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a><span class="va">+    bne     a0,v1,0x31c7c &lt;__sigsetjmp_aux+156&gt;</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="va">+    ld      ra,40(sp)</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="va">+    ld      gp,32(sp)</span></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a><span class="va">+    ld      s0,24(sp)</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -33 +41,4 @@</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a><span class="st">-    addiu   sp,sp,16</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a><span class="va">+    addiu   sp,sp,48</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a><span class="va">+    lw      t9,-32644(gp)</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a><span class="va">+    jalr    t9</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a><span class="va">+    nop</span></span></code></pre></div>
<h1 id="the-minimal-reproducer-and-fix">The minimal reproducer and fix</h1>
<p>To fully nail down the problem I’d like to have something nice for upstream.
Here is the minimal reproducer:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;setjmp.h&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    jmp_buf jb<span class="op">;</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">volatile</span> <span class="dt">register</span> <span class="dt">long</span> s0 asm <span class="op">(</span><span class="st">&quot;$s0&quot;</span><span class="op">);</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    s0 <span class="op">=</span> <span class="dv">1234</span><span class="op">;</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>setjmp<span class="op">(</span>jb<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>        longjmp<span class="op">(</span>jb<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    printf <span class="op">(</span><span class="st">&quot;$s0 = </span><span class="sc">%lu\n</span><span class="st">&quot;</span><span class="op">,</span> s0<span class="op">);</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<pre class><code>$ qemu-mipsn32 -L ~/bad-libc ./mips-longjmp-bug
$s0 = 1082346564
$ qemu-mipsn32 -L ~/fixed-libc ./mips-longjmp-bug
$s0 = 1234</code></pre>
<p>And the fix is to disable stack protection of <strong>__sigsetjmp_aux()</strong>
in all build modes of glibc. This does work:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/sysdeps/mips/mips64/setjmp_aux.c</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/sysdeps/mips/mips64/setjmp_aux.c</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -25,6 +25,7 @@</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    access them in C.  */</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a> int</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="va">+inhibit_stack_protector</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a> __sigsetjmp_aux (jmp_buf env, int savemask, long long sp, long long fp,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>                 long long gp)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a> {</span></code></pre></div>
<h1 id="parting-words">Parting words</h1>
<p>So it was not a stack corruption after all. But the register corruption triggered by a security feature.</p>
<p>What more interesting is why Matt got <strong>stack smashing detected</strong> and not <strong>SIGSEGV</strong>.
It means that write into <strong>__stack_chk_guard</strong> actually succeeded and caused canary
check failure not because on-stack canary copy changed but because global canary changed.
<strong>__stack_chk_guard</strong> sits in <strong>.data.rel.ro</strong> section. <strong>qemu</strong> maps it as read-only and crashes
my process. How it behaves on real target is an exercise to the reader with <strong>mips</strong> device :)</p>
<p>Fun facts:</p>
<ul>
<li>It took me 12 days to find out the cause of failure. Working <strong>gdb</strong> and <strong>qemu-user</strong>
made the fix happen.</li>
<li><strong>setjmp()</strong>/<strong>longjmp()</strong> are not so opaque for me and hopefully for you.
But make sure you have read <a href="https://linux.die.net/man/3/longjmp">all the volatility gotchas</a> (Notes section)</li>
<li><strong>glibc</strong> uses <strong>setjmp()</strong>/<strong>longjmp()</strong> for error handling</li>
<li><strong>mips</strong> ABI is very pleasant to work with and not as complicated as I thought :)</li>
<li><strong>qemu-mipsn32</strong> needs a fix to generate readable <strong>.core</strong> files</li>
</ul>
<p>Have fun!</p>

<div class="info">
    Posted on December 16, 2017 by trofi. <a href="mailto:slyich@gmail.com">Email</a>,
    <a href="https://github.com/trofi/trofi.github.io.gen">pull requests or comments</a>
    are welcome!
</div>

        </div>
        <div id="footer">
            powered by <a href="http://jaspervdj.be/hakyll">hakyll</a>
        </div>
    </body>
</html>
