<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>memcheck: the debugger</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/code.css" />
        <link rel="stylesheet" type="text/css" href="../css/skylighting.css" />

        <link rel="alternate" type="application/atom+xml" href="../feed/atom.xml" title="Atom 1.0" />
        <link rel="alternate" type="application/rss+xml" href="../feed/rss.xml" title="RSS 2.0" />
        <link rel="shortcut icon" href="../images/favicon.ico" />
    </head>
    <body>
        <div id="navigation">
            <a href="../">home</a>
            <a href="../blog.html">blog</a>
            <a href="../feed/atom.xml">atom</a>
            <a href="../feed/rss.xml">rss</a>
            <a href="../about.html">about</a>
        </div>

        <div id="content">
            <h1>memcheck: the debugger</h1>
            
                <div class="info">October 21, 2010</div>
            

            <p><a href="http://valgrind.org">valgrind</a> - это подпроект KDE, который направлен
на отлов багов в <strong>С</strong> и <strong>C++</strong> программах.</p>
<p>Лирики и истории тут не будет, но можно почитать
<a href="http://dot.kde.org/2006/02/20/interview-valgrind-author-julian-seward">ссылку</a>.</p>
<p>Краткая теория как работает <strong>valgrind</strong>:</p>
<p><strong>valgrind</strong> - это набор утилит, построенных поверх либы-эмулятора процессора <strong>libvex</strong>
(причем <strong>libvex</strong> может эмулировать не только тот процессор, на котором она рабоотает,
но и другие). То есть <strong>libvex</strong> читает инструкции процессора и эмулирует их, отслеживая
что какая инструкция куда переместила (с точность до бита!).</p>
<p>В состав <strong>valgrind</strong> входит утилита <strong>memcheck</strong> (самая популярная утилита, работает по умолчанию).
В послании расскажу пока только про нее.</p>
<p>Она отслеживает:</p>
<ol type="1">
<li><strong>обращение за пределы выделенной памяти вроде такого:</strong></li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> p <span class="op">=</span> malloc <span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    p<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="ch">'!'</span><span class="op">;</span> <span class="co">// пишем сразу за границу буфера</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    free <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ol start="2" type="1">
<li><strong>использование неинициализированных данных</strong></li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> trash<span class="op">;</span> <span class="co">// не инициализируем</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    printf <span class="op">(</span><span class="st">&quot;</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> trash<span class="op">);</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ol start="3" type="1">
<li><strong>утечки памяти</strong></li>
</ol>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> p <span class="op">=</span> malloc <span class="op">(</span><span class="dv">1</span><span class="op">);</span> <span class="co">// и не освобождаем</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Чтобы получить вменяемую иформацию о том, где произошла ошибка - нужно:</p>
<ul>
<li>собрать программу с отладкой. Для этого у <strong>gcc</strong> есть семейство ключей, начинающихся на <strong>-g</strong>.</li>
<li>(не обязательно) выставить уровень оптимизаций поменьше. Снижение уровня оптимизаций улучшает
точность отладочной информации: функции и шаблоны не инлайнятся, порядок инструкций не меняется и т.д.
Так что изменяя оптимизации вы трейсите немного разные программы (в которых могут встречаться совсем
разные баги). Но обычно это не проблема.</li>
</ul>
<p>Собираем, запускаем (я взял пример <strong>2.</strong> выше):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">gcc</span> <span class="at">-ggdb</span> <span class="at">-O0</span> main.c <span class="at">-o</span> main</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">valgrind</span> <span class="at">--track-origins</span><span class="op">=</span>yes ./main</span></code></pre></div>
<p>Получаем:</p>
<pre><code>==2396== Use of uninitialised value of size 8
==2396==    at 0x4E6D81B: _itoa_word (in /lib64/libc-2.11.2.so)
==2396==    by 0x4E6EA7C: vfprintf (in /lib64/libc-2.11.2.so)
==2396==    by 0x4E788F9: printf (in /lib64/libc-2.11.2.so)
==2396==    by 0x400552: main (main.c:4)
==2396==  Uninitialised value was created by a stack allocation
==2396==    at 0x400534: main (main.c:2)</code></pre>
<p>Из этого всего мы видим, что в строке <strong>main.c:4</strong> произошло использование
неинициализированной переменной размера 8. Создано значение на стеке в строке <strong>main.c:2</strong>.
Созданное значение отслеживается <strong>только</strong> со включенным ключом <strong>–track-origins=yes</strong>.
Ключ появился в <strong>valgrind</strong> в версии <strong>3.5.0</strong>.</p>
<p>Всё просто. Мы видим стек вызовов. В самом верху - самые близкие к ошибке строки, ниже - те,
кто эти строки вызвал (размотан стек).</p>
<p>По умолчанию <strong>valgrind</strong> трейсит только один процесс и пишет вывод на <strong>stdout</strong>.
Это классно для консольных интерактивных программ, но неудобно при отладке демонов.
На этот случай у <strong>valgrind</strong> есть вагон ключей:</p>
<ul>
<li><p><strong>-<span>-trace-children=yes</strong> - трейсит все содраваемые процессом подпроцессы. Для этого в логе
и пишется PID процесса вначале: <strong>==PID==</strong>.</p></li>
<li><p><strong>-<span>-log-file=<log_file_name></strong> - выводит лог в отдельный файл.</p></li>
</ul>
<p>Есть и другие интересные полезные ключи (<strong>valgrind –help</strong>):</p>
<ul>
<li><p><strong>-<span>-num-callers=NUM</strong> - глубина размотки стека при отображении ошибки (<strong>valgrind</strong> отслеживает какая функция какую вызвала).
В примере выше у нас 4 уровня вложенности: **_itoa_word<strong>, </strong>vfprintf<strong>, </strong>printf<strong>, </strong>main**.
По умолчанию отслеживается 12 вызовов. Часто это бывает мало (у нас в проекте до 30).</p></li>
<li><p><strong>-<span>-verbose</strong> - показывает много всего интересного (и не очень): какие функции перехватываются <strong>valgrind</strong>
и прочая ерунда.</p></li>
<li><p><strong>-<span>-track-fds=yes</strong> - отслеживает незакрытые файлы при завершении программы (особо больной вопрос для демонов).</p></li>
<li><p><strong>-<span>-db-attach=yes</strong> - присосаться к программе отладчиком в точке возникновения ошибки
(в случае с демонами это не так просто :]).</p></li>
<li><p><strong>-<span>-leak-check=full</strong> - ищет утечки памяти</p></li>
<li><p><strong>-<span>-show-reachable=yes</strong> - показывает неосвобожденную, но неутекшую (есть ссылки из программы)
память при завершении программы.</p></li>
<li><p><strong>-<span>-malloc-fill=val</strong> / <strong>-<span>-free-fill=val</strong> - забавает памят после <strong>malloc</strong>/<strong>free</strong> значениями <strong>val</strong>.
По умолчанию 0 (не всегодя хорошо, так как гореспрограммисты любят совать проверки на 0 без повода).</p></li>
</ul>
<p>У <strong>C++</strong> программ (особенно написаных с использованием <strong>STL</strong>) есть одна засада, усложняющая ловить ошибки:
многие функции работы с памятью выделяют боьлше памяти, чем это реально надо. Эта оптимизация скрывает
ошибки обращения за границы выделенной памяти в контейнерах типа <strong>std::vector</strong>.</p>
<p>К счастью в шаблонах контейнеров <strong>gcc</strong> есть волшебная переменная среды, отключающая такие оптимизации: <strong>GLIBCXX_FORCE_NEW</strong>.</p>
<p>Итак, наша коммандная строка параноика довольно жирная. Слепим микроскрипт:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># лежит где-то в ~/bin/vg.sh</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="va">GLIBCXX_FORCE_NEW</span><span class="op">=</span>1 <span class="dt">\</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">valgrind</span> <span class="dt">\</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">--track-origins</span><span class="op">=</span>yes  <span class="dt">\</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">--trace-children</span><span class="op">=</span>yes <span class="dt">\</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">--num-callers</span><span class="op">=</span>50     <span class="dt">\</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">--track-fds</span><span class="op">=</span>yes      <span class="dt">\</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">--leak-check</span><span class="op">=</span>full    <span class="dt">\</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">--show-reachable</span><span class="op">=</span>yes <span class="dt">\</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">--malloc-fill</span><span class="op">=</span>0xa1   <span class="dt">\</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">--free-fill</span><span class="op">=</span>0xa1     <span class="dt">\</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span><span class="va">$@</span><span class="st">&quot;</span></span></code></pre></div>
<p>Юзать так:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">vg.sh</span> <span class="at">--log-file</span><span class="op">=</span>valgrind.log ./my-nice-program <span class="at">--my-nice-params</span></span></code></pre></div>
<p>Работает даже на демонах :]</p>
<p>Еще читаете? Офигеть! Для самых терпеливых: черная магия!</p>
<p><strong>valgrind</strong> позволяет не только ковыряться в уже готовых бинарниках.
В свой исходник можно вставлять специальные макросы, коотрые
работают только при сборке с поддержкой <strong>valgrind</strong>. Сидят эти макросы в
<strong>&lt;valgrind/valgrind.h&gt;</strong> и <strong>&lt;valgrind/memcheck.h&gt;</strong>.</p>
<p>С их помощью можно решать самые разные задачи.</p>
<p>Например, представим, что у нас в программе есть свой распределитель памяти и
мы хотим отслеживать утечки в нем:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">char</span> u8<span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> u8 <span class="op">*</span>   mempool      <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> u8 <span class="op">*</span>   mempool_p    <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">size_t</span> mempool_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mempool_init <span class="op">(</span><span class="dt">size_t</span> pool_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    mempool_p <span class="op">=</span> mempool <span class="op">=</span> <span class="op">(</span>u8<span class="op">*)</span>malloc <span class="op">(</span>pool_size<span class="op">);</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mempool<span class="op">)</span> mempool_size <span class="op">=</span> pool_size<span class="op">;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mempool_destroy <span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span> free <span class="op">(</span>mempool<span class="op">);</span> <span class="op">}</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span> mempool_alloc <span class="op">(</span><span class="dt">size_t</span> obj_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// не влезет</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mempool_p <span class="op">+</span> obj_size <span class="op">&gt;</span> mempool <span class="op">+</span> mempool_size<span class="op">)</span> <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> result <span class="op">=</span> mempool_p<span class="op">;</span> mempool_p <span class="op">+=</span> obj_size<span class="op">;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mempool_free <span class="op">(</span><span class="dt">void</span> <span class="op">*</span> obj<span class="op">,</span> <span class="dt">size_t</span> obj_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// освобождаем только последний. такая вот халтура :]</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mempool_p <span class="op">==</span> <span class="op">(</span>u8<span class="op">*)</span>obj <span class="op">+</span> obj_size<span class="op">)</span> mempool_p <span class="op">-=</span> obj_size<span class="op">;</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main <span class="op">()</span> <span class="op">{</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    mempool_init <span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> p1 <span class="op">=</span> mempool_alloc <span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> p2 <span class="op">=</span> mempool_alloc <span class="op">(</span><span class="dv">20</span><span class="op">);</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    mempool_free <span class="op">(</span>p2<span class="op">,</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Забыли</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">//mempool_free (p1, 10);</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    mempool_destroy <span class="op">();</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<pre><code>$ g++ -ggdb -O0 a.c -o a
$ vg.sh ./a
...
==24548== HEAP SUMMARY:
==24548==     in use at exit: 0 bytes in 0 blocks
==24548==   total heap usage: 1 allocs, 1 frees, 1,000 bytes allocated</code></pre>
<p>Врёт! <strong>p1</strong> то не освобожден!
У <strong>valgrind</strong> есть чудомакросы, помечающие память, как выделенную из аллокатора:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>VALGRIND_MALLOCLIKE_BLOCK<span class="op">(</span>addr<span class="op">,</span> sizeB<span class="op">,</span> rzB<span class="op">,</span> is_zeroed<span class="op">)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>VALGRIND_FREELIKE_BLOCK<span class="op">(</span>addr<span class="op">,</span> rzB<span class="op">)</span></span></code></pre></div>
<p>Их больше, но заюзаем только эти. Изменим исходнег:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;valgrind/valgrind.h&gt;</span><span class="pp"> </span><span class="co">// 1</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">char</span> u8<span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> u8 <span class="op">*</span>   mempool      <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> u8 <span class="op">*</span>   mempool_p    <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">size_t</span> mempool_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mempool_init <span class="op">(</span><span class="dt">size_t</span> pool_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    mempool_p <span class="op">=</span> mempool <span class="op">=</span> <span class="op">(</span>u8<span class="op">*)</span>malloc <span class="op">(</span>pool_size<span class="op">);</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mempool<span class="op">)</span> mempool_size <span class="op">=</span> pool_size<span class="op">;</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mempool_destroy <span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span> free <span class="op">(</span>mempool<span class="op">);</span> <span class="op">}</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span> mempool_alloc <span class="op">(</span><span class="dt">size_t</span> obj_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// не влезет</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mempool_p <span class="op">+</span> obj_size <span class="op">&gt;</span> mempool <span class="op">+</span> mempool_size<span class="op">)</span> <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> result <span class="op">=</span> mempool_p<span class="op">;</span> mempool_p <span class="op">+=</span> obj_size<span class="op">;</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    VALGRIND_MALLOCLIKE_BLOCK<span class="op">(</span>result<span class="op">,</span> obj_size<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span> <span class="co">// 2</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mempool_free <span class="op">(</span><span class="dt">void</span> <span class="op">*</span> obj<span class="op">,</span> <span class="dt">size_t</span> obj_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// освобождаем только последний. такая вот халтура :]</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mempool_p <span class="op">==</span> <span class="op">(</span>u8<span class="op">*)</span>obj <span class="op">+</span> obj_size<span class="op">)</span> mempool_p <span class="op">-=</span> obj_size<span class="op">;</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    VALGRIND_FREELIKE_BLOCK<span class="op">(</span>obj<span class="op">,</span> <span class="dv">0</span><span class="op">);</span> <span class="co">// 3</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main <span class="op">()</span> <span class="op">{</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    mempool_init <span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> p1 <span class="op">=</span> mempool_alloc <span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> p2 <span class="op">=</span> mempool_alloc <span class="op">(</span><span class="dv">20</span><span class="op">);</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    mempool_free <span class="op">(</span>p2<span class="op">,</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Забыли</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">//mempool_free (p1, 10);</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    mempool_destroy <span class="op">();</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<pre><code>$ g++ -ggdb -O0 a.c -W -Wall -o a
a.c: In function ‘int main()’:
a.c:35: предупреждение: неиспользуемая переменная ‘p1’
# хехе, нашу переменную засекли :]
$ vg.sh ./a
...
==8958== HEAP SUMMARY:
==8958==     in use at exit: 1,000 bytes in 1 blocks
==8958==   total heap usage: 3 allocs, 2 frees, 1,030 bytes allocated
==8958== 
==8958== 1,000 bytes in 1 blocks are still reachable in loss record 1 of 1
==8958==    at 0x4C2635E: malloc (vg_replace_malloc.c:236)
==8958==    by 0x4008E5: mempool_init(unsigned long) (a.c:11)
==8958==    by 0x400A8C: main (a.c:33)</code></pre>
<p>Оп! Мы немножко запутали <strong>valgrind</strong> тем, что у нас <strong>p1</strong> и <strong>mempool</strong> - один адрес.
Из-за этого он неправильно отределяет точку выделения памяти. Это баг в <strong>valgrind</strong>! :]
Ну не важно. Главное, что псевдоутечка детектируется.</p>
<p>Второй пример - поиск врага, модифицирующего память.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init <span class="op">(</span><span class="dt">char</span> <span class="op">*</span> p<span class="op">);</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> process <span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> p<span class="op">);</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main <span class="op">()</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> p <span class="op">=</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>malloc <span class="op">(</span><span class="dv">100</span><span class="op">);</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    init <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    printf <span class="op">(</span><span class="st">&quot;before process: p[33] = </span><span class="sc">%c\n</span><span class="st">&quot;</span><span class="op">,</span> p<span class="op">[</span><span class="dv">33</span><span class="op">]);</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    process <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    printf <span class="op">(</span><span class="st">&quot;after process:  p[33] = </span><span class="sc">%c\n</span><span class="st">&quot;</span><span class="op">,</span> p<span class="op">[</span><span class="dv">33</span><span class="op">]);</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    free <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Делаем вид, что дальше идёт много чужого неясного кода</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init <span class="op">(</span><span class="dt">char</span> <span class="op">*</span> p<span class="op">)</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    memset <span class="op">(</span>p<span class="op">,</span> <span class="ch">'+'</span><span class="op">,</span> <span class="dv">100</span><span class="op">);</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> process <span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> p<span class="op">)</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> q <span class="op">=</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>p<span class="op">;</span> <span class="co">// ужас! сейчас испоганит!</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    q<span class="op">[</span><span class="dv">33</span><span class="op">]</span> <span class="op">=</span> <span class="ch">'-'</span><span class="op">;</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Глядя на прототип функции <strong>process</strong> никак не скажешь,
что она может изменить данные <strong>p[33]</strong>, но тест <strong>printf</strong> говорит об обратном.</p>
<p>Как найти врага? Сделаем память “недоступной” и проверим:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;valgrind/memcheck.h&gt;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init <span class="op">(</span><span class="dt">char</span> <span class="op">*</span> p<span class="op">);</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> process <span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> p<span class="op">);</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main <span class="op">()</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> p <span class="op">=</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>malloc <span class="op">(</span><span class="dv">100</span><span class="op">);</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    init <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    printf <span class="op">(</span><span class="st">&quot;before process: p[33] = </span><span class="sc">%c\n</span><span class="st">&quot;</span><span class="op">,</span> p<span class="op">[</span><span class="dv">33</span><span class="op">]);</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    VALGRIND_MAKE_MEM_NOACCESS<span class="op">(</span>p<span class="op">,</span> <span class="dv">100</span><span class="op">);</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    process <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    printf <span class="op">(</span><span class="st">&quot;after process:  p[33] = </span><span class="sc">%c\n</span><span class="st">&quot;</span><span class="op">,</span> p<span class="op">[</span><span class="dv">33</span><span class="op">]);</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    free <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Делаем вид, что дальше идёт много чужого неясного кода</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init <span class="op">(</span><span class="dt">char</span> <span class="op">*</span> p<span class="op">)</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    memset <span class="op">(</span>p<span class="op">,</span> <span class="ch">'+'</span><span class="op">,</span> <span class="dv">100</span><span class="op">);</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> process <span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> p<span class="op">)</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> q <span class="op">=</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>p<span class="op">;</span> <span class="co">// ужас! сейчас испоганит!</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    q<span class="op">[</span><span class="dv">33</span><span class="op">]</span> <span class="op">=</span> <span class="ch">'-'</span><span class="op">;</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Запускаем:</p>
<pre><code>$ g++ -ggdb -O0 a.c -W -Wall -o a
$ vg.sh ./a
...
before process: p[33] = +
==22521== Invalid write of size 1
==22521==    at 0x400A79: process(char const*) (a.c:31)
==22521==    by 0x400A0A: main (a.c:16)
==22521==  Address 0x5931061 is 33 bytes inside a block of size 100 alloc'd
==22521==    at 0x4C2635E: malloc (vg_replace_malloc.c:236)
==22521==    by 0x40096F: main (a.c:12)
==22521== 
==22521== Invalid read of size 1
==22521==    at 0x400A13: main (a.c:17)
==22521==  Address 0x5931061 is 33 bytes inside a block of size 100 alloc'd
==22521==    at 0x4C2635E: malloc (vg_replace_malloc.c:236)
==22521==    by 0x40096F: main (a.c:12)
==22521== 
after process:  p[33] = -
...</code></pre>
<p><strong>read</strong> нас не очень интересует, а вот <strong>write</strong> - это и есть наш запрятанный глюк:
<strong>(a.c:31)</strong></p>
<p>Хватит для начала :]</p>
        </div>
    </body>
</html>
