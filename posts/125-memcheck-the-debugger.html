<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>memcheck: the debugger</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/code.css" />
        <link rel="stylesheet" type="text/css" href="../css/skylighting.css" />

        <link rel="alternate" type="application/atom+xml" href="../feed/atom.xml" title="Atom 1.0" />
        <link rel="alternate" type="application/rss+xml" href="../feed/rss.xml" title="RSS 2.0" />
        <link rel="shortcut icon" href="../images/favicon.ico" />
    </head>
    <body>
        <div id="navigation">
            <a href="../">home</a>
            <a href="../blog.html">blog</a>
            <a href="../log.html">log</a>
            <a href="../feed/atom.xml">atom</a>
            <a href="../feed/rss.xml">rss</a>
            <a href="../about.html">about</a>
            <a href="../contact.html">contact</a>
        </div>

        <div id="content">
            <h1>memcheck: the debugger</h1>
            
                <div class="info">October 21, 2010</div>
            

            <p><a href="http://valgrind.org"><code>valgrind</code></a> - это подпроект <code>KDE</code>, который направлен
на отлов багов в <code>С</code> и <code>C++</code> программах. Краткая теория как работает <code>valgrind</code>:</p>
<p><code>valgrind</code> - это набор утилит, построенных поверх либы-эмулятора процессора <code>libvex</code>
(причем <code>libvex</code> может эмулировать не только тот процессор, на котором она рабоотает,
но и другие). То есть <code>libvex</code> читает инструкции процессора и эмулирует их, отслеживая
что какая инструкция куда переместила (с точность до бита!).</p>
<p>В состав <code>valgrind</code> входит утилита <code>memcheck</code> (самая популярная утилита, работает по умолчанию).
В послании расскажу пока только про нее.</p>
<p>Она отслеживает:</p>
<ol type="1">
<li><strong>обращение за пределы выделенной памяти вроде такого:</strong></li>
</ol>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> p <span class="op">=</span> malloc <span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    p<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> <span class="ch">'!'</span><span class="op">;</span> <span class="co">// пишем сразу за границу буфера</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    free <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ol start="2" type="1">
<li><strong>использование неинициализированных данных</strong></li>
</ol>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> trash<span class="op">;</span> <span class="co">// не инициализируем</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    printf <span class="op">(</span><span class="st">&quot;</span><span class="sc">%d\n</span><span class="st">&quot;</span><span class="op">,</span> trash<span class="op">);</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ol start="3" type="1">
<li><strong>утечки памяти</strong></li>
</ol>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> p <span class="op">=</span> malloc <span class="op">(</span><span class="dv">1</span><span class="op">);</span> <span class="co">// и не освобождаем</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Чтобы получить детальную иформацию о том, где произошла ошибка - нужно:</p>
<ul>
<li>собрать программу с отладкой. Для этого у <code>gcc</code> есть семейство ключей, начинающихся на <code>-g</code>.</li>
<li>(не обязательно) выставить уровень оптимизаций поменьше. Снижение уровня оптимизаций улучшает
точность отладочной информации: функции и шаблоны не инлайнятся, порядок инструкций не меняется и т.д.
Так что изменяя оптимизации вы трейсите немного разные программы (в которых могут встречаться совсем
разные баги). Но обычно это не проблема.</li>
</ul>
<p>Собираем, запускаем (я взял пример <code>2.</code> выше):</p>
<pre><code>$ gcc -ggdb -O0 main.c -o main
$ valgrind --track-origins=yes ./main
==2396== Use of uninitialised value of size 8
==2396==    at 0x4E6D81B: _itoa_word (in /lib64/libc-2.11.2.so)
==2396==    by 0x4E6EA7C: vfprintf (in /lib64/libc-2.11.2.so)
==2396==    by 0x4E788F9: printf (in /lib64/libc-2.11.2.so)
==2396==    by 0x400552: main (main.c:4)
==2396==  Uninitialised value was created by a stack allocation
==2396==    at 0x400534: main (main.c:2)</code></pre>
<p>Из этого всего мы видим, что в строке <code>main.c:4</code> произошло использование
неинициализированной переменной размера 8. Создано значение на стеке в строке <code>main.c:2</code>.
Созданное значение отслеживается <strong>только</strong> со включенным ключом <code>--track-origins=yes</code>.
Ключ появился в <code>valgrind</code> в версии <code>3.5.0</code>.</p>
<p>Всё просто. Мы видим стек вызовов. В самом верху - самые близкие к ошибке строки, ниже - те,
кто эти строки вызвал (размотан стек).</p>
<p>По умолчанию <code>valgrind</code> трейсит только один процесс и пишет вывод на <code>stdout</code>.
Это классно для консольных интерактивных программ, но неудобно при отладке демонов.
На этот случай у <code>valgrind</code> есть вагон ключей:</p>
<ul>
<li><code>--trace-children=yes</code> - трейсит все содраваемые процессом подпроцессы. Для этого в логе
и пишется <code>PID</code> процесса вначале: <code>==PID==</code>.</li>
<li><code>--log-file=&lt;log_file_name&gt;</code> - выводит лог в отдельный файл.</li>
</ul>
<p>Есть и другие интересные полезные ключи (<code>valgrind --help</code>):</p>
<ul>
<li><code>--num-callers=NUM</code> - глубина размотки стека при отображении ошибки (<code>valgrind</code> отслеживает какая функция какую вызвала).
В примере выше у нас 4 уровня вложенности: <code>_itoa_word</code>, <code>vfprintf</code>, <code>printf</code>, <code>main</code>.
По умолчанию отслеживается 12 вызовов. Часто это бывает мало (у нас в проекте до 30).</li>
<li><code>--verbose</code> - показывает много всего интересного (и не очень): какие функции перехватываются <code>valgrind</code>
и прочая ерунда.</li>
<li><code>--track-fds=yes</code> - отслеживает незакрытые файлы при завершении программы (особо больной вопрос для демонов).</li>
<li><code>--db-attach=yes</code> - присосаться к программе отладчиком в точке возникновения ошибки
(в случае с демонами это не так просто).</li>
<li><code>--leak-check=full</code> - ищет утечки памяти</li>
<li><code>--show-reachable=yes</code> - показывает неосвобожденную, но неутекшую (есть ссылки из программы)
память при завершении программы.</li>
<li><code>--malloc-fill=val</code> / <code>--free-fill=val</code> - забавает памят после <code>malloc</code>/<code>free</code> значениями <code>val</code>.
По умолчанию 0 (не всегодя хорошо, так как гореспрограммисты любят совать проверки на 0 без повода).</li>
</ul>
<p>У <code>C++</code> программ (особенно написаных с использованием <code>STL</code>) есть одна засада, усложняющая ловить ошибки:
многие функции работы с памятью выделяют больше памяти, чем это реально надо. Эта оптимизация скрывает
ошибки обращения за границы выделенной памяти в контейнерах типа <code>std::vector</code>.</p>
<p>К счастью в шаблонах контейнеров <code>gcc</code> есть волшебная переменная среды, отключающая такие оптимизации: <code>GLIBCXX_FORCE_NEW</code>.</p>
<p>Итак, наша коммандная строка параноика довольно жирная. Слепим микроскрипт:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># лежит где-то в ~/bin/vg.sh</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="va">GLIBCXX_FORCE_NEW</span><span class="op">=</span>1 <span class="dt">\</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="fu">valgrind</span> <span class="dt">\</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">--track-origins</span><span class="op">=</span>yes  <span class="dt">\</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">--trace-children</span><span class="op">=</span>yes <span class="dt">\</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">--num-callers</span><span class="op">=</span>50     <span class="dt">\</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">--track-fds</span><span class="op">=</span>yes      <span class="dt">\</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">--leak-check</span><span class="op">=</span>full    <span class="dt">\</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">--show-reachable</span><span class="op">=</span>yes <span class="dt">\</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">--malloc-fill</span><span class="op">=</span>0xa1   <span class="dt">\</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">--free-fill</span><span class="op">=</span>0xa1     <span class="dt">\</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span><span class="va">$@</span><span class="st">&quot;</span></span></code></pre></div>
<p>Юзать так:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">vg.sh</span> <span class="at">--log-file</span><span class="op">=</span>valgrind.log ./my-nice-program <span class="at">--my-nice-params</span></span></code></pre></div>
<p><code>valgrind</code> позволяет не только ковыряться в уже готовых бинарниках.
В свой исходник можно вставлять специальные макросы, коотрые
работают только при сборке с поддержкой <code>valgrind</code>. Сидят эти макросы в
<code>&lt;valgrind/valgrind.h&gt;</code> и <code>&lt;valgrind/memcheck.h&gt;</code>. С их помощью можно
решать самые разные задачи. Например, представим, что у нас в программе
есть свой распределитель памяти и мы хотим отслеживать утечки в нем:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">char</span> u8<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> u8 <span class="op">*</span>   mempool      <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> u8 <span class="op">*</span>   mempool_p    <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">size_t</span> mempool_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mempool_init <span class="op">(</span><span class="dt">size_t</span> pool_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    mempool_p <span class="op">=</span> mempool <span class="op">=</span> <span class="op">(</span>u8<span class="op">*)</span>malloc <span class="op">(</span>pool_size<span class="op">);</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mempool<span class="op">)</span> mempool_size <span class="op">=</span> pool_size<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mempool_destroy <span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span> free <span class="op">(</span>mempool<span class="op">);</span> <span class="op">}</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span> mempool_alloc <span class="op">(</span><span class="dt">size_t</span> obj_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// не влезет</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mempool_p <span class="op">+</span> obj_size <span class="op">&gt;</span> mempool <span class="op">+</span> mempool_size<span class="op">)</span> <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> result <span class="op">=</span> mempool_p<span class="op">;</span> mempool_p <span class="op">+=</span> obj_size<span class="op">;</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mempool_free <span class="op">(</span><span class="dt">void</span> <span class="op">*</span> obj<span class="op">,</span> <span class="dt">size_t</span> obj_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// освобождаем только последний. такая вот халтура :]</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mempool_p <span class="op">==</span> <span class="op">(</span>u8<span class="op">*)</span>obj <span class="op">+</span> obj_size<span class="op">)</span> mempool_p <span class="op">-=</span> obj_size<span class="op">;</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main <span class="op">()</span> <span class="op">{</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    mempool_init <span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> p1 <span class="op">=</span> mempool_alloc <span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> p2 <span class="op">=</span> mempool_alloc <span class="op">(</span><span class="dv">20</span><span class="op">);</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    mempool_free <span class="op">(</span>p2<span class="op">,</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Забыли</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">//mempool_free (p1, 10);</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    mempool_destroy <span class="op">();</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<pre><code>$ g++ -ggdb -O0 a.c -o a
$ vg.sh ./a
...
==24548== HEAP SUMMARY:
==24548==     in use at exit: 0 bytes in 0 blocks
==24548==   total heap usage: 1 allocs, 1 frees, 1,000 bytes allocated</code></pre>
<p>Но <code>p1</code> то не освобожден!
У <code>valgrind</code> есть чудомакросы, помечающие память, как выделенную из аллокатора:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>VALGRIND_MALLOCLIKE_BLOCK<span class="op">(</span>addr<span class="op">,</span> sizeB<span class="op">,</span> rzB<span class="op">,</span> is_zeroed<span class="op">)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>VALGRIND_FREELIKE_BLOCK<span class="op">(</span>addr<span class="op">,</span> rzB<span class="op">)</span></span></code></pre></div>
<p>Их больше, но заюзаем только эти. Изменим исходнег:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;valgrind/valgrind.h&gt;</span><span class="pp"> </span><span class="co">// 1</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">char</span> u8<span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> u8 <span class="op">*</span>   mempool      <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> u8 <span class="op">*</span>   mempool_p    <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">size_t</span> mempool_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mempool_init <span class="op">(</span><span class="dt">size_t</span> pool_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    mempool_p <span class="op">=</span> mempool <span class="op">=</span> <span class="op">(</span>u8<span class="op">*)</span>malloc <span class="op">(</span>pool_size<span class="op">);</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mempool<span class="op">)</span> mempool_size <span class="op">=</span> pool_size<span class="op">;</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mempool_destroy <span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span> free <span class="op">(</span>mempool<span class="op">);</span> <span class="op">}</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span> mempool_alloc <span class="op">(</span><span class="dt">size_t</span> obj_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// не влезет</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mempool_p <span class="op">+</span> obj_size <span class="op">&gt;</span> mempool <span class="op">+</span> mempool_size<span class="op">)</span> <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> result <span class="op">=</span> mempool_p<span class="op">;</span> mempool_p <span class="op">+=</span> obj_size<span class="op">;</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    VALGRIND_MALLOCLIKE_BLOCK<span class="op">(</span>result<span class="op">,</span> obj_size<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span> <span class="co">// 2</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mempool_free <span class="op">(</span><span class="dt">void</span> <span class="op">*</span> obj<span class="op">,</span> <span class="dt">size_t</span> obj_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="co">// освобождаем только последний. такая вот халтура :]</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>mempool_p <span class="op">==</span> <span class="op">(</span>u8<span class="op">*)</span>obj <span class="op">+</span> obj_size<span class="op">)</span> mempool_p <span class="op">-=</span> obj_size<span class="op">;</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    VALGRIND_FREELIKE_BLOCK<span class="op">(</span>obj<span class="op">,</span> <span class="dv">0</span><span class="op">);</span> <span class="co">// 3</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main <span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    mempool_init <span class="op">(</span><span class="dv">1000</span><span class="op">);</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> p1 <span class="op">=</span> mempool_alloc <span class="op">(</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> p2 <span class="op">=</span> mempool_alloc <span class="op">(</span><span class="dv">20</span><span class="op">);</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    mempool_free <span class="op">(</span>p2<span class="op">,</span> <span class="dv">20</span><span class="op">);</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Забыли</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">//mempool_free (p1, 10);</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    mempool_destroy <span class="op">();</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<pre><code>$ g++ -ggdb -O0 a.c -W -Wall -o a
a.c: In function ‘int main()’:
a.c:35: предупреждение: неиспользуемая переменная ‘p1’
# хехе, нашу переменную засекли :]
$ vg.sh ./a
...
==8958== HEAP SUMMARY:
==8958==     in use at exit: 1,000 bytes in 1 blocks
==8958==   total heap usage: 3 allocs, 2 frees, 1,030 bytes allocated
==8958== 
==8958== 1,000 bytes in 1 blocks are still reachable in loss record 1 of 1
==8958==    at 0x4C2635E: malloc (vg_replace_malloc.c:236)
==8958==    by 0x4008E5: mempool_init(unsigned long) (a.c:11)
==8958==    by 0x400A8C: main (a.c:33)</code></pre>
<p>Оп! Мы немножко запутали <code>valgrind</code> тем, что у нас <code>p1</code> и <code>mempool</code> - один адрес.
Из-за этого он неправильно отределяет точку выделения памяти. Это баг в <code>valgrind</code>.
Главное, что псевдоутечка детектируется.</p>
<p>Второй пример - поиск врага, неожиданно модифицирующего память.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init <span class="op">(</span><span class="dt">char</span> <span class="op">*</span> p<span class="op">);</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> process <span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> p<span class="op">);</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main <span class="op">()</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> p <span class="op">=</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>malloc <span class="op">(</span><span class="dv">100</span><span class="op">);</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    init <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    printf <span class="op">(</span><span class="st">&quot;before process: p[33] = </span><span class="sc">%c\n</span><span class="st">&quot;</span><span class="op">,</span> p<span class="op">[</span><span class="dv">33</span><span class="op">]);</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    process <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    printf <span class="op">(</span><span class="st">&quot;after process:  p[33] = </span><span class="sc">%c\n</span><span class="st">&quot;</span><span class="op">,</span> p<span class="op">[</span><span class="dv">33</span><span class="op">]);</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    free <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Делаем вид, что дальше идёт много чужого неясного кода</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init <span class="op">(</span><span class="dt">char</span> <span class="op">*</span> p<span class="op">)</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    memset <span class="op">(</span>p<span class="op">,</span> <span class="ch">'+'</span><span class="op">,</span> <span class="dv">100</span><span class="op">);</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> process <span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> p<span class="op">)</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> q <span class="op">=</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>p<span class="op">;</span> <span class="co">// ужас! сейчас испоганит!</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    q<span class="op">[</span><span class="dv">33</span><span class="op">]</span> <span class="op">=</span> <span class="ch">'-'</span><span class="op">;</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Глядя на прототип функции <code>process</code> никак не скажешь,
что она может изменить данные <code>p[33]</code>, но тест <code>printf</code> говорит об обратном.</p>
<p>Как найти врага? Сделаем память “недоступной” и проверим:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;valgrind/memcheck.h&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init <span class="op">(</span><span class="dt">char</span> <span class="op">*</span> p<span class="op">);</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> process <span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> p<span class="op">);</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main <span class="op">()</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> p <span class="op">=</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>malloc <span class="op">(</span><span class="dv">100</span><span class="op">);</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    init <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    printf <span class="op">(</span><span class="st">&quot;before process: p[33] = </span><span class="sc">%c\n</span><span class="st">&quot;</span><span class="op">,</span> p<span class="op">[</span><span class="dv">33</span><span class="op">]);</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    VALGRIND_MAKE_MEM_NOACCESS<span class="op">(</span>p<span class="op">,</span> <span class="dv">100</span><span class="op">);</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    process <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    printf <span class="op">(</span><span class="st">&quot;after process:  p[33] = </span><span class="sc">%c\n</span><span class="st">&quot;</span><span class="op">,</span> p<span class="op">[</span><span class="dv">33</span><span class="op">]);</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    free <span class="op">(</span>p<span class="op">);</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Делаем вид, что дальше идёт много чужого неясного кода</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> init <span class="op">(</span><span class="dt">char</span> <span class="op">*</span> p<span class="op">)</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    memset <span class="op">(</span>p<span class="op">,</span> <span class="ch">'+'</span><span class="op">,</span> <span class="dv">100</span><span class="op">);</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> process <span class="op">(</span><span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span> p<span class="op">)</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span> q <span class="op">=</span> <span class="op">(</span><span class="dt">char</span> <span class="op">*)</span>p<span class="op">;</span> <span class="co">// ужас! сейчас испоганит!</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    q<span class="op">[</span><span class="dv">33</span><span class="op">]</span> <span class="op">=</span> <span class="ch">'-'</span><span class="op">;</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Запускаем:</p>
<pre><code>$ g++ -ggdb -O0 a.c -W -Wall -o a
$ vg.sh ./a
...
before process: p[33] = +
==22521== Invalid write of size 1
==22521==    at 0x400A79: process(char const*) (a.c:31)
==22521==    by 0x400A0A: main (a.c:16)
==22521==  Address 0x5931061 is 33 bytes inside a block of size 100 alloc'd
==22521==    at 0x4C2635E: malloc (vg_replace_malloc.c:236)
==22521==    by 0x40096F: main (a.c:12)
==22521== 
==22521== Invalid read of size 1
==22521==    at 0x400A13: main (a.c:17)
==22521==  Address 0x5931061 is 33 bytes inside a block of size 100 alloc'd
==22521==    at 0x4C2635E: malloc (vg_replace_malloc.c:236)
==22521==    by 0x40096F: main (a.c:12)
==22521== 
after process:  p[33] = -
...</code></pre>
<p><code>read</code> нас не очень интересует, а вот <code>write</code> - это и есть наш запрятанный глюк:
<code>(a.c:31)</code></p>
<p>Хватит для начала.</p>
        </div>
    </body>
</html>
