<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>canyoucrackit riddle</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/code.css" />
        <link rel="stylesheet" type="text/css" href="../css/skylighting.css" />

        <link rel="alternate" type="application/atom+xml" href="../feed/atom.xml" title="Atom 1.0" />
        <link rel="alternate" type="application/rss+xml" href="../feed/rss.xml" title="RSS 2.0" />
        <link rel="shortcut icon" href="../images/favicon.ico" />
    </head>
    <body>
        <div id="navigation">
            <a href="../">home</a>
            <a href="../blog.html">blog</a>
            <a href="../log.html">log</a>
            <a href="../feed/atom.xml">atom</a>
            <a href="../feed/rss.xml">rss</a>
            <a href="../about.html">about</a>
        </div>

        <div id="content">
            <h1>canyoucrackit riddle</h1>
            
                <div class="info">December  4, 2011</div>
            

            <p>Вчера на ночь глядя получил от Антоши ссылку на <a href="http://www.canyoucrackit.co.uk/">загадку</a>.
Обычно я таким даже не пытаюсь заниматься, ибо сложные :].</p>
<p>Но в этот раз я проявил настойчивость и хакнул его. Попробуйте
разломать это чудо сами. Даже я осилил!.</p>
<p>Дальше идёт один большой спойлер :].</p>
<!--more-->
<p><strong>Первая стадия.</strong></p>
<p>Всё начинается с <strong>PNG</strong> файла на <a href="http://www.canyoucrackit.co.uk/">главной странице</a>.
<strong>eb</strong>, <strong>e8</strong> и <strong>90</strong> подсказали, что это шестнадцатиричный дамп 32-битного или 16-битного
варианта <strong>IA-32</strong> инструкций.</p>
<p>Самый простой вариант это дело проверить - вбить первых пару байт в любимый редактор с дизассемблером.
Я кроме <strong>hteditor</strong> ничего не знаю, так что юзаем его :].</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>00000000 eb04                           jmp         <span class="bn">0x6</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>00000002 af                             scasd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>00000003 c2bfa3                         ret         a3bf</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>00000006 81ec00010000                   <span class="bu">sub</span>         <span class="kw">esp</span><span class="op">,</span> <span class="bn">0x100</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>0000000c 31c9                           <span class="bu">xor</span>         <span class="kw">ecx</span><span class="op">,</span> <span class="kw">ecx</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>0000000e 880c0c                         <span class="bu">mov</span>         <span class="op">[</span><span class="kw">esp</span><span class="op">+</span><span class="kw">ecx</span><span class="op">],</span> <span class="kw">cl</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>00000011 fec1                           inc         <span class="kw">cl</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>00000013 75f9                           <span class="cf">jnz</span>         <span class="bn">0xe</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>00000015 31c0                           <span class="bu">xor</span>         <span class="kw">eax</span><span class="op">,</span> <span class="kw">eax</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>00000017 baefbeadde                     mov         <span class="kw">edx</span><span class="op">,</span> deadbeef</span></code></pre></div>
<p>Первый прыжок пропускает что-то странное, а дальше идёт (немножко понятный!) код.</p>
<p>Я понял, что забивать все 160 символов вручную мне будет лень и я загуглил первых 10 байт.
Я тут-же получил текстовую форму представления на картинке и написал прожку на “C”,
чтобы ее можно было изучать и патчить в <strong>hteditor</strong>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// gcc -m32 -O2 -fomit-frame-pointer -nostdlib stage1.c -o stage1</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">char</span> pseudostack<span class="op">[</span><span class="dv">1024</span> <span class="op">+</span> <span class="dv">256</span><span class="op">];</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> _start<span class="op">()</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> stack_bottom <span class="op">=</span> <span class="op">(</span><span class="dt">void</span><span class="op">*)&amp;</span>pseudostack<span class="op">[</span><span class="kw">sizeof</span> <span class="op">(</span>pseudostack<span class="op">)];</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;movl %0, </span><span class="sc">%%</span><span class="st">esp&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;r&quot;</span><span class="op">(</span>stack_bottom<span class="op">)</span> <span class="op">:</span> <span class="st">&quot;esp&quot;</span><span class="op">,</span> <span class="st">&quot;memory&quot;</span><span class="op">);</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0xeb, 0x04, 0xaf, 0xc2, 0xbf, 0xa3, 0x81, 0xec, 0x00, 0x01, 0x00, 0x00, 0x31, 0xc9, 0x88, 0x0c</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0x0c, 0xfe, 0xc1, 0x75, 0xf9, 0x31, 0xc0, 0xba, 0xef, 0xbe, 0xad, 0xde, 0x02, 0x04, 0x0c, 0x00</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0xd0, 0xc1, 0xca, 0x08, 0x8a, 0x1c, 0x0c, 0x8a, 0x3c, 0x04, 0x88, 0x1c, 0x04, 0x88, 0x3c, 0x0c</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0xfe, 0xc1, 0x75, 0xe8, 0xe9, 0x5c, 0x00, 0x00, 0x00, 0x89, 0xe3, 0x81, 0xc3, 0x04, 0x00, 0x00</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0x00, 0x5c, 0x58, 0x3d, 0x41, 0x41, 0x41, 0x41, 0x75, 0x43, 0x58, 0x3d, 0x42, 0x42, 0x42, 0x42</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0x75, 0x3b, 0x5a, 0x89, 0xd1, 0x89, 0xe6, 0x89, 0xdf, 0x29, 0xcf, 0xf3, 0xa4, 0x89, 0xde, 0x89</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0xd1, 0x89, 0xdf, 0x29, 0xcf, 0x31, 0xc0, 0x31, 0xdb, 0x31, 0xd2, 0xfe, 0xc0, 0x02, 0x1c, 0x06</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0x8a, 0x14, 0x06, 0x8a, 0x34, 0x1e, 0x88, 0x34, 0x06, 0x88, 0x14, 0x1e, 0x00, 0xf2, 0x30, 0xf6</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0x8a, 0x1c, 0x16, 0x8a, 0x17, 0x30, 0xda, 0x88, 0x17, 0x47, 0x49, 0x75, 0xde, 0x31, 0xdb, 0x89</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0xd8, 0xfe, 0xc0, 0xcd, 0x80, 0x90, 0x90, 0xe8, 0x9d, 0xff, 0xff, 0xff, 0x41, 0x41, 0x41, 0x41</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Немного черной магии для установки <strong>esp</strong> в статическую область памяти (чтобы было прощее ее исследовать).
Дальше до запуска опасного бинаря я решил изучить всю программу целиком (а вдруг там троян? :]).
Дальше я буду приводить код с адресами в <strong>ELF</strong> файле (я не осилил заставить <strong>hteditor</strong> переименовывать
метки в обычных бинарных данных).</p>
<p>Прога состоит из нескольких частей:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>80480c7 ! eb04                             jmp         skip_something</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>80480c9   af                               scasd</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>80480ca   c2bfa3                           ret         <span class="bn">0a3bfh</span></span></code></pre></div>
<p>Пропуск какого-то подозрительного мусора.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>....... ! skip_something<span class="op">:</span>                 <span class="co">;xref j80480c7</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>....... ! 81ec00010000                     <span class="bu">sub</span>         <span class="kw">esp</span><span class="op">,</span> <span class="bn">100h</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>80480d3 ! 31c9                             <span class="bu">xor</span>         <span class="kw">ecx</span><span class="op">,</span> <span class="kw">ecx</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>80480d5 !</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>....... ! init_table<span class="op">:</span>                     <span class="co">;xref j80480da</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>....... ! 880c0c                           <span class="bu">mov</span>         <span class="op">[</span><span class="kw">esp</span><span class="op">+</span><span class="kw">ecx</span><span class="op">],</span> <span class="kw">cl</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>80480d8 ! fec1                             inc         <span class="kw">cl</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>80480da ! 75f9                             <span class="cf">jnz</span>         init_table</span></code></pre></div>
<p>Выделение на стеке 256 байт и инициализация их значениями <strong>0x00-0xFF</strong>.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>80480dc ! 31c0                             <span class="bu">xor</span>         <span class="kw">eax</span><span class="op">,</span> <span class="kw">eax</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>80480de ! baefbeadde                       mov         <span class="kw">edx</span><span class="op">,</span> <span class="bn">0deadbeefh</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>80480e3 !</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>....... ! permutate_table<span class="op">:</span>                <span class="co">;xref j80480f9</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>....... ! 02040c                           <span class="bu">add</span>         <span class="kw">al</span><span class="op">,</span> <span class="op">[</span><span class="kw">esp</span><span class="op">+</span><span class="kw">ecx</span><span class="op">]</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>80480e6 ! 00d0                             <span class="bu">add</span>         <span class="kw">al</span><span class="op">,</span> <span class="kw">dl</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>80480e8 ! c1ca08                           ror         <span class="kw">edx</span><span class="op">,</span> <span class="dv">8</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>80480eb ! 8a1c0c                           <span class="bu">mov</span>         <span class="kw">bl</span><span class="op">,</span> <span class="op">[</span><span class="kw">esp</span><span class="op">+</span><span class="kw">ecx</span><span class="op">]</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>80480ee ! 8a3c04                           <span class="bu">mov</span>         <span class="kw">bh</span><span class="op">,</span> <span class="op">[</span><span class="kw">esp</span><span class="op">+</span><span class="kw">eax</span><span class="op">]</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>80480f1 ! 881c04                           <span class="bu">mov</span>         <span class="op">[</span><span class="kw">esp</span><span class="op">+</span><span class="kw">eax</span><span class="op">],</span> <span class="kw">bl</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>80480f4 ! 883c0c                           <span class="bu">mov</span>         <span class="op">[</span><span class="kw">esp</span><span class="op">+</span><span class="kw">ecx</span><span class="op">],</span> <span class="kw">bh</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>80480f7 ! fec1                             inc         <span class="kw">cl</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>80480f9 ! 75e8                             <span class="cf">jnz</span>         permutate_table</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>80480fb ! e95c000000                       jmp         trampoline</span></code></pre></div>
<p>Перестановка некоторых байт местами. Первый байт - <strong>cl</strong>, второй выбирается
по ключу <strong>0xdeadbeef</strong> и <strong>add/ror</strong>. Главное, что код пока пасётся в
своих 256 байтах, никуда не вылзит.</p>
<p>Последняя инструкция уводит нас в конец кода (я назвал его <strong>trampoline</strong>).
Рассмотрим сначала его:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>....... ! trampoline<span class="op">:</span>                     <span class="co">;xref j80480fb</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>....... ! 90                               <span class="bu">nop</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>804815d ! 90                               <span class="bu">nop</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>804815e ! e89dffffff                       call        body</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>8048163 ! 41414141                         <span class="dt">dd</span>          <span class="bn">41414141h</span></span></code></pre></div>
<p>Из необычного: впервые используется <strong>call</strong> (и только однажды!).
Вернуться ему пока некуда (дальше только конец программы).</p>
<p>Первая часть <strong>body</strong> - очень интересная.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>....... ! body<span class="op">:</span>                           <span class="co">;xref c804815e</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>....... ! 89e3                             <span class="bu">mov</span>         <span class="kw">ebx</span><span class="op">,</span> <span class="kw">esp</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>8048102 ! 81c304000000                     <span class="bu">add</span>         <span class="kw">ebx</span><span class="op">,</span> <span class="dv">4</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>8048108 ! 5c                               <span class="bu">pop</span>         <span class="kw">esp</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>8048109 ! 58                               <span class="bu">pop</span>         <span class="kw">eax</span> <span class="co">; 1</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>804810a ! 3d41414141                       <span class="bu">cmp</span>         <span class="kw">eax</span><span class="op">,</span> <span class="bn">41414141h</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>804810f ! 7543                             <span class="cf">jnz</span>         bad_signature</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>8048111 ! 58                               <span class="bu">pop</span>         <span class="kw">eax</span> <span class="co">; 2</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>8048112 ! 3d42424242                       <span class="bu">cmp</span>         <span class="kw">eax</span><span class="op">,</span> <span class="bn">42424242h</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>8048117 ! 753b                             <span class="cf">jnz</span>         bad_signature</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>8048119 ! 5a                               <span class="bu">pop</span>         <span class="kw">edx</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>804811a ! 89d1                             <span class="bu">mov</span>         <span class="kw">ecx</span><span class="op">,</span> <span class="kw">edx</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>804811c ! 89e6                             <span class="bu">mov</span>         <span class="kw">esi</span><span class="op">,</span> <span class="kw">esp</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>804811e ! 89df                             <span class="bu">mov</span>         <span class="kw">edi</span><span class="op">,</span> <span class="kw">ebx</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>8048120 ! 29cf                             <span class="bu">sub</span>         <span class="kw">edi</span><span class="op">,</span> <span class="kw">ecx</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>8048122 ! f3a4                             repz movsb</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>8048124 ! 89de                             <span class="bu">mov</span>         <span class="kw">esi</span><span class="op">,</span> <span class="kw">ebx</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>8048126 ! 89d1                             <span class="bu">mov</span>         <span class="kw">ecx</span><span class="op">,</span> <span class="kw">edx</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>8048128 ! 89df                             <span class="bu">mov</span>         <span class="kw">edi</span><span class="op">,</span> <span class="kw">ebx</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>804812a ! 29cf                             <span class="bu">sub</span>         <span class="kw">edi</span><span class="op">,</span> <span class="kw">ecx</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>804812c ! 31c0                             <span class="bu">xor</span>         <span class="kw">eax</span><span class="op">,</span> <span class="kw">eax</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>804812e ! 31db                             <span class="bu">xor</span>         <span class="kw">ebx</span><span class="op">,</span> <span class="kw">ebx</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>8048130 ! 31d2                             <span class="bu">xor</span>         <span class="kw">edx</span><span class="op">,</span> <span class="kw">edx</span></span></code></pre></div>
<p>Здесь со стека восстанавливается адрес возврата (который указывает на <strong>0x41414141</strong>)
и сохраняется в <strong>esp</strong>. По этому адресу последовательно считываются:</p>
<ul>
<li>сигнатура <strong>0x41414141</strong> (<strong>pop eax ; 1</strong>, есть в нашем образе)</li>
<li>сигнатура <strong>0x42424242</strong> (<strong>pop eax ; 2</strong>, дальше ничего нет в образе - где-то надо найти)</li>
<li>размер блока (<strong>pop edx</strong>)</li>
<li>сам блок (копируется <strong>edx</strong> байт через <strong>rep movsb</strong> в область перед нашей таблицей)</li>
</ul>
<p>Уже весело! Код привязался к данным в сегменте кода, которых нет на картинке. Посмотрим,
что делает остальной код.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>....... ! decrypt_input<span class="op">:</span>                  <span class="co">;xref j8048152</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>....... ! fec0                             inc         <span class="kw">al</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>8048134 ! 021c06                           <span class="bu">add</span>         <span class="kw">bl</span><span class="op">,</span> <span class="op">[</span><span class="kw">esi</span><span class="op">+</span><span class="kw">eax</span><span class="op">]</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>8048137 ! 8a1406                           <span class="bu">mov</span>         <span class="kw">dl</span><span class="op">,</span> <span class="op">[</span><span class="kw">esi</span><span class="op">+</span><span class="kw">eax</span><span class="op">]</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>804813a ! 8a341e                           <span class="bu">mov</span>         <span class="kw">dh</span><span class="op">,</span> <span class="op">[</span><span class="kw">esi</span><span class="op">+</span><span class="kw">ebx</span><span class="op">]</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>804813d ! 883406                           <span class="bu">mov</span>         <span class="op">[</span><span class="kw">esi</span><span class="op">+</span><span class="kw">eax</span><span class="op">],</span> <span class="kw">dh</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>8048140 ! 88141e                           <span class="bu">mov</span>         <span class="op">[</span><span class="kw">esi</span><span class="op">+</span><span class="kw">ebx</span><span class="op">],</span> <span class="kw">dl</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>8048143 ! 00f2                             <span class="bu">add</span>         <span class="kw">dl</span><span class="op">,</span> <span class="kw">dh</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>8048145 ! 30f6                             <span class="bu">xor</span>         <span class="kw">dh</span><span class="op">,</span> <span class="kw">dh</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>8048147 ! 8a1c16                           <span class="bu">mov</span>         <span class="kw">bl</span><span class="op">,</span> <span class="op">[</span><span class="kw">esi</span><span class="op">+</span><span class="kw">edx</span><span class="op">]</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>804814a ! 8a17                             <span class="bu">mov</span>         <span class="kw">dl</span><span class="op">,</span> <span class="op">[</span><span class="kw">edi</span><span class="op">]</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>804814c ! 30da                             <span class="bu">xor</span>         <span class="kw">dl</span><span class="op">,</span> <span class="kw">bl</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>804814e ! 8817                             <span class="bu">mov</span>         <span class="op">[</span><span class="kw">edi</span><span class="op">],</span> <span class="kw">dl</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>8048150 ! 47                               <span class="bu">inc</span>         <span class="kw">edi</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>8048151 ! 49                               <span class="bu">dec</span>         <span class="kw">ecx</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>8048152 ! 75de                             <span class="cf">jnz</span>         decrypt_input</span></code></pre></div>
<p>Опять видим <strong>xor</strong> и перестановку байт свежевычитанного блока с нашей таблицей.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>....... ! bad_signature<span class="op">:</span>                  <span class="co">;xref j804810f j8048117</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>....... ! 31db                             <span class="bu">xor</span>         <span class="kw">ebx</span><span class="op">,</span> <span class="kw">ebx</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>8048156 ! 89d8                             <span class="bu">mov</span>         <span class="kw">eax</span><span class="op">,</span> <span class="kw">ebx</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>8048158 ! fec0                             inc         <span class="kw">al</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>804815a ! cd80                             int         <span class="bn">80h</span></span></code></pre></div>
<p><strong>eax = 1; int 0x80</strong> - это системный вызов <strong>exit</strong> в <strong>linux</strong>.</p>
<p>Выводы:</p>
<ul>
<li>Код не проверяет своей целостности и никак не привязан к байтам, которые он в себе содержит.
Его можно <strong>несчадно патчить</strong> на предмет вывода результата дешифровки :]</li>
<li>Код не пытается выводить результатов своей работы - они остаются в памяти по адресу
<strong>esp - 256 - edx</strong> от начального адреса.</li>
</ul>
<p>Тут я пошел спать, так как не знал где взять данные на расшифровку. Утром меня осенило:
неспроста код выложен на <a href="http://www.canyoucrackit.co.uk/images/cyber.png">картинке</a>
(а не в текстовом или бинарном виде).
Заглянув в нее текстовым редактором в глаза бросается <strong>base64</strong> строка в секции коментариев:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">QkJCQjIAAACR2PFtcCA6q2eaC8SR+8dmD/zNzLQC+td3tFQ4qx8O447TDeuZw5P+0SsbEcYR78jKLw==</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> printf <span class="st">&quot;QkJCQjIAAACR2PFtcCA6q2eaC8SR+8dmD/zNzLQC+td3tFQ4qx8O447TDeuZw5P+0SsbEcYR78jKLw==&quot;</span> <span class="kw">|</span> <span class="fu">base64</span> <span class="at">-d</span> <span class="op">&gt;</span> stage1.data</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> hexdump <span class="at">-C</span> stage1.sata</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ex">00000000</span>  42 42 42 42 32 00 00 00  91 d8 f1 6d 70 20 3a ab  <span class="kw">|</span><span class="ex">BBBB2......mp</span> :.<span class="kw">|</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">00000010</span>  67 9a 0b c4 91 fb c7 66  0f fc cd cc b4 02 fa d7  <span class="kw">|</span><span class="ex">g......f........</span><span class="kw">|</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">00000020</span>  77 b4 54 38 ab 1f 0e e3  8e d3 0d eb 99 c3 93 fe  <span class="kw">|</span><span class="ex">w.T8............</span><span class="kw">|</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="ex">00000030</span>  d1 2b 1b 11 c6 11 ef c8  ca 2f                    <span class="kw">|</span><span class="bu">.</span>+......./<span class="kw">|</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="ex">0000003a</span></span></code></pre></div>
<p>Видим магическую сигнатуру <strong>0x42424242</strong> и судя по всему размер блока - <strong>0x32</strong> байта.</p>
<p>Дописываем этот блок в конец функции <strong>trampoline</strong> сразу после <strong>0x41414141</strong>
и заменяем <strong>int 80</strong> на <strong>int 3</strong>, чтобы в <strong>core dump увидеть</strong> чего там нарасшифровалось :]</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// gcc -m32 -O2 -fomit-frame-pointer -nostdlib stage1.c -o stage1</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">char</span> pseudostack<span class="op">[</span><span class="dv">1024</span> <span class="op">+</span> <span class="dv">256</span><span class="op">];</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> _start<span class="op">()</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="op">*</span> stack_bottom <span class="op">=</span> <span class="op">(</span><span class="dt">void</span><span class="op">*)&amp;</span>pseudostack<span class="op">[</span><span class="kw">sizeof</span> <span class="op">(</span>pseudostack<span class="op">)];</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;movl %0, </span><span class="sc">%%</span><span class="st">esp&quot;</span> <span class="op">:</span> <span class="op">:</span> <span class="st">&quot;r&quot;</span><span class="op">(</span>stack_bottom<span class="op">)</span> <span class="op">:</span> <span class="st">&quot;esp&quot;</span><span class="op">,</span> <span class="st">&quot;memory&quot;</span><span class="op">);</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0xeb, 0x04, 0xaf, 0xc2, 0xbf, 0xa3, 0x81, 0xec, 0x00, 0x01, 0x00, 0x00, 0x31, 0xc9, 0x88, 0x0c</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0x0c, 0xfe, 0xc1, 0x75, 0xf9, 0x31, 0xc0, 0xba, 0xef, 0xbe, 0xad, 0xde, 0x02, 0x04, 0x0c, 0x00</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0xd0, 0xc1, 0xca, 0x08, 0x8a, 0x1c, 0x0c, 0x8a, 0x3c, 0x04, 0x88, 0x1c, 0x04, 0x88, 0x3c, 0x0c</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0xfe, 0xc1, 0x75, 0xe8, 0xe9, 0x5c, 0x00, 0x00, 0x00, 0x89, 0xe3, 0x81, 0xc3, 0x04, 0x00, 0x00</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0x00, 0x5c, 0x58, 0x3d, 0x41, 0x41, 0x41, 0x41, 0x75, 0x43, 0x58, 0x3d, 0x42, 0x42, 0x42, 0x42</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0x75, 0x3b, 0x5a, 0x89, 0xd1, 0x89, 0xe6, 0x89, 0xdf, 0x29, 0xcf, 0xf3, 0xa4, 0x89, 0xde, 0x89</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0xd1, 0x89, 0xdf, 0x29, 0xcf, 0x31, 0xc0, 0x31, 0xdb, 0x31, 0xd2, 0xfe, 0xc0, 0x02, 0x1c, 0x06</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0x8a, 0x14, 0x06, 0x8a, 0x34, 0x1e, 0x88, 0x34, 0x06, 0x88, 0x14, 0x1e, 0x00, 0xf2, 0x30, 0xf6</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0x8a, 0x1c, 0x16, 0x8a, 0x17, 0x30, 0xda, 0x88, 0x17, 0x47, 0x49, 0x75, 0xde, 0x31, 0xdb, 0x89</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">//                                          v - here it was 0x80</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte 0xd8, 0xfe, 0xc0, 0xcd, 0x03, 0x90, 0x90, 0xe8, 0x9d, 0xff, 0xff, 0xff, 0x41, 0x41, 0x41, 0x41</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// base64-decoded from cyber.png</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte  0x42, 0x42, 0x42, 0x42, 0x32, 0x00, 0x00, 0x00, 0x91, 0xd8, 0xf1, 0x6d, 0x70, 0x20, 0x3a, 0xab</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte  0x67, 0x9a, 0x0b, 0xc4, 0x91, 0xfb, 0xc7, 0x66, 0x0f, 0xfc, 0xcd, 0xcc, 0xb4, 0x02, 0xfa, 0xd7</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte  0x77, 0xb4, 0x54, 0x38, 0xab, 0x1f, 0x0e, 0xe3, 0x8e, 0xd3, 0x0d, 0xeb, 0x99, 0xc3, 0x93, 0xfe</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    asm <span class="dt">volatile</span><span class="op">(</span><span class="st">&quot;.byte  0xd1, 0x2b, 0x1b, 0x11, 0xc6, 0x11, 0xef, 0xc8, 0xca, 0x2f</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>В блоке <strong>pseudostack</strong> видим заветную строку:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;GET /15b436de1f9107f3778aad525e5d0b20.js HTTP/1.1&quot;</span></span></code></pre></div>
<p><strong>Вторая стадия.</strong></p>
<p>Идём по <a href="http://www.canyoucrackit.co.uk/15b436de1f9107f3778aad525e5d0b20.js">ссылке</a> и попадаем
на второе задание.</p>
<p>Узнаем, что это</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// stage 2 of 3</span></span></code></pre></div>
<p>Эта стадия очень простая. Она напомнила мне о <a href="http://boundvariable.org/task.shtml">ICFPC 2006</a>,
где используется чуть более сложная виртуальная машина.</p>
<p>Сначала я реализовал всё, как написано и удивлялся почему же оно падает
сразу после цикла расшифровки. Потом дошло, что спека немного глючная:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- stage2.js   2011-09-26 11:47:24.000000000 +0300</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ stage2_fixed.js     2011-12-04 00:30:54.037239149 +0300</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -118,13 +118,13 @@</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>     // </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>     // opcode | instruction | operands (mod 0) | operands (mod 1)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>     // -------+-------------+------------------+-----------------</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="st">-    // 0x00   | jmp         | r1               | r2:r1</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="st">-    // 0x01   | movr        | r1, r2           | rx,   imm</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="va">+    // 0x00   | jmp         | r1               | imm:r1</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="va">+    // 0x01   | movr        | r1, r2           | r1,   imm</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>     // 0x02   | movm        | r1, [ds:r2]      | [ds:r1], r2</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>     // 0x03   | add         | r1, r2           | r1,   imm</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>     // 0x04   | xor         | r1, r2           | r1,   imm</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>     // 0x05   | cmp         | r1, r2           | r1,   imm</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="st">-    // 0x06   | jmpe        | r1               | r2:r1</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="va">+    // 0x06   | jmpe        | r1               | imm:r1</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>     // 0x07   | hlt         | N/A              | N/A</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>     //</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>     // flags</span></code></pre></div>
<p>Второй операнд должен трактоваться как новое значение сегмента кода,
а не номер регистра, в котором он хранится.</p>
<p>Я написал эмулятор на <strong>С</strong>. С дебагом исходник весит 11KB. Интерфейсов общения со
внешним миром у виртуальной машины тоже нет - это видно из ее набора инструкций:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// opcode | instruction | operands (mod 0) | operands (mod 1)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">// -------+-------------+------------------+-----------------</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">// 0x00   | jmp         | r1               | imm:r1</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">// 0x01   | movr        | r1, r2           | r1,   imm</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">// 0x02   | movm        | r1, [ds:r2]      | [ds:r1], r2</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">// 0x03   | add         | r1, r2           | r1,   imm</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">// 0x04   | xor         | r1, r2           | r1,   imm</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">// 0x05   | cmp         | r1, r2           | r1,   imm</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">// 0x06   | jmpe        | r1               | imm:r1</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">// 0x07   | hlt         | N/A              | N/A</span></span></code></pre></div>
<p>Выводы:</p>
<ul>
<li>Переменная <strong>firmware: [0xd2ab1f05, 0xda13f110]</strong> не понадобилась - неспроста.</li>
<li>результат опять должен содержаться в памяти.</li>
</ul>
<p>Запускаем эмулятор и дампим память. Видим заветную строку:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;GET /da75370fe15c4148bd4ceec861fbdaa5.exe HTTP/1.0&quot;</span></span></code></pre></div>
<p><strong>Третья стадия.</strong></p>
<p>Идём по <a href="http://www.canyoucrackit.co.uk/15b436de1f9107f3778aad525e5d0b20.js">ссылке</a> и попадаем
на последнее задание.</p>
<p>Это исполняемый PE файл, у которого в зависимостях библиотеки <strong>cygwin</strong>: <strong>cygwin1.dll</strong> и <strong>cygcrypt-0.dll</strong>.
Я поставил <strong>cygwin</strong> с оффсайта и в опциях выбрал <strong>crypt</strong> к дополнительной установке.</p>
<p>Подробное дизассемблирование я приводить не буду. Расскажу только пару моментов:</p>
<ul>
<li>бинарник собран <strong>gcc</strong> без оптимизаций (много дохлого кода)</li>
<li>точка входа - <strong>__main</strong> в <strong>cygwin</strong>, но указатель на юзерский код передается
прозрачно в <strong>main()</strong>:</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>...... ! entrypoint<span class="op">:</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>...... !   <span class="bu">push</span>        <span class="kw">ebp</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>401001 !   <span class="bu">mov</span>         <span class="kw">ebp</span><span class="op">,</span> <span class="kw">esp</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>401003 !   <span class="bu">sub</span>         <span class="kw">esp</span><span class="op">,</span> <span class="bn">18h</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>401006 !   <span class="bu">and</span>         <span class="kw">esp</span><span class="op">,</span> <span class="bn">0fffffff0h</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>401009 !   <span class="bu">mov</span>         <span class="dt">dword</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">esp</span><span class="op">],</span> user_code <span class="co">; вот он!</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>401010 !   <span class="cf">call</span>        to_crt</span></code></pre></div>
<ul>
<li>видим, что прога принимает 1 аргумент <strong>hostname</strong></li>
<li>пытается открыть файл ‘license.txt’</li>
<li>проверяет первые 4 байта ‘license.txt’ на сигнатуру <strong>gchq</strong></li>
<li>вычитывает строку(<strong>key</strong>) из 8 байт и применяет функцию <strong>crypt()</strong> с <strong>salt=hqDTK7b8K2rvw</strong> (алгоритм хэширования <strong>DES</strong>)</li>
<li>требует, чтобы <strong>crypt(key, “hqDTK7b8K2rvw”) == “hqDTK7b8K2rvw”</strong></li>
<li>требует каких-то 3 32-битных числа намекая, что они были в предыдущих двух уровнях.</li>
</ul>
<p>Мне <strong>DES</strong> ломать было лень, точнее я не осилил <strong>johntheripper</strong>.
В теории файла с содержимым:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">hello:hqDTK7b8K2rvw</span></span></code></pre></div>
<p>должно было хватить, но, видать - пароль длинноват (позже я выгуглил, что <strong>key=”cyberwin”</strong>).
Я просто пропатчил фигов бинарь там, где он проверяет равенство на <strong>strcmp</strong>:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>401167 !   <span class="bu">cmp</span>         <span class="dt">dword</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ebp</span><span class="op">-</span><span class="bn">38h</span><span class="op">],</span> <span class="bn">71686367h</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>40116e !   <span class="cf">jnz</span>         invalid_license</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>401170 !   <span class="bu">mov</span>         <span class="kw">eax</span><span class="op">,</span> <span class="op">[</span>salt_indir<span class="op">]</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>401175 !   <span class="bu">mov</span>         <span class="op">[</span><span class="kw">esp</span><span class="op">+</span><span class="dv">4</span><span class="op">],</span> <span class="kw">eax</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>401179 !   <span class="bu">lea</span>         <span class="kw">eax</span><span class="op">,</span> <span class="op">[</span><span class="kw">ebp</span><span class="op">-</span><span class="bn">38h</span><span class="op">]</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>40117c !   <span class="bu">add</span>         <span class="kw">eax</span><span class="op">,</span> <span class="dv">4</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>40117f !   <span class="bu">mov</span>         <span class="op">[</span><span class="kw">esp</span><span class="op">],</span> <span class="kw">eax</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>401182 !   <span class="cf">call</span>        crypt_wrapper</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>401187 !   <span class="bu">mov</span>         <span class="kw">edx</span><span class="op">,</span> <span class="kw">eax</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>401189 !   <span class="bu">mov</span>         <span class="kw">eax</span><span class="op">,</span> <span class="op">[</span>salt_indir<span class="op">]</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>40118e !   <span class="bu">mov</span>         <span class="op">[</span><span class="kw">esp</span><span class="op">+</span><span class="dv">4</span><span class="op">],</span> <span class="kw">eax</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>401192 !   <span class="bu">mov</span>         <span class="op">[</span><span class="kw">esp</span><span class="op">],</span> <span class="kw">edx</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>401195 !   <span class="cf">call</span>        strcmp_wrapper</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>40119a !   <span class="bu">test</span>        <span class="kw">eax</span><span class="op">,</span> <span class="kw">eax</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>40119c !   <span class="cf">jnz</span>         hash_mismatch <span class="co">; от тут мы его и прищучим</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>40119e !   <span class="bu">mov</span>         <span class="dt">dword</span> <span class="dt">ptr</span> <span class="op">[</span><span class="kw">ebp</span><span class="op">-</span><span class="bn">0ch</span><span class="op">],</span> <span class="dv">1</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>4011a5 !</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>...... ! hash_mismatch<span class="op">:</span>                  <span class="co">;xref j40119c</span></span></code></pre></div>
<p>Меняем <strong>jnz</strong> на <strong>jz</strong> и суем в файл мусорок:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">printf</span> <span class="st">&quot;gchqhelloworld&quot;</span> <span class="op">&gt;</span> license.txt<span class="kw">;</span> <span class="ex">wine</span> da75370fe15c4148bd4ceec861fbdaa5.exe canyoucrackit.co.uk</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">keygen.exe</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="ex">loading</span> stage1 license key<span class="er">(</span><span class="ex">s</span><span class="kw">)</span><span class="ex">...loading</span> stage2 license key<span class="er">(</span><span class="ex">s</span><span class="kw">)</span><span class="ex">...request:GET</span> /hqDTK7b8K2rvw/646c/0/0/key.txt HTTP/1.0response:HTTP/1.1 404 Not FoundContent-Type: text/html<span class="kw">;</span> <span class="va">charset</span><span class="op">=</span>us-asciiServer: <span class="ex">Microsoft-HTTPAPI/2.0Date:</span> Sat, 03 Dec 2011 21:53:17 GMTConnection: closeContent-Length: <span class="dv">315</span><span class="op">&lt;</span>!DOCTYPE HTML PUBLIC <span class="st">&quot;-//W3C//DTD HTML 4.01//EN&quot;&quot;http://www.w3.org/TR/html4/strict.dtd&quot;</span><span class="op">&gt;&lt;</span>HTML<span class="op">&gt;&lt;</span>HEAD<span class="op">&gt;&lt;</span>TITLE<span class="op">&gt;</span>Not Found<span class="op">&lt;</span>/TITLE<span class="op">&gt;&lt;</span>META HTTP-EQUIV=<span class="st">&quot;Content-Type&quot;</span> Content=<span class="st">&quot;text/html; charset=us-ascii&quot;</span><span class="op">&gt;&lt;</span>/HEAD<span class="op">&gt;&lt;</span>BODY<span class="op">&gt;&lt;</span>h2<span class="op">&gt;</span>Not Found<span class="op">&lt;</span>/h2<span class="op">&gt;&lt;</span>hr<span class="op">&gt;&lt;</span>p<span class="op">&gt;</span>HTTP Error 404. The requested resource is not found.<span class="op">&lt;</span>/p<span class="op">&gt;&lt;</span>/BODY<span class="op">&gt;&lt;</span>/HTML<span class="op">&gt;</span></span></code></pre></div>
<p>Урлик, по кторому нам говорят, что мы уже почти у цели.
Но фигурируют 3 магические цифры для форматной строки (хорошо видно в бинаре):</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;GET /</span><span class="sc">%s</span><span class="st">/</span><span class="sc">%x</span><span class="st">/</span><span class="sc">%x</span><span class="st">/</span><span class="sc">%x</span><span class="st">/key.txt HTTP/1.0&quot;</span></span></code></pre></div>
<p>В дизассембледном дампе видно, что после <strong>loading stage1 license key(s)…</strong>
вычитывается одно 32-битное число, а после <strong>loading stage2 license key(s)…</strong>
еще два.</p>
<p>Во второром задании было 2 магических числа - это неиспользуемый <strong>firmware: [0xd2ab1f05, 0xda13f110]</strong>.
В первом задании странный 4-байтный мусор перепрыгивался первой же инструкцией <strong>jmp</strong>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>00000000 eb04                           jmp         <span class="bn">0x6</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>00000002 af                             scasd</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>00000003 c2bfa3                         ret         a3bf</span></code></pre></div>
<p>Логично предположить, что <strong>0xa3bfc2af</strong> - это и есть первый ключ.</p>
<p>Итого наш ключ для патченного бинаря (<strong>12345678</strong> можно заменить на любые 8 символов кроме <strong>cyberwin</strong> :]):</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>printf <span class="st">&quot;gchq12345678</span><span class="sc">\xaf\xc2\xbf\xa3\x05\x1f\xab\xd2\x10\xf1\x13\xda</span><span class="st">&quot;</span> <span class="op">&gt;</span> license<span class="op">.</span>txt<span class="op">;</span> wine da75370fe15c4148bd4ceec861fbdaa5<span class="op">.</span>exe canyoucrackit<span class="op">.</span>co<span class="op">.</span>uk</span></code></pre></div>
<p>и для непатченного бинаря:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>printf <span class="st">&quot;gchqcyberwin</span><span class="sc">\xaf\xc2\xbf\xa3\x05\x1f\xab\xd2\x10\xf1\x13\xda</span><span class="st">&quot;</span> <span class="op">&gt;</span> license<span class="op">.</span>txt<span class="op">;</span> wine da75370fe15c4148bd4ceec861fbdaa5<span class="op">.</span>exe canyoucrackit<span class="op">.</span>co<span class="op">.</span>uk</span></code></pre></div>
<p>Запуск выплёвывает нам заветную строку:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;GET /hqDTK7b8K2rvw/a3bfc2af/d2ab1f05/da13f110/key.txt HTTP/1.0&quot;</span></span></code></pre></div>
<p>Идём по ссылке в браузере (сам бинарь нам нагло врёт и выводит <strong>not found</strong>):</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>Pr0t3ct<span class="op">!</span>on#cyber_security@<span class="dv">12</span><span class="op">*</span><span class="fl">12.2011</span><span class="op">+</span></span></code></pre></div>
<p>Вводим код <a href="http://www.canyoucrackit.co.uk/">на главной</a>. Получаем следующий опус:</p>
<pre class="text"><code>So you did it. Well done! Now this is where it gets interesting.
Could you use your skills and ingenuity to combat terrorism and
cyber threats? As one of our experts, you'll help protect our
nation's security and the lives of thousands. Every day will bring
new challenges, new solutions to find – and new ways to prove that
you're one of the best.
[Find out more and apply]</code></pre>
<p>Такие пироги :]</p>
        </div>
    </body>
</html>
