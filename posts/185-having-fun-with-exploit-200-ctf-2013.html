<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>trofi's blog: having fun with exploit 200 ctf 2013</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/code.css" />
        <link rel="stylesheet" type="text/css" href="../css/highlighting-kate.css" />

        <link rel="alternate" type="application/atom+xml" href="../feed/atom.xml" title="Atom 1.0" />
        <link rel="alternate" type="application/rss+xml" href="../feed/rss.xml" title="RSS 2.0" />
        <link rel="shortcut icon" href="../images/favicon.ico" />
    </head>
    <body>
        <div id="navigation">
            <a href="../">/</a>
            <a href="../archive.html">/archive</a>
            <a href="../feed/atom.xml">/atom</a>
            <a href="../feed/rss.xml">/rss</a>
        </div>

        <div id="content">
            <h1>having fun with exploit 200 ctf 2013</h1>

            <p>This post will be more about explorint techniquies rather
that reaching direct goals. It’s about the binary <strong>expl200</strong>
(SHA1: 873060b493f8627ec598dc84352064f49d005116)
<strong>yurket</strong> gave me the other day.</p>
<p><a href="http://slyfox.uni.cx:81/expl200/expl200">File itself</a>.</p>
<!--more-->
<p>So far, we have expl200 with <strong>SUID-root</strong> vilnerable binary to
get local root.</p>
<p>Before running it let’s look at it in some disassembler.
I’m a bit hardcore, thus used <strong>objdump -D -R -r expl200</strong>.</p>
<p>It’s a typical C-written binary. I’ve annotated output a bit in comments.
We are interested in 2 parts: <strong>main</strong> function and <strong>cycle</strong> data.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>0000000000400614 &lt;main<span class="op">&gt;:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>400614:       55                      <span class="bu">push</span>   <span class="op">%</span><span class="kw">rbp</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>400615:       48 89 e5                mov    <span class="op">%</span><span class="kw">rsp</span><span class="op">,%</span><span class="kw">rbp</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>400618:       48 81 ec <span class="dv">20</span> <span class="dv">02</span> <span class="dv">00</span> <span class="dv">00</span>    sub    <span class="op">$</span><span class="bn">0</span>x220<span class="op">,%</span><span class="kw">rsp</span>           <span class="co">; alloc 544 bytes on stack (%rbp points to bottom, %rsp to top), of which:</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>40061f:       64 48 8b 04 25 28 00    <span class="bu">mov</span>    <span class="op">%</span><span class="kw">fs</span><span class="op">:</span><span class="bn">0x28</span><span class="op">,%</span><span class="kw">rax</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>400626:       00 00 </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>400628:       48 89 45 f8             mov    <span class="op">%</span><span class="kw">rax</span><span class="op">,-</span><span class="bn">0x8</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span>       <span class="co">; store '-fstack-protector' 8-byte canary, 536 stack bytes left</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>40062c:       31 c0                   <span class="op">xor</span>    <span class="op">%</span><span class="kw">eax</span><span class="op">,%</span><span class="kw">eax</span>             <span class="co">; cleanse canary (otherwise it's broad infoleak)</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>40062e:       eb <span class="dv">01</span>                   jmp    <span class="dv">400631</span> <span class="op">&lt;</span>main<span class="op">+</span><span class="bn">0x1d</span><span class="op">&gt;</span>    <span class="co">;     GOTO again:</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>400630:       90                      <span class="bu">nop</span>                          <span class="co">;   again_:</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>400631:       48 8d b5 f0 fd ff ff    lea    <span class="op">-</span><span class="bn">0x210</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">),%</span><span class="kw">rsi</span>     <span class="co">;   again: char buffer[512]; (+8 bytes unused); 16 bytes of stack left</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>400638:       b8 <span class="dv">00</span> <span class="dv">00</span> <span class="dv">00</span> <span class="dv">00</span>          mov    <span class="op">$</span><span class="bn">0</span>x0<span class="op">,%</span><span class="kw">eax</span>             <span class="co">;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>40063d:       ba <span class="dv">40</span> <span class="dv">00</span> <span class="dv">00</span> <span class="dv">00</span>          mov    <span class="op">$</span><span class="bn">0</span>x40<span class="op">,%</span><span class="kw">edx</span>            <span class="co">;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>400642:       48 89 f7                mov    <span class="op">%</span><span class="kw">rsi</span><span class="op">,%</span><span class="kw">rdi</span>             <span class="co">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>400645:       48 89 d1                mov    <span class="op">%</span><span class="kw">rdx</span><span class="op">,%</span><span class="kw">rcx</span>             <span class="co">;    __builtin_memset (buffer, 0, sizeof (buffer)); just a memset, but not from libc</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>400648:       f3 <span class="dv">48</span> ab                rep stos <span class="op">%</span><span class="kw">rax</span><span class="op">,%</span><span class="kw">es</span><span class="op">:(%</span><span class="kw">rdi</span><span class="op">)</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>40064b:       48 8b 05 e6 <span class="dv">09</span> <span class="dv">20</span> <span class="dv">00</span>    mov    <span class="bn">0x2009e6</span><span class="op">(%</span>rip<span class="op">),%</span><span class="kw">rax</span>        <span class="op">#</span> <span class="dv">601038</span> <span class="op">&lt;</span>__bss_start<span class="op">&gt;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>400652:       48 89 c2                mov    <span class="op">%</span><span class="kw">rax</span><span class="op">,%</span><span class="kw">rdx</span>             <span class="co">; arg1 = 'stdin@@GLIBC_2.2.5'</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>400655:       48 8d 85 f0 fd ff ff    lea    <span class="op">-</span><span class="bn">0x210</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">),%</span><span class="kw">rax</span>     <span class="co">; arg2 = 'buffer'</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>40065c:       be ff <span class="dv">01</span> <span class="dv">00</span> <span class="dv">00</span>          mov    <span class="op">$</span><span class="bn">0</span>x1ff<span class="op">,%</span><span class="kw">esi</span>           <span class="co">; arg3 = 511</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>400661:       48 89 c7                mov    <span class="op">%</span><span class="kw">rax</span><span class="op">,%</span><span class="kw">rdi</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>400664:       e8 a7 fe ff ff          callq  <span class="dv">400510</span> <span class="op">&lt;</span>fgets<span class="fu">@</span><span class="er">p</span>lt<span class="op">&gt;</span>    <span class="co">;   fgets (stdin, buffer, 511);</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>400669:       48 8d 85 f0 fd ff ff    lea    <span class="op">-</span><span class="bn">0x210</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">),%</span><span class="kw">rax</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>400670:       0f b6 <span class="dv">00</span>                movzbl <span class="op">(%</span><span class="kw">rax</span><span class="op">),%</span><span class="kw">eax</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>400673:       84 c0                   test   <span class="op">%</span><span class="kw">al</span><span class="op">,%</span><span class="kw">al</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>400675:       75 0a                   <span class="cf">jne</span>    <span class="dv">400681</span> <span class="op">&lt;</span>main<span class="op">+</span><span class="bn">0x6d</span><span class="op">&gt;</span>    <span class="co">;   if (buffer[0] != '\0') goto fine;</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>400677:       bf ff ff ff ff          mov    <span class="op">$</span><span class="bn">0</span>xffffffff<span class="op">,%</span><span class="kw">edi</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>40067c:       e8 <span class="fl">9</span><span class="bn">f</span> fe ff ff          callq  <span class="dv">400520</span> <span class="op">&lt;</span>exit<span class="fu">@</span><span class="er">p</span>lt<span class="op">&gt;</span>     <span class="co">;   exit (-1);</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>400681:       48 8d 85 f0 fd ff ff    lea    <span class="op">-</span><span class="bn">0x210</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">),%</span><span class="kw">rax</span>     <span class="co">;   fine: arg1 = 'buffer'</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>400688:       48 89 c7                mov    <span class="op">%</span><span class="kw">rax</span><span class="op">,%</span><span class="kw">rdi</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>40068b:       b8 <span class="dv">00</span> <span class="dv">00</span> <span class="dv">00</span> <span class="dv">00</span>          mov    <span class="op">$</span><span class="bn">0</span>x0<span class="op">,%</span><span class="kw">eax</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>400690:       e8 <span class="dv">5</span><span class="er">b</span> fe ff ff          callq  <span class="dv">4004</span><span class="er">f0</span> <span class="op">&lt;</span>printf<span class="fu">@</span><span class="er">p</span>lt<span class="op">&gt;</span>   <span class="co">;   printf (buffer); GAH!</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>400695:       8b 05 b5 <span class="dv">09</span> <span class="dv">20</span> <span class="dv">00</span>       mov    <span class="bn">0x2009b5</span><span class="op">(%</span>rip<span class="op">),%</span><span class="kw">eax</span>        <span class="op">#</span> <span class="dv">601050</span> <span class="op">&lt;</span>cycle<span class="op">&gt;</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>40069b:       25 ff ff <span class="dv">00</span> <span class="dv">00</span>          <span class="op">and</span>    <span class="op">$</span><span class="bn">0</span>xffff<span class="op">,%</span><span class="kw">eax</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>4006a0:       89 85 e8 fd ff ff       mov    <span class="op">%</span><span class="kw">eax</span><span class="op">,-</span><span class="bn">0x218</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span>     <span class="co">;   int lo16 = cycle &amp; 0xFFFF; low half; 12 bytes on stack left</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>4006a6:       8b 05 a4 <span class="dv">09</span> <span class="dv">20</span> <span class="dv">00</span>       mov    <span class="bn">0x2009a4</span><span class="op">(%</span>rip<span class="op">),%</span><span class="kw">eax</span>        <span class="op">#</span> <span class="dv">601050</span> <span class="op">&lt;</span>cycle<span class="op">&gt;</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>4006ac:       c1 e8 <span class="dv">10</span>                <span class="op">shr</span>    <span class="op">$</span><span class="bn">0</span>x10<span class="op">,%</span><span class="kw">eax</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>4006af:       89 85 ec fd ff ff       mov    <span class="op">%</span><span class="kw">eax</span><span class="op">,-</span><span class="bn">0x214</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span>     <span class="co">;   int hi16 = (uint32_t)(cycle &gt;&gt; 16); high half; 8 bytes on stack left</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>4006b5:       8b 85 e8 fd ff ff       mov    <span class="op">-</span><span class="bn">0x218</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">),%</span><span class="kw">eax</span>     <span class="co">;   uint32_t v1 = lo16;</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>4006bb:       89 c2                   mov    <span class="op">%</span><span class="kw">eax</span><span class="op">,%</span><span class="kw">edx</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>4006bd:       0f af <span class="dv">95</span> e8 fd ff ff    imul   <span class="op">-</span><span class="bn">0x218</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">),%</span><span class="kw">edx</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>4006c4:       8b 85 ec fd ff ff       mov    <span class="op">-</span><span class="bn">0x214</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">),%</span><span class="kw">eax</span>     <span class="co">;   uint32_t v2 = hi16;</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>4006ca:       0f af <span class="dv">85</span> ec fd ff ff    imul   <span class="op">-</span><span class="bn">0x214</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">),%</span><span class="kw">eax</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>4006d1:       6b c0 e3                imul   <span class="op">$</span><span class="bn">0</span>xffffffe3<span class="op">,%</span><span class="kw">eax</span><span class="op">,%</span><span class="kw">eax</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>4006d4:       01 d0                   add    <span class="op">%</span><span class="kw">edx</span><span class="op">,%</span><span class="kw">eax</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>4006d6:       83 f8 <span class="dv">01</span>                cmp    <span class="op">$</span><span class="bn">0</span>x1<span class="op">,%</span><span class="kw">eax</span>             <span class="co">;  if (v1*v1 - 29 * v2 * v2 != 1)</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>4006d9:       0f 85 51 ff ff ff       jne    <span class="dv">400630</span> <span class="op">&lt;</span>main<span class="op">+</span><span class="bn">0x1c</span><span class="op">&gt;</span>    <span class="co">;      goto again_;</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>4006df:       bf dc <span class="dv">07</span> <span class="dv">40</span> <span class="dv">00</span>          mov    <span class="op">$</span><span class="bn">0</span>x4007dc<span class="op">,%</span><span class="kw">edi</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>4006e4:       e8 f7 fd ff ff          callq  <span class="fl">4004e0</span> <span class="op">&lt;</span>system<span class="fu">@</span><span class="er">p</span>lt<span class="op">&gt;</span>   <span class="co">;  system (&quot;exec /bin/sh&quot;); aha! :]</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>4006e9:       e9 <span class="dv">42</span> ff ff ff          jmpq   <span class="dv">400630</span> <span class="op">&lt;</span>main<span class="op">+</span><span class="bn">0x1c</span><span class="op">&gt;</span>    <span class="co">;      goto again_;</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>4006ee:       90                      <span class="bu">nop</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>4006ef:       90                      <span class="bu">nop</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>0000000000601050 &lt;cycle<span class="op">&gt;:</span><span class="co">; int32_t cycle</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>0000000000601038 &lt;stdin<span class="fu">@</span><span class="er">@</span>GLIBC_2<span class="op">.</span><span class="fl">2.5</span><span class="op">&gt;:</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>601038: R_X86_64_COPY   stdin</span></code></pre></div>
<p>Once again, (a bit cleaned) program looks like that:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">//#include &lt;string.h&gt; /* memset */</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> cycle <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> lo<span class="op">,</span> hi<span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> buff<span class="op">[</span><span class="dv">512</span><span class="op">];</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">do</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        __builtin_memset <span class="op">(</span>buff<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">512</span><span class="op">);</span> <span class="co">/* force rep: stos even on unoptimized builds */</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        fgets <span class="op">(</span>buff<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>buff<span class="op">)</span> <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> stdin<span class="op">);</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>buff<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">==</span> <span class="ch">'\0'</span><span class="op">)</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>            exit <span class="op">(-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        printf <span class="op">(</span>buff<span class="op">);</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        lo <span class="op">=</span> cycle <span class="op">&amp;</span> <span class="bn">0xFFFF</span><span class="op">;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        hi <span class="op">=</span> cycle <span class="op">&gt;&gt;</span> <span class="dv">16</span><span class="op">;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">while</span> <span class="op">(</span>lo<span class="op">*</span>lo <span class="op">-</span> <span class="dv">29</span><span class="op">*</span>hi<span class="op">*</span>hi <span class="op">!=</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    system <span class="op">(</span><span class="st">&quot;exec /bin/sh&quot;</span><span class="op">);</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>First, it tries to solve equation of form “x^2 - 29*y^2 == 1”.
It’s so-called <a href="http://en.wikipedia.org/wiki/Pell%27s_equation">Pell’s equation</a>,
which is common problem to solve in <a href="http://projecteuler.net">PE</a> tasks.</p>
<p>Some of their first solutions:</p>
<pre class><code>*Euler&gt; solve_pell 29 PlusOne
(x,y):
(9801,1820)
(192119201,35675640)
(3765920568201,699313893460)
(73819574785756801,13707950903927280)
(1447011301184484245001,268703252919468649100)
(28364315451998685384752801,5267121150019473555730920)
(555997310043066929727440160201,103246108513978467719968844740)
(10898659243099882504518596635507201,2023830213823884774227355738862560)
(213635517927246586810506601521771993801,39671119748129680830426159473215056380)
...</code></pre>
<p>The only ones that fit into 16 bits are firs two solutions: (9801,1820), or (0x2649, 0x071C).
Thus one of solutions is to put 0x071C2649 value into ’cycle’global varioable.</p>
<p>The straightforward way is to exploit uncontrolled ‘printf’ argument vulnerability.
Most of arguments in format string effect memory read accesses, but not writes.
For example:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>printf <span class="op">(</span><span class="st">&quot;%s%i%d&quot;</span><span class="op">,</span> whatever<span class="op">...);</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">// can only read from memory coded in 'whatever'</span></span></code></pre></div>
<p>But:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>printf <span class="op">(</span><span class="st">&quot;123%n456%n&quot;</span><span class="op">,</span> pi1<span class="op">,</span> pi2<span class="op">);</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">// will effect in *(int*)pi1 = 3; *(int*)pi2 = 6;</span></span></code></pre></div>
<p>Or even better:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>printf <span class="op">(</span><span class="st">&quot;123%hn456%hn&quot;</span><span class="op">,</span> pi1<span class="op">,</span> pi2<span class="op">);</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">// will effect in *(short*)pi1 = 3; *(short)pi2 = 6;</span></span></code></pre></div>
<p>Thus we have mechanism of writing random 2-byte values into memory locations.</p>
<p>Now, the interesting part: how to control ‘printf’ arguments?</p>
<p>Let’s look at x86_64 C function call ABI first.</p>
<p>The following example</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> test<span class="op">()</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    printf <span class="op">(</span><span class="st">&quot;&quot;</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span><span class="dv">4</span><span class="op">,</span><span class="dv">5</span><span class="op">,</span><span class="dv">6</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span><span class="dv">8</span><span class="op">,</span><span class="dv">9</span><span class="op">,</span><span class="dv">10</span><span class="op">);</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>gets assembled into (gcc -fomit-frame-pointer -S arg_test.c -o arg_test.S)</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>section        <span class="op">.</span>rodata</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>LC0<span class="op">:</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>string <span class="st">&quot;&quot;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>text</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>test<span class="op">:</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>subq    $<span class="dv">40</span><span class="op">,</span> <span class="op">%</span>rsp     <span class="op">;</span> reserve <span class="dv">8</span> <span class="op">*</span> <span class="dv">8</span> on stack<span class="op">.</span> always<span class="op">-</span><span class="dv">16</span><span class="op">-</span>byte stack alignment goes from SSE requirement<span class="op">.</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>movl    $<span class="dv">10</span><span class="op">,</span> <span class="dv">24</span><span class="op">(%</span>rsp<span class="op">)</span> <span class="op">;</span> <span class="dv">10</span><span class="op">:</span>   <span class="op">,</span> go on stack</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>movl    $<span class="dv">9</span><span class="op">,</span> <span class="dv">16</span><span class="op">(%</span>rsp<span class="op">)</span>  <span class="op">;</span>  <span class="dv">9</span><span class="op">:</span>  <span class="op">,</span> all</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>movl    $<span class="dv">8</span><span class="op">,</span> <span class="dv">8</span><span class="op">(%</span>rsp<span class="op">)</span>   <span class="op">;</span>  <span class="dv">8</span><span class="op">:</span> <span class="op">,</span> arguments</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>movl    $<span class="dv">7</span><span class="op">,</span> <span class="op">(%</span>rsp<span class="op">)</span>    <span class="op">;</span>  <span class="dv">7</span><span class="op">:</span> starting from <span class="dv">7</span><span class="op">-</span>th</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>movl    $<span class="dv">6</span><span class="op">,</span> <span class="op">%</span>r9d</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>movl    $<span class="dv">5</span><span class="op">,</span> <span class="op">%</span>r8d</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>movl    $<span class="dv">4</span><span class="op">,</span> <span class="op">%</span>ecx</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>movl    $<span class="dv">3</span><span class="op">,</span> <span class="op">%</span>edx</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>movl    $<span class="dv">2</span><span class="op">,</span> <span class="op">%</span>esi</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>movl    $<span class="op">.</span>LC0<span class="op">,</span> <span class="op">%</span>edi</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>movl    $<span class="dv">0</span><span class="op">,</span> <span class="op">%</span>eax</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>call    printf</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>addq    $<span class="dv">40</span><span class="op">,</span> <span class="op">%</span>rsp</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>ret</span></code></pre></div>
<p>Thus in order to get access to our stack we need to throw out (or use wisely)
values situated in registers.</p>
<p>It’s time to look at the stack and register layout right before <strong>printf</strong> call (eip=0x400690) moment a bit closer:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>rsp<span class="op">+</span><span class="bn">000</span><span class="er">h</span><span class="op">(</span>or <span class="op">%</span>rbp<span class="op">-</span><span class="bn">0x220</span><span class="op">):</span> <span class="op">[</span> uninitialized value<span class="op">,</span> created<span class="op">,</span> but not used by our program<span class="op">.</span> can be handy<span class="op">!</span> <span class="op">]</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>rsp<span class="op">+</span><span class="bn">000</span><span class="er">8</span><span class="op">(</span>or <span class="op">%</span>rbp<span class="op">-</span><span class="bn">0x218</span><span class="op">):</span> <span class="op">[</span> pair of values<span class="op">:</span> <span class="dt">int</span> lo16<span class="op">;</span> <span class="dt">int</span> hi16<span class="op">;</span> <span class="op">]</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>rsp<span class="op">+</span><span class="bn">010</span><span class="er">h</span><span class="op">(</span>or <span class="op">%</span>rbp<span class="op">-</span><span class="bn">0x210</span><span class="op">):</span> <span class="op">[</span> buffer<span class="op">,</span> <span class="dv">512</span> bytes <span class="op">]</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>rsp<span class="op">+</span><span class="dv">210</span><span class="er">h</span><span class="op">(</span>or <span class="op">%</span>rbp<span class="op">-</span><span class="bn">0x010</span><span class="op">):</span> <span class="op">[</span> <span class="dv">8</span> bytes unused <span class="op">]</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>rsp<span class="op">+</span><span class="dv">218</span><span class="er">h</span><span class="op">(</span>or <span class="op">%</span>rbp<span class="op">-</span><span class="bn">0x008</span><span class="op">):</span> <span class="op">[</span> stack protector canary <span class="op">]</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>rsp<span class="op">+</span><span class="dv">220</span><span class="er">h</span><span class="op">(</span>or <span class="op">%</span>rbp<span class="op">-</span><span class="bn">0x000</span><span class="op">):</span> <span class="op">[</span> <span class="dv">8</span> bytes unused <span class="op">]</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>rsp<span class="op">+</span><span class="dv">228</span><span class="er">h</span><span class="op">(</span>or <span class="op">%</span>rbp<span class="op">+</span><span class="bn">0x008</span><span class="op">):</span> <span class="op">[</span> previous frame <span class="op">(%</span>rbp<span class="op">)</span> <span class="op">]</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>registers are in the state left from fgets<span class="op">()</span> call<span class="op">.</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>Can be handy as well<span class="op">,</span> but I don't care <span class="cf">for</span> now<span class="op">.</span></span></code></pre></div>
<p>And our printf call will look like that:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>printf <span class="op">(</span> <span class="op">%</span>rdi <span class="op">=</span> <span class="op">%</span>rbp<span class="op">-</span><span class="dv">210</span><span class="er">h</span> <span class="co">/*aka buffer*/</span><span class="op">,</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>       <span class="op">,</span> <span class="op">%</span>rsi <span class="co">/* left from fgets */</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>       <span class="op">,</span> <span class="op">%</span>rdx <span class="co">/* left from fgets */</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>       <span class="op">,</span> <span class="op">%</span>rcx <span class="co">/* left from fgets */</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>       <span class="op">,</span> <span class="op">%</span>r8  <span class="co">/* left from fgets */</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>       <span class="op">,</span> <span class="op">%</span>r9  <span class="co">/* left from fgets */</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>       <span class="op">,</span> <span class="op">%</span>rbp<span class="op">-</span><span class="bn">0x220</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>       <span class="op">,</span> <span class="op">%</span>rbp<span class="op">-</span><span class="bn">0x218</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>       <span class="op">,</span> <span class="op">%</span>rbp<span class="op">-</span><span class="bn">0x210</span> <span class="co">/* aha, 'buffer' met once again! */</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>       <span class="op">,</span> <span class="op">%</span>rbp<span class="op">-</span><span class="bn">0x208</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>       <span class="op">...</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>       <span class="op">);</span></span></code></pre></div>
<p>Our goal is to control format string the way we could inject nice bits there,</p>
<p>Suppose, we pass the followint thing as a buffer:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>printf <span class="op">(</span><span class="st">&quot;%c%c%c%c%c%c%c%c</span><span class="sc">\n</span><span class="st">&quot;</span> <span class="co">/* 8 times */</span> <span class="st">&quot;%p&quot;</span><span class="op">);</span></span></code></pre></div>
<p>It will show us value for ‘%rbp-0x210’.
Program won’t crashm thus we will be able to pass
it another format string with achieved info.</p>
<p>To be continued :]</p>

<div class="info">
    Posted on June 13, 2013 by trofi. <a href="mailto:slyich@gmail.com">Email</a>,
    <a href="https://github.com/trofi/trofi.github.io.gen">pull requests or comments</a>
    are welcome!
</div>

        </div>
        <div id="footer">
            powered by <a href="http://jaspervdj.be/hakyll">hakyll</a>
        </div>
    </body>
</html>
