<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>the sagemath saga</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/code.css" />
        <link rel="stylesheet" type="text/css" href="../css/skylighting.css" />

        <link rel="alternate" type="application/atom+xml" href="../feed/atom.xml" title="Atom 1.0" />
        <link rel="alternate" type="application/rss+xml" href="../feed/rss.xml" title="RSS 2.0" />
        <link rel="shortcut icon" href="../images/favicon.ico" />
    </head>
    <body>
        <div id="navigation">
            <a href="../">home</a>
            <a href="../blog.html">blog</a>
            <a href="../log.html">log</a>
            <a href="../feed/atom.xml">atom</a>
            <a href="../feed/rss.xml">rss</a>
            <a href="../about.html">about</a>
            <a href="../contact.html">contact</a>
        </div>

        <div id="content">
            <h1>the sagemath saga</h1>
            
                <div class="info">May 12, 2024</div>
            

            <p>It’s a story of me was
<a href="https://fosstodon.org/@sheerluck@misskey.io/112372289317724185">nerd sniped</a>
by <code>@sheerluck@misskey.io</code> with <a href="https://gcc.gnu.org/PR114872"><code>PR114872</code></a>.
I spent this week having fun with a rare kind of bug: <code>gcc</code> was suspected
to have a bug that causes <code>sagemath</code> to crash with <code>SIGSEGV</code> on certain
inputs.</p>
<p>Ideally <code>sage</code> should not <code>SIGSEGV</code> on problematic inputs and should
instead print reasonable backtraces. At least printing a nicer error
message should not be hard, should it?</p>
<h2 id="the-symptom">The symptom</h2>
<p>The report said that a simple session caused <code>sage</code> tool from <code>sagemath</code>
package to <code>SIGSEGV</code>:</p>
<pre><code>$ sage
sage: libgap.AbelianGroup(0,0,0)

...
Segmentation fault (core dumped)</code></pre>
<p><code>sage</code> is an <code>ipython</code> <code>REPL</code> with a bunch of bindings for math
libraries like <a href="https://www.gap-system.org/"><code>GAP</code></a>.
It is said that the bug happens only when <code>sagemath</code> is built against
<code>python-3.12</code> while <code>python-3.11</code> would work without the problems.
Normally it would be a strong hint of a <code>sagemath</code> bug. But the reporter
suspected it’s a <code>gcc</code> problem as building <code>sage</code> with <code>-O1</code> made the
bug go away. Thus, the bug is at least dependent on generated code and is
likely not just a logic bug.</p>
<p><strong>Quick quiz: where do you think the bug lies?</strong> In <code>gcc</code>, <code>sagemath</code> or
somewhere else? And while at it: what is the cause of the bug?
Use-after-free, use of uninitialized data, logic bug or maybe something
else?</p>
<h2 id="the-first-reproducer-attempt-nixpkgs-package">The first reproducer attempt: <code>nixpkgs</code> package</h2>
<p>I tried to reproduce the bug by building <code>sage</code> from <code>nxipkgs</code>. As
expected <code>sage</code> built against <code>python-3.11</code> worked just fine.
<code>python-3.11</code> is a <code>nixpkgs</code> default. I tried to flip the default to
<code>python-3.12</code> with this local change:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/pkgs/top-level/all-packages.nix</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/pkgs/top-level/all-packages.nix</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -17505 +17505 @@ with pkgs;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="st">-  python3 = python311;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="va">+  python3 = python312;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -17509 +17509 @@ with pkgs;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="st">-  python3Packages = dontRecurseIntoAttrs python311Packages;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="va">+  python3Packages = dontRecurseIntoAttrs python312Packages;</span></span></code></pre></div>
<p>Building it did not work as is:</p>
<pre><code>$ nix build -f. sage
...

error: ipython-genutils-0.2.0 not supported for interpreter python3.12

error: nose-1.3.7 not supported for interpreter python3.12

&gt; src/gmpy2_convert_gmp.c:464:76: error: ‘PyLongObject’ {aka ‘struct _longobject’} has no member named ‘ob_digit’
&gt;   464 |                    sizeof(templong-&gt;ob_digit[0])*8 - PyLong_SHIFT, templong-&gt;ob_digit);
&gt;       |                                                                            ^~
&gt; error: command '/nix/store/8mjb3ziimfi3rki71q4s0916xkm4cm5p-gcc-wrapper-13.2.0/bin/gcc' failed with exit code 1
&gt; /nix/store/558iw5j1bk7z6wrg8cp96q2rx03jqj1v-stdenv-linux/setup: line 1579: pop_var_context: head of shell_variables not a function context
For full logs, run 'nix log /nix/store/g7mf3p2cylf74j3ypq2ifcspx61isb36-python3.12-gmpy2-2.1.2.drv'.

&gt; ModuleNotFoundError: No module named 'distutils'
&gt; configure: error: Python explicitly requested and python headers were not found
For full logs, run 'nix log /nix/store/xyd63v16k1krblcfypfn5bs6jqbj9lwd-audit-3.1.2.drv'.</code></pre>
<p>The above told me that some dependencies (at least in <code>nixpkgs</code>) are not
ready for <code>python-3.12</code>:</p>
<ul>
<li><code>nose</code> and <code>ipython-genutils</code> are explicitly disabled for <code>python-3.12</code>
in <code>nixpkgs</code></li>
<li><code>gmpy2</code> and <code>audit</code> just fail to build for API changes in <code>python</code>
itself</li>
</ul>
<p><code>gmpy2</code> specifically has an open
<a href="https://github.com/aleaxit/gmpy/issues/446">upstream report</a>
to add support for <code>python-3.12</code>. This means distributions have to apply
not yet upstreamed changes to get earlier <code>python-3.12</code> support.</p>
<p>All the above means that porting fixes are sometimes not trivial and
might vary from a distribution to distribution if they want to get
<code>python-3.12</code> tested earlier.
I did not feel confident to patch at least 4 <code>python</code> libraries to get
<code>sagemath</code> to build. I switched the tactic to reproduce the bug on the
system reporters were using and to explore it there.
Original reporter used Arch Linux to reproduce the failure. Another user
<a href="https://github.com/sagemath/sage/pull/36407#issuecomment-2093792864">reported</a>
that <code>Gentoo</code> users also seen the similar problem.</p>
<h2 id="the-second-reproducer-attempt-gentoo-package-from-sage-on-gentoo">The second reproducer attempt: <code>Gentoo</code> package from <code>::sage-on-gentoo</code></h2>
<p>I had a <code>Gentoo</code> <code>chroot</code> lying around for <code>nix</code> packaging testing. I
tried to reproduce <code>sagemath</code> failure there by using
<a href="https://github.com/cschwan/sage-on-gentoo"><code>::sage-on-gentoo</code></a> overlay.
Unfortunately neither latest release of <code>sagemath-standard-10.3</code> nor
<code>sagemath-standard-9999</code> <code>git</code> versions did build for me as is. I filed
2 bugs:</p>
<ul>
<li><a href="https://github.com/cschwan/sage-on-gentoo/issues/783"><code>cschwan/sage-on-gentoo#783</code></a>: <code>=sci-mathematics/sagemath-standard-10.3</code> fails as: <code>AttributeError: Can't pickle local object '_prepare_extension_detection.&lt;locals&gt;.&lt;lambda&gt;'</code></li>
<li><a href="https://github.com/cschwan/sage-on-gentoo/issues/784"><code>cschwan/sage-on-gentoo#784</code></a>: <code>=sci-mathematics/sage_setup-9999</code> fails as: <code>tar (child): sage-setup-*.tar.gz: Cannot open: No such file or directory</code></li>
</ul>
<p>I hoped that <code>pickle</code> failure was fixed in latest <code>git</code> and I could avoid
the second pickle bug by using it.
At least the <code>tar</code> failure looked like a packaging issue:</p>
<pre><code># ACCEPT_KEYWORDS='**' USE=text emerge -av1 sagemath-standard
...
tar (child): sage-setup-*.tar.gz: Cannot open: No such file or directory
tar (child): Error is not recoverable: exiting now
tar: Child returned status 2
tar: Error is not recoverable: exiting now
 * ERROR: sci-mathematics/sage_setup-9999::sage-on-gentoo failed (unpack phase):
...</code></pre>
<p>François Bissey promptly
<a href="https://github.com/cschwan/sage-on-gentoo/commit/cc57aef4021bf673d02d20bd483b2708f9336f63">fixed</a>
<code>tar</code> failure! Unfortunately that did not fix the <code>pickle</code> bug in
<code>sagemath-standard-9999</code> for me and it started failing just like <code>sagemath-standard-10.3</code>:</p>
<pre><code># emerge -av1 sagemath-standard
...
AttributeError: Can't pickle local object '_prepare_extension_detection.&lt;locals&gt;.&lt;lambda&gt;'</code></pre>
<p>Surprisingly not everyone saw that problem and some people were able to
build the packages just fine. Day later I explored where
<code>_prepare_extension_detection</code> comes from and I was able to find a
<a href="https://github.com/cschwan/sage-on-gentoo/issues/783#issuecomment-2095500118">surprising workaround</a>:
I needed to uninstall completely unrelated <code>scikit-build-core</code> <code>python</code>
package that happened to be present in my system. <code>scikit-build-core</code> is
not used by <code>sagemath-standard</code> neither directly nor indirectly. But
somehow <a href="https://github.com/scikit-build/scikit-build-core/blob/f6ed5a28fc85e621b03d984011d17def888ee0db/src/scikit_build_core/setuptools/build_cmake.py#L183">it’s code</a> injected
the extra attributes to <code>cmake</code>-based package builds and failed the build.</p>
<p>At least I finally got <code>sage</code> tool in my <code>$PATH</code>!
I took me two evenings to get <code>sagemath</code> to build. At last I could look
at the crash now.</p>
<h2 id="exploring-the-crash">Exploring the crash</h2>
<p><code>sage</code> is a python program. It has a default handler that executes <code>gdb</code>
at crash time. Unfortunately it does not work on <code>Gentoo</code>:</p>
<pre><code>Attaching gdb to process id 1023.
Traceback (most recent call last):
  File &quot;/usr/lib/python-exec/python3.12/cysignals-CSI&quot;, line 225, in &lt;module&gt;
    main(args)
  File &quot;/usr/lib/python-exec/python3.12/cysignals-CSI&quot;, line 174, in main
    trace = run_gdb(args.pid, not args.nocolor)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/lib/python-exec/python3.12/cysignals-CSI&quot;, line 98, in run_gdb
    stdout, stderr = cmd.communicate(gdb_commands(pid, color))
                                     ^^^^^^^^^^^^^^^^^^^^^^^^
  File &quot;/usr/lib/python-exec/python3.12/cysignals-CSI&quot;, line 71, in gdb_commands
    with open(script, 'rb') as f:
         ^^^^^^^^^^^^^^^^^^
FileNotFoundError: [Errno 2] No such file or directory: '/usr/lib/python-exec/python3.12/../share/cysignals/cysignals-CSI-helper.py'</code></pre>
<p>Missing <code>cysignals-CSI-helper.py</code> file at the expected location is a
case of <a href="https://bugs.gentoo.org/927767">packaging error</a>. <code>Gentoo</code> uses
very unusual path to python launcher and breaks too simplistic
<code>argv[0]+"/../share"</code> path construction used in <code>cysignals</code>. Adding a
few more <code>"../../../"</code> should do as a workaround.
I was able to work around <code>gdb</code> launch failure by attaching <code>gdb</code> to
already running process before pasting the problematic command into the
<code>REPL</code>:</p>
<pre><code># gdb --quiet -p `pgrep sage-ipython`
Attaching to process 1060
[New LWP 1082]
[New LWP 1083]
[Thread debugging using libthread_db enabled]
Using host libthread_db library &quot;/lib64/libthread_db.so.1&quot;.
0x00007fedba181256 in epoll_wait (epfd=5, events=events@entry=0x7fed57127590, maxevents=maxevents@entry=2,
    timeout=timeout@entry=500) at ../sysdeps/unix/sysv/linux/epoll_wait.c:30
30        return SYSCALL_CANCEL (epoll_wait, epfd, events, maxevents, timeout);</code></pre>
<p>To get more details from the crash site I ran <code>continue</code> in <code>gdb</code> and
typed the trigger expression: <code>libgap.AbelianGroup(0,0,0)</code>.
To my surprise I got not a <code>SIGSEGV</code> but a <code>SIGABRT</code>:</p>
<pre><code>(gdb) continue
Continuing.
[Thread 0x7fed56e006c0 (LWP 1083) exited]
[Detaching after vfork from child process 1105]

Thread 1 &quot;sage-ipython&quot; received signal SIGABRT, Aborted.
0x00007fedba0b97a7 in __GI_kill () at ../sysdeps/unix/syscall-template.S:120
120     T_PSEUDO (SYSCALL_SYMBOL, SYSCALL_NAME, SYSCALL_NARGS)</code></pre>
<p>The default signal handler for <code>SIGABRT</code> normally crashes the process
and generates a core dump. <code>sagemath</code> installs <code>SIGABRT</code> handler (via
<code>cysignals</code> library) to report and recover from some errors like argument
type errors in the interpreter session.
<code>gdb</code> always intercepts <code>SIGABRT</code> before executing the handler. Thus, I
needed to explicitly continue execution in <code>gdb</code> session:</p>
<pre><code>(gdb) continue
Continuing.

Thread 1 &quot;sage-ipython&quot; received signal SIGSEGV, Segmentation fault.
0x00007fed5d13956f in _Py_IsImmortal (op=0x0) at /usr/include/python3.12/object.h:242
242         return _Py_CAST(PY_INT32_T, op-&gt;ob_refcnt) &lt; 0;</code></pre>
<p>Yay! I got the <code>SIGSEGV</code>!</p>
<p>A simple <code>NULL</code> dereference. What could be easier to debug? Just check
where it was set to <code>NULL</code> and do something about it, right?
First thing I wondered about is how does <code>SIGABRT</code> handler look like? It
was an idle curiosity. I expected to see some simple global variable tweak.
Alas what I found was <a href="https://github.com/sagemath/cysignals/blob/035ed1605a8741a6f265a55cc682b26ea6e5d1c2/src/cysignals/implementation.c#L279"><code>longjmp()</code></a>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> cysigs_interrupt_handler<span class="op">(</span><span class="dt">int</span> sig<span class="op">)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>cysigs<span class="op">.</span>sig_on_count <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>cysigs<span class="op">.</span>block_sigint <span class="op">&amp;&amp;</span> <span class="op">!</span>PARI_SIGINT_block <span class="op">&amp;&amp;</span> <span class="op">!</span>custom_signal_is_blocked<span class="op">())</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>            <span class="co">/* Raise an exception so Python can see it */</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>            do_raise_exception<span class="op">(</span>sig<span class="op">);</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>            <span class="co">/* Jump back to sig_on() (the first one if there is a stack) */</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>            siglongjmp<span class="op">(</span>trampoline<span class="op">,</span> sig<span class="op">);</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>One has to be
<a href="../posts/188-grub-0.97-and-gcc-4.9.html">very</a>
<a href="../posts/205-stack-protection-on-mips64.html">careful</a>
with <code>setjmp()</code> / <code>longjmp()</code>.</p>
<h2 id="the-example-setjmp-longjmp-failure-mode">The example <code>setjmp()</code> / <code>longjmp()</code> failure mode</h2>
<p>The <code>C</code> standard has a few constructs that don’t mix well with <code>C</code>
abstract machine. <code>setjmp()</code> / <code>longjmp()</code> is one of those. It’s a
frequent source of subtle and latent bugs.
In theory <code>setjmp()</code> / <code>longjmp()</code> is a portable way to save and restore
the execution at a certain point in the program. It’s a non-local
<code>goto</code>. It is very powerful: you can jump from a few nested calls with
a <code>longjmp()</code> back to where you called <code>setjmp()</code>. In practice one has
to be very careful to get something that works most of the time.</p>
<p>Let’s look at a contrived and <strong>intentionally buggy</strong> example:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// $ cat a.c</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;setjmp.h&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> jmp_buf jb<span class="op">;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>__attribute__<span class="op">((</span>noipa<span class="op">))</span> <span class="dt">static</span> <span class="dt">int</span> foo<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> r <span class="op">=</span> setjmp<span class="op">(</span>jb<span class="op">);</span> <span class="co">// r = 0 initially, r = 1 after longjmp()</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    a <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// gets executed twice, but the compiler does not know it!</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>r<span class="op">)</span> longjmp<span class="op">(</span>jb<span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="co">// execute it just once</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">;</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> r <span class="op">=</span> foo<span class="op">();</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;foo() = </span><span class="sc">%d</span><span class="st"> (expect 2)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> r<span class="op">);</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>r <span class="op">==</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Here we execute <code>foo()</code> function once and use <code>longjmp()</code> to return to
<code>setjmp()</code> (also just once). As a result we should execute <code>a += 1;</code>
statement twice:</p>
<ul>
<li>once during natural <code>foo()</code> execution</li>
<li>once via “hidden” jump via <code>longjmp()</code> call to <code>setjmp()</code>
location.</li>
</ul>
<p>I’m using <code>__attribute__((noipa))</code> to keep <code>foo()</code> from being inlined
into <code>main()</code> to ease <code>foo()</code> code exploration.</p>
<p>The test against the unoptimized build confirms that <code>a += 1</code> gets
executed twice:</p>
<pre><code>$ gcc a.c -o a -O0 &amp;&amp; ./a
foo() = 2 (expect 2)</code></pre>
<p>Assembly output shows the expected code:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">; $ gdb ./a</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co">; (gdb) disassemble foo</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>Dump of assembler code for function foo<span class="op">:</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>   &lt;+0&gt;:     <span class="bu">push</span>   <span class="op">%</span><span class="kw">rbp</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>   &lt;+1&gt;:     <span class="bu">mov</span>    <span class="op">%</span><span class="kw">rsp</span><span class="op">,%</span><span class="kw">rbp</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>   &lt;+4&gt;:     <span class="bu">sub</span>    <span class="op">$</span><span class="bn">0</span>x10<span class="op">,%</span><span class="kw">rsp</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>   &lt;+8&gt;:     movl   <span class="op">$</span><span class="bn">0</span>x0<span class="op">,-</span><span class="bn">0x8</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>   &lt;+15&gt;:    <span class="bu">lea</span>    <span class="bn">0x2ed4</span><span class="op">(%</span>rip<span class="op">),%</span><span class="kw">rax</span>        <span class="op">#</span> <span class="bn">0x404040</span> <span class="op">&lt;</span>jb<span class="op">&gt;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>   &lt;+22&gt;:    <span class="bu">mov</span>    <span class="op">%</span><span class="kw">rax</span><span class="op">,%</span><span class="kw">rdi</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>   &lt;+25&gt;:    <span class="cf">call</span>   <span class="bn">0x401050</span> <span class="op">&lt;</span>_setjmp<span class="fu">@</span><span class="er">p</span>lt<span class="op">&gt;</span> <span class="op">//</span> setjmp<span class="op">()</span><span class="co">;</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>   &lt;+30&gt;:    <span class="bu">mov</span>    <span class="op">%</span><span class="kw">eax</span><span class="op">,-</span><span class="bn">0x4</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>   &lt;+33&gt;:    addl   <span class="op">$</span><span class="bn">0</span>x1<span class="op">,-</span><span class="bn">0x8</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span>        <span class="op">//</span> a <span class="op">+=</span> <span class="dv">1</span><span class="co">;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>   &lt;+37&gt;:    cmpl   <span class="op">$</span><span class="bn">0</span>x0<span class="op">,-</span><span class="bn">0x4</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">)</span>        <span class="op">//</span> if <span class="op">(!</span>r<span class="op">)</span> <span class="op">...</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>   &lt;+41&gt;:    <span class="cf">jne</span>    <span class="bn">0x401195</span> <span class="op">&lt;</span>foo<span class="op">+</span><span class="dv">63</span><span class="op">&gt;</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>   &lt;+43&gt;:    <span class="bu">mov</span>    <span class="op">$</span><span class="bn">0</span>x1<span class="op">,%</span><span class="kw">esi</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>   &lt;+48&gt;:    <span class="bu">lea</span>    <span class="bn">0x2eb3</span><span class="op">(%</span>rip<span class="op">),%</span><span class="kw">rax</span>        <span class="op">#</span> <span class="bn">0x404040</span> <span class="op">&lt;</span>jb<span class="op">&gt;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>   &lt;+55&gt;:    <span class="bu">mov</span>    <span class="op">%</span><span class="kw">rax</span><span class="op">,%</span><span class="kw">rdi</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>   &lt;+58&gt;:    <span class="cf">call</span>   <span class="bn">0x401060</span> <span class="op">&lt;</span>longjmp<span class="fu">@</span><span class="er">p</span>lt<span class="op">&gt;</span> <span class="op">//</span> longjmp<span class="op">()</span><span class="co">;</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>   &lt;+63&gt;:    <span class="bu">mov</span>    <span class="op">-</span><span class="bn">0x8</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">),%</span><span class="kw">eax</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>   &lt;+66&gt;:    <span class="bu">leave</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>   &lt;+67&gt;:    <span class="cf">ret</span>                           <span class="op">//</span> return a<span class="co">;</span></span></code></pre></div>
<p>It’s a linear code with a single explicit branch to skip <code>longjmp()</code> call.
Looks easy?</p>
<p>Now let’s optimize it:</p>
<pre><code>$ gcc a.c -o a -O2 &amp;&amp; ./a
foo() = 1 (expect 2)
a: a.c:21: main: Assertion `r == 2' failed.
Aborted (core dumped)</code></pre>
<p>Whoops. <code>foo() = 1</code> output suggests that <code>a</code> was incremented only once.
Let’s look at the generated code to get the idea of what happened:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">; $ gdb ./a</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">; (gdb) disassemble foo</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>Dump of assembler code for function foo<span class="op">:</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>   &lt;+0&gt;:     <span class="bu">sub</span>    <span class="op">$</span><span class="bn">0</span>x8<span class="op">,%</span><span class="kw">rsp</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>   &lt;+4&gt;:     <span class="bu">lea</span>    <span class="bn">0x2e85</span><span class="op">(%</span>rip<span class="op">),%</span><span class="kw">rdi</span>        <span class="op">#</span> <span class="bn">0x404040</span> <span class="op">&lt;</span>jb<span class="op">&gt;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>   &lt;+11&gt;:    <span class="cf">call</span>   <span class="bn">0x401040</span> <span class="op">&lt;</span>_setjmp<span class="fu">@</span><span class="er">p</span>lt<span class="op">&gt;</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>   &lt;+16&gt;:    <span class="bu">test</span>   <span class="op">%</span><span class="kw">eax</span><span class="op">,%</span><span class="kw">eax</span>              <span class="op">//</span> if <span class="op">(!</span>r<span class="op">)</span> <span class="op">...</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>   &lt;+18&gt;:    <span class="cf">je</span>     <span class="bn">0x4011ce</span> <span class="op">&lt;</span>foo<span class="op">+</span><span class="dv">30</span><span class="op">&gt;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>   &lt;+20&gt;:    <span class="bu">mov</span>    <span class="op">$</span><span class="bn">0</span>x1<span class="op">,%</span><span class="kw">eax</span>              <span class="op">//</span> a <span class="op">=</span> <span class="dv">1</span><span class="co">;</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>   &lt;+25&gt;:    <span class="bu">add</span>    <span class="op">$</span><span class="bn">0</span>x8<span class="op">,%</span><span class="kw">rsp</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>   &lt;+29&gt;:    <span class="cf">ret</span>                           <span class="op">//</span> return a</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>   &lt;+30&gt;:    <span class="bu">mov</span>    <span class="op">$</span><span class="bn">0</span>x1<span class="op">,%</span><span class="kw">esi</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>   &lt;+35&gt;:    <span class="bu">lea</span>    <span class="bn">0x2e66</span><span class="op">(%</span>rip<span class="op">),%</span><span class="kw">rdi</span>        <span class="op">#</span> <span class="bn">0x404040</span> <span class="op">&lt;</span>jb<span class="op">&gt;</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>   &lt;+42&gt;:    <span class="cf">call</span>   <span class="bn">0x401060</span> <span class="op">&lt;</span>__longjmp_chk<span class="fu">@</span><span class="er">p</span>lt<span class="op">&gt;</span></span></code></pre></div>
<p>Nothing prevented <code>gcc</code> from transforming the original <code>foo()</code> into this
simpler form:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>__attribute__<span class="op">((</span>noipa<span class="op">))</span> <span class="dt">static</span> <span class="dt">int</span> foo<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> r <span class="op">=</span> setjmp<span class="op">(</span>jb<span class="op">);</span> <span class="co">// r = 0 initially, r = 1 after longjmp()</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>r<span class="op">)</span> longjmp<span class="op">(</span>jb<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> a <span class="op">=</span> <span class="dv">1</span><span class="op">;</span>          <span class="co">// moved `int a = 0;` here and merged into `a += 1;`.</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span></code></pre></div>
<p>Here <code>gcc</code> did quite a bit of code motion:</p>
<ul>
<li><code>gcc</code> moved <code>int a = 0;</code> assignment and an <code>a += 1;</code> increment after
both <code>setjmp()</code> and <code>longjmp()</code>.</li>
<li><code>gcc</code> merged <code>int a = 0;</code>, <code>a += 1;</code> and <code>return a;</code> into a single <code>return 1;</code>.</li>
</ul>
<p><strong>Note that <code>gcc</code> moved all <code>a</code> manipulation across <code>setjmp()</code> and even
<code>longjmp()</code> boundaries</strong>. <code>setjmp()</code> is expected to be
just a <code>C</code> function for <code>gcc</code>. <code>gcc</code> does not have to have any special
knowledge about control flow semantics of those functions. Thus, this
optimization transformation while completely breaking the original
code’s intent is legitimate and expected.</p>
<p><code>man 3 setjmp</code> covers exactly this case in <code>CAVEATS</code> section as:</p>
<pre><code>CAVEATS
  The compiler may optimize variables into registers, and longjmp() may
  restore the values of other registers in addition to the stack pointer
  and program counter. Consequently, the values of automatic variables
  are unspecified after a call to longjmp() if they meet all the
  following criteria:
  •  they are local to the function that made the corresponding setjmp()
     call;
  •  their values are changed between the calls to setjmp() and
     longjmp(); and
  •  they are not declared as volatile.</code></pre>
<p>It’s up to code author to adhere to these <code>CAVEATS</code>. Would be nice if
the compiler would be able to warn about the violations in simpler cases
though: <code>-flto</code> could expose large chunk of the control flow graph to
the analyzer.</p>
<p>Back to our broken example. One of the possible fixes here is to declare
<code>a</code> as <code>volatile</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a.c.buggy   2024-05-09 23:14:54.383811692 +0100</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ a.c 2024-05-10 00:03:53.694219636 +0100</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -7,3 +7,3 @@</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a> __attribute__((noipa)) static int foo(void) {</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="st">-    int a = 0;</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="va">+    volatile int a = 0;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>     int r = setjmp(jb); // r = 0 initially, r = 1 after longjmp()</span></code></pre></div>
<p>That would give us the following (correct) example:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;setjmp.h&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> jmp_buf jb<span class="op">;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>__attribute__<span class="op">((</span>noipa<span class="op">))</span> <span class="dt">static</span> <span class="dt">int</span> foo<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">volatile</span> <span class="dt">int</span> a <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> r <span class="op">=</span> setjmp<span class="op">(</span>jb<span class="op">);</span> <span class="co">// r = 0 initially, r = 1 after longjmp()</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    a <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// gets executed twice</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>r<span class="op">)</span> longjmp<span class="op">(</span>jb<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a<span class="op">;</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">void</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> r <span class="op">=</span> foo<span class="op">();</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;foo() = </span><span class="sc">%d</span><span class="st"> (expect 2)</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> r<span class="op">);</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>r <span class="op">==</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Running:</p>
<pre><code>$ gcc a.c -o a -O0 &amp;&amp; ./a
foo() = 2 (expect 2)

$ gcc a.c -o a -O2 &amp;&amp; ./a
foo() = 2 (expect 2)</code></pre>
<p>The execution confirms that both optimizations run the increment twice
as intended. This is the generated code for completeness:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">; gdb ./a</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co">; (gdb) disassemble foo</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>Dump of assembler code for function foo<span class="op">:</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>   &lt;+0&gt;:     <span class="bu">sub</span>    <span class="op">$</span><span class="bn">0</span>x18<span class="op">,%</span><span class="kw">rsp</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>   &lt;+4&gt;:     <span class="bu">lea</span>    <span class="bn">0x2e85</span><span class="op">(%</span>rip<span class="op">),%</span><span class="kw">rdi</span>        <span class="op">#</span> <span class="bn">0x404040</span> <span class="op">&lt;</span>jb<span class="op">&gt;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>   &lt;+11&gt;:    movl   <span class="op">$</span><span class="bn">0</span>x0<span class="op">,</span><span class="bn">0xc</span><span class="op">(%</span><span class="kw">rsp</span><span class="op">)</span>           <span class="op">//</span> int a <span class="op">=</span> <span class="dv">0</span><span class="co">;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>   &lt;+19&gt;:    <span class="cf">call</span>   <span class="bn">0x401040</span> <span class="op">&lt;</span>_setjmp<span class="fu">@</span><span class="er">p</span>lt<span class="op">&gt;</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>   &lt;+24&gt;:    <span class="bu">mov</span>    <span class="op">%</span><span class="kw">eax</span><span class="op">,%</span><span class="kw">edx</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>   &lt;+26&gt;:    <span class="bu">mov</span>    <span class="bn">0xc</span><span class="op">(%</span><span class="kw">rsp</span><span class="op">),%</span><span class="kw">eax</span>           <span class="op">//</span> load a from stack</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>   &lt;+30&gt;:    <span class="bu">add</span>    <span class="op">$</span><span class="bn">0</span>x1<span class="op">,%</span><span class="kw">eax</span>                <span class="op">//</span> a <span class="op">+=</span> <span class="dv">1</span><span class="co">;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>   &lt;+33&gt;:    <span class="bu">mov</span>    <span class="op">%</span><span class="kw">eax</span><span class="op">,</span><span class="bn">0xc</span><span class="op">(%</span><span class="kw">rsp</span><span class="op">)</span>           <span class="op">//</span> store a on stack</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>   &lt;+37&gt;:    <span class="bu">test</span>   <span class="op">%</span><span class="kw">edx</span><span class="op">,%</span><span class="kw">edx</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>   &lt;+39&gt;:    <span class="cf">je</span>     <span class="bn">0x4011e2</span> <span class="op">&lt;</span>foo<span class="op">+</span><span class="dv">50</span><span class="op">&gt;</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>   &lt;+41&gt;:    <span class="bu">mov</span>    <span class="bn">0xc</span><span class="op">(%</span><span class="kw">rsp</span><span class="op">),%</span><span class="kw">eax</span>           <span class="op">//</span> load a from stack</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>   &lt;+45&gt;:    <span class="bu">add</span>    <span class="op">$</span><span class="bn">0</span>x18<span class="op">,%</span><span class="kw">rsp</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>   &lt;+49&gt;:    <span class="cf">ret</span>                             <span class="op">//</span> return</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>   &lt;+50&gt;:    <span class="bu">mov</span>    <span class="op">$</span><span class="bn">0</span>x1<span class="op">,%</span><span class="kw">esi</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>   &lt;+55&gt;:    <span class="bu">lea</span>    <span class="bn">0x2e52</span><span class="op">(%</span>rip<span class="op">),%</span><span class="kw">rdi</span>        <span class="op">#</span> <span class="bn">0x404040</span> <span class="op">&lt;</span>jb<span class="op">&gt;</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>   &lt;+62&gt;:    <span class="cf">call</span>   <span class="bn">0x401060</span> <span class="op">&lt;</span>__longjmp_chk<span class="fu">@</span><span class="er">p</span>lt<span class="op">&gt;</span></span></code></pre></div>
<p>Note that use of <code>volatile</code> in <code>setjmp()</code> / <code>longjmp()</code> effectively
inhibits completely reasonable compiler optimizations just to make loads
and stores in generated code to match the order written in <code>C</code> source
code for a given function.</p>
<p>I wonder if adding <code>volatile</code> is enough for more heavyweight
optimizations like <code>-flto</code> that enable even more code movement, constant
propagation and stack reuse. The time will tell.</p>
<h2 id="sagemath-use-of-setjmp-longjmp"><code>sagemath</code> use of <code>setjmp()</code> / <code>longjmp()</code></h2>
<p>After I noticed <code>setjmp()</code> / <code>longjmp()</code> use in <code>sagemath</code> I wondered how
many <code>volatile</code> keywords it has in the code where those were used.
To my surprise it had none. That was a good hint in a sense that it
looked like the problem we are dealing with. From that point I was
reasonably sure it’s an application bug and not a <code>gcc</code> bug.
Still, having the concrete corruption evidence would help to clear any
doubts and would help the reporter to craft a fix for <code>sagemath</code>.</p>
<p>The backtrace claimed that the crash happens in
<code>__pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__</code>
function:</p>
<pre><code>(gdb) continue
Continuing.

Thread 1 &quot;sage-ipython&quot; received signal SIGSEGV, Segmentation fault.
0x00007feb544b756f in _Py_IsImmortal (op=0x0) at /usr/include/python3.12/object.h:242
242         return _Py_CAST(PY_INT32_T, op-&gt;ob_refcnt) &lt; 0;
(gdb) bt
#0  0x00007feb544b756f in _Py_IsImmortal (op=0x0) at /usr/include/python3.12/object.h:242
#1  Py_DECREF (op=0x0) at /usr/include/python3.12/object.h:700
#2  Py_XDECREF (op=0x0) at /usr/include/python3.12/object.h:798
#3  __pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__ (
    __pyx_v_self=__pyx_v_self@entry=0x7feb4e274f40,
    __pyx_v_args=__pyx_v_args@entry=(&lt;sage.rings.integer.Integer at remote 0x7feb533456e0&gt;, &lt;sage.rings.integer.Integer at remote 0x7feb4e5dd8c0&gt;, &lt;sage.rings.integer.Integer at remote 0x7feb4e5dd620&gt;))
    at /usr/src/debug/sci-mathematics/sagemath-standard-10.3/sagemath-standard-10.3-python3_12/build/cythonized/sage/libs/gap/element.c:26535
...</code></pre>
<p><code>"__pyx_"</code> prefix suggests it’s a function generated by
<a href="https://cython.org/"><code>cython</code></a>, a python-style DSL for writing <code>C</code> part
of code to create bindings for <code>C</code> libraries to be used in <code>python</code>
libraries. In this case <code>sagemath</code> created bindings for <code>libgap</code>
discrete algebra library.</p>
<p>The <code>cython</code> code for a function we saw a <code>SIGSEGV</code> in looked
<a href="https://github.com/sagemath/sage/blob/744939e037a67193e730d7205e612e2d58197fca/src/sage/libs/gap/element.pyx#L2504">this way</a>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>cdef <span class="kw">class</span> GapElement_Function(GapElement):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, <span class="op">*</span>args):</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        cdef Obj result <span class="op">=</span> NULL</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        cdef Obj arg_list</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        cdef <span class="bu">int</span> n <span class="op">=</span> <span class="bu">len</span>(args)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> n <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> n <span class="op">&lt;=</span> <span class="dv">3</span>:</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>            libgap <span class="op">=</span> <span class="va">self</span>.parent()</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>            a <span class="op">=</span> [x <span class="cf">if</span> <span class="bu">isinstance</span>(x, GapElement) <span class="cf">else</span> libgap(x) <span class="cf">for</span> x <span class="kw">in</span> args]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>            sig_GAP_Enter()</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>            sig_on()</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> n <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> GAP_CallFunc0Args(<span class="va">self</span>.value)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> n <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> GAP_CallFunc1Args(<span class="va">self</span>.value,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>                                           (<span class="op">&lt;</span>GapElement<span class="op">&gt;</span>a[<span class="dv">0</span>]).value)</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> n <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> GAP_CallFunc2Args(<span class="va">self</span>.value,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>                                           (<span class="op">&lt;</span>GapElement<span class="op">&gt;</span>a[<span class="dv">0</span>]).value,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>                                           (<span class="op">&lt;</span>GapElement<span class="op">&gt;</span>a[<span class="dv">1</span>]).value)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> n <span class="op">==</span> <span class="dv">3</span>:</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> GAP_CallFunc3Args(<span class="va">self</span>.value,</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>                                           (<span class="op">&lt;</span>GapElement<span class="op">&gt;</span>a[<span class="dv">0</span>]).value,</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>                                           (<span class="op">&lt;</span>GapElement<span class="op">&gt;</span>a[<span class="dv">1</span>]).value,</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>                                           (<span class="op">&lt;</span>GapElement<span class="op">&gt;</span>a[<span class="dv">2</span>]).value)</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>                arg_list <span class="op">=</span> make_gap_list(args)</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>                result <span class="op">=</span> GAP_CallFuncList(<span class="va">self</span>.value, arg_list)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>            sig_off()</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">finally</span>:</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>            GAP_Leave()</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result <span class="op">==</span> NULL:</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>            <span class="co"># We called a procedure that does not return anything</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> make_any_gap_element(<span class="va">self</span>.parent(), result)</span></code></pre></div>
<p>Looks very straightforward. No <code>setjmp()</code> in sight yet, or is there?.</p>
<p>WARNING: you are about to scroll through A Lot Of Code. You might want
to skip the bulk it and return later The build system produces
<code>element.c</code> with this contents:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define sig_GAP_Enter</span><span class="op">()</span><span class="pp"> </span><span class="op">{</span><span class="dt">int</span><span class="pp"> t </span><span class="op">=</span><span class="pp"> GAP_Enter</span><span class="op">();</span><span class="pp"> </span><span class="cf">if</span><span class="pp"> </span><span class="op">(!</span><span class="pp">t</span><span class="op">)</span><span class="pp"> sig_error</span><span class="op">();}</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define GAP_Enter</span><span class="op">()</span><span class="pp"> GAP_Error_Setjmp</span><span class="op">();</span><span class="pp"> GAP_EnterStack</span><span class="op">()</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define GAP_Error_Setjmp</span><span class="op">()</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="pp">    </span><span class="op">(</span><span class="pp">GAP_unlikely</span><span class="op">(</span><span class="pp">GAP_Error_Prejmp_</span><span class="op">(</span><span class="pp">__FILE__</span><span class="op">,</span><span class="pp"> __LINE__</span><span class="op">))</span><span class="pp"> </span><span class="op">\</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="pp">     </span><span class="op">||</span><span class="pp"> GAP_Error_Postjmp_</span><span class="op">(</span><span class="pp">_setjmp</span><span class="op">(*</span><span class="pp">GAP_GetReadJmpError</span><span class="op">())))</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> PyObject <span class="op">*</span>__pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__<span class="op">(</span><span class="kw">struct</span> __pyx_obj_4sage_4libs_3gap_7element_GapElement_Function <span class="op">*</span>__pyx_v_self<span class="op">,</span> PyObject <span class="op">*</span>__pyx_v_args<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  Obj __pyx_v_result<span class="op">;</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  Obj __pyx_v_arg_list<span class="op">;</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> __pyx_v_n<span class="op">;</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_v_libgap <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_v_a <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_8genexpr3__pyx_v_x <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_r <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  __Pyx_RefNannyDeclarations</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  Py_ssize_t __pyx_t_1<span class="op">;</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> __pyx_t_2<span class="op">;</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> __pyx_t_3<span class="op">;</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_t_4 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_t_5 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_t_6 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> __pyx_t_7<span class="op">;</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_t_8 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_t_9 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_t_10 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  Obj __pyx_t_11<span class="op">;</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> __pyx_t_12<span class="op">;</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> <span class="dt">const</span> <span class="op">*</span>__pyx_t_13<span class="op">;</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_t_14 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_t_15 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_t_16 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_t_17 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_t_18 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>  PyObject <span class="op">*</span>__pyx_t_19 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> __pyx_lineno <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">const</span> <span class="dt">char</span> <span class="op">*</span>__pyx_filename <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> __pyx_clineno <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>  __Pyx_RefNannySetupContext<span class="op">(</span><span class="st">&quot;__call__&quot;</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2504</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="co"> *             hello from the shell</span></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a><span class="co"> *         &quot;&quot;&quot;</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="co"> *         cdef Obj result = NULL             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="co"> *         cdef Obj arg_list</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="co"> *         cdef int n = len(args)</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>  __pyx_v_result <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2506</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a><span class="co"> *         cdef Obj result = NULL</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a><span class="co"> *         cdef Obj arg_list</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="co"> *         cdef int n = len(args)             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a><span class="co"> *         if n &gt; 0 and n &lt;= 3:</span></span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a>  __pyx_t_1 <span class="op">=</span> __Pyx_PyTuple_GET_SIZE<span class="op">(</span>__pyx_v_args<span class="op">);</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(</span>__pyx_t_1 <span class="op">==</span> <span class="op">((</span>Py_ssize_t<span class="op">)-</span><span class="dv">1</span><span class="op">)))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2506</span><span class="op">,</span> __pyx_L1_error<span class="op">)</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>  __pyx_v_n <span class="op">=</span> __pyx_t_1<span class="op">;</span></span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2508</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a><span class="co"> *         cdef int n = len(args)</span></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a><span class="co"> *         if n &gt; 0 and n &lt;= 3:             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a><span class="co"> *             libgap = self.parent()</span></span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a><span class="co"> *             a = [x if isinstance(x, GapElement) else libgap(x) for x in args]</span></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>  __pyx_t_3 <span class="op">=</span> <span class="op">(</span>__pyx_v_n <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>__pyx_t_3<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a>    __pyx_t_2 <span class="op">=</span> __pyx_t_3<span class="op">;</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">goto</span> __pyx_L4_bool_binop_done<span class="op">;</span></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>  __pyx_t_3 <span class="op">=</span> <span class="op">(</span>__pyx_v_n <span class="op">&lt;=</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>  __pyx_t_2 <span class="op">=</span> __pyx_t_3<span class="op">;</span></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>  __pyx_L4_bool_binop_done<span class="op">:;</span></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>__pyx_t_2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2509</span></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a><span class="co"> *         if n &gt; 0 and n &lt;= 3:</span></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a><span class="co"> *             libgap = self.parent()             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a><span class="co"> *             a = [x if isinstance(x, GapElement) else libgap(x) for x in args]</span></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>    __pyx_t_5 <span class="op">=</span> __Pyx_PyObject_GetAttrStr<span class="op">(((</span>PyObject <span class="op">*)</span>__pyx_v_self<span class="op">),</span> __pyx_n_s_parent<span class="op">);</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_5<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2509</span><span class="op">,</span> __pyx_L1_error<span class="op">)</span></span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>    __Pyx_GOTREF<span class="op">(</span>__pyx_t_5<span class="op">);</span></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>    __pyx_t_6 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>    __pyx_t_7 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#if CYTHON_UNPACK_METHODS</span></span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>likely<span class="op">(</span>PyMethod_Check<span class="op">(</span>__pyx_t_5<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a>      __pyx_t_6 <span class="op">=</span> PyMethod_GET_SELF<span class="op">(</span>__pyx_t_5<span class="op">);</span></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>likely<span class="op">(</span>__pyx_t_6<span class="op">))</span> <span class="op">{</span></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a>        PyObject<span class="op">*</span> function <span class="op">=</span> PyMethod_GET_FUNCTION<span class="op">(</span>__pyx_t_5<span class="op">);</span></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>        __Pyx_INCREF<span class="op">(</span>__pyx_t_6<span class="op">);</span></span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>        __Pyx_INCREF<span class="op">(</span>function<span class="op">);</span></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>        __Pyx_DECREF_SET<span class="op">(</span>__pyx_t_5<span class="op">,</span> function<span class="op">);</span></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>        __pyx_t_7 <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>    <span class="pp">#endif</span></span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>      PyObject <span class="op">*</span>__pyx_callargs<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span>__pyx_t_6<span class="op">,</span> NULL<span class="op">};</span></span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>      __pyx_t_4 <span class="op">=</span> __Pyx_PyObject_FastCall<span class="op">(</span>__pyx_t_5<span class="op">,</span> __pyx_callargs<span class="op">+</span><span class="dv">1</span><span class="op">-</span>__pyx_t_7<span class="op">,</span> <span class="dv">0</span><span class="op">+</span>__pyx_t_7<span class="op">);</span></span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>      __Pyx_XDECREF<span class="op">(</span>__pyx_t_6<span class="op">);</span> __pyx_t_6 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_4<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2509</span><span class="op">,</span> __pyx_L1_error<span class="op">)</span></span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>      __Pyx_GOTREF<span class="op">(</span>__pyx_t_4<span class="op">);</span></span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>      __Pyx_DECREF<span class="op">(</span>__pyx_t_5<span class="op">);</span> __pyx_t_5 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>    __pyx_v_libgap <span class="op">=</span> __pyx_t_4<span class="op">;</span></span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>    __pyx_t_4 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2510</span></span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a><span class="co"> *         if n &gt; 0 and n &lt;= 3:</span></span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a><span class="co"> *             libgap = self.parent()</span></span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a><span class="co"> *             a = [x if isinstance(x, GapElement) else libgap(x) for x in args]             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a><span class="co"> *         try:</span></span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> <span class="co">/* enter inner scope */</span></span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>      __pyx_t_4 <span class="op">=</span> PyList_New<span class="op">(</span><span class="dv">0</span><span class="op">);</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_4<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2510</span><span class="op">,</span> __pyx_L8_error<span class="op">)</span></span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a>      __Pyx_GOTREF<span class="op">(</span>__pyx_t_4<span class="op">);</span></span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>      __pyx_t_5 <span class="op">=</span> __pyx_v_args<span class="op">;</span> __Pyx_INCREF<span class="op">(</span>__pyx_t_5<span class="op">);</span></span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>      __pyx_t_1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a>          Py_ssize_t __pyx_temp <span class="op">=</span> __Pyx_PyTuple_GET_SIZE<span class="op">(</span>__pyx_t_5<span class="op">);</span></span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a>          <span class="pp">#if !CYTHON_ASSUME_SAFE_MACROS</span></span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">((</span>__pyx_temp <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2510</span><span class="op">,</span> __pyx_L8_error<span class="op">)</span></span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a>          <span class="pp">#endif</span></span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>__pyx_t_1 <span class="op">&gt;=</span> __pyx_temp<span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a>        <span class="pp">#if CYTHON_ASSUME_SAFE_MACROS &amp;&amp; !CYTHON_AVOID_BORROWED_REFS</span></span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a>        __pyx_t_6 <span class="op">=</span> PyTuple_GET_ITEM<span class="op">(</span>__pyx_t_5<span class="op">,</span> __pyx_t_1<span class="op">);</span> __Pyx_INCREF<span class="op">(</span>__pyx_t_6<span class="op">);</span> __pyx_t_1<span class="op">++;</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">((</span><span class="dv">0</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2510</span><span class="op">,</span> __pyx_L8_error<span class="op">)</span></span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a>        <span class="pp">#else</span></span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a>        __pyx_t_6 <span class="op">=</span> __Pyx_PySequence_ITEM<span class="op">(</span>__pyx_t_5<span class="op">,</span> __pyx_t_1<span class="op">);</span> __pyx_t_1<span class="op">++;</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_6<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2510</span><span class="op">,</span> __pyx_L8_error<span class="op">)</span></span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a>        __Pyx_GOTREF<span class="op">(</span>__pyx_t_6<span class="op">);</span></span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a>        <span class="pp">#endif</span></span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a>        __Pyx_XDECREF_SET<span class="op">(</span>__pyx_8genexpr3__pyx_v_x<span class="op">,</span> __pyx_t_6<span class="op">);</span></span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a>        __pyx_t_6 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a>        __pyx_t_2 <span class="op">=</span> __Pyx_TypeCheck<span class="op">(</span>__pyx_8genexpr3__pyx_v_x<span class="op">,</span> __pyx_ptype_4sage_4libs_3gap_7element_GapElement<span class="op">);</span> </span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>__pyx_t_2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a>          __Pyx_INCREF<span class="op">(</span>__pyx_8genexpr3__pyx_v_x<span class="op">);</span></span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a>          __pyx_t_6 <span class="op">=</span> __pyx_8genexpr3__pyx_v_x<span class="op">;</span></span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a>          __Pyx_INCREF<span class="op">(</span>__pyx_v_libgap<span class="op">);</span></span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a>          __pyx_t_9 <span class="op">=</span> __pyx_v_libgap<span class="op">;</span> __pyx_t_10 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a>          __pyx_t_7 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a>          <span class="pp">#if CYTHON_UNPACK_METHODS</span></span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(</span>PyMethod_Check<span class="op">(</span>__pyx_t_9<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a>            __pyx_t_10 <span class="op">=</span> PyMethod_GET_SELF<span class="op">(</span>__pyx_t_9<span class="op">);</span></span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>likely<span class="op">(</span>__pyx_t_10<span class="op">))</span> <span class="op">{</span></span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a>              PyObject<span class="op">*</span> function <span class="op">=</span> PyMethod_GET_FUNCTION<span class="op">(</span>__pyx_t_9<span class="op">);</span></span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a>              __Pyx_INCREF<span class="op">(</span>__pyx_t_10<span class="op">);</span></span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a>              __Pyx_INCREF<span class="op">(</span>function<span class="op">);</span></span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a>              __Pyx_DECREF_SET<span class="op">(</span>__pyx_t_9<span class="op">,</span> function<span class="op">);</span></span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a>              __pyx_t_7 <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb24-157"><a href="#cb24-157" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb24-158"><a href="#cb24-158" aria-hidden="true" tabindex="-1"></a>          <span class="pp">#endif</span></span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a>          <span class="op">{</span></span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a>            PyObject <span class="op">*</span>__pyx_callargs<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span>__pyx_t_10<span class="op">,</span> __pyx_8genexpr3__pyx_v_x<span class="op">};</span></span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a>            __pyx_t_8 <span class="op">=</span> __Pyx_PyObject_FastCall<span class="op">(</span>__pyx_t_9<span class="op">,</span> __pyx_callargs<span class="op">+</span><span class="dv">1</span><span class="op">-</span>__pyx_t_7<span class="op">,</span> <span class="dv">1</span><span class="op">+</span>__pyx_t_7<span class="op">);</span></span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a>            __Pyx_XDECREF<span class="op">(</span>__pyx_t_10<span class="op">);</span> __pyx_t_10 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_8<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2510</span><span class="op">,</span> __pyx_L8_error<span class="op">)</span></span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a>            __Pyx_GOTREF<span class="op">(</span>__pyx_t_8<span class="op">);</span></span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a>            __Pyx_DECREF<span class="op">(</span>__pyx_t_9<span class="op">);</span> __pyx_t_9 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a>          __pyx_t_6 <span class="op">=</span> __pyx_t_8<span class="op">;</span></span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a>          __pyx_t_8 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-169"><a href="#cb24-169" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb24-170"><a href="#cb24-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(</span>__Pyx_ListComp_Append<span class="op">(</span>__pyx_t_4<span class="op">,</span> <span class="op">(</span>PyObject<span class="op">*)</span>__pyx_t_6<span class="op">)))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2510</span><span class="op">,</span> __pyx_L8_error<span class="op">)</span></span>
<span id="cb24-171"><a href="#cb24-171" aria-hidden="true" tabindex="-1"></a>        __Pyx_DECREF<span class="op">(</span>__pyx_t_6<span class="op">);</span> __pyx_t_6 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-172"><a href="#cb24-172" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb24-173"><a href="#cb24-173" aria-hidden="true" tabindex="-1"></a>      __Pyx_DECREF<span class="op">(</span>__pyx_t_5<span class="op">);</span> __pyx_t_5 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-174"><a href="#cb24-174" aria-hidden="true" tabindex="-1"></a>      __Pyx_XDECREF<span class="op">(</span>__pyx_8genexpr3__pyx_v_x<span class="op">);</span> __pyx_8genexpr3__pyx_v_x <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-175"><a href="#cb24-175" aria-hidden="true" tabindex="-1"></a>      <span class="cf">goto</span> __pyx_L12_exit_scope<span class="op">;</span></span>
<span id="cb24-176"><a href="#cb24-176" aria-hidden="true" tabindex="-1"></a>      __pyx_L8_error<span class="op">:;</span></span>
<span id="cb24-177"><a href="#cb24-177" aria-hidden="true" tabindex="-1"></a>      __Pyx_XDECREF<span class="op">(</span>__pyx_8genexpr3__pyx_v_x<span class="op">);</span> __pyx_8genexpr3__pyx_v_x <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-178"><a href="#cb24-178" aria-hidden="true" tabindex="-1"></a>      <span class="cf">goto</span> __pyx_L1_error<span class="op">;</span></span>
<span id="cb24-179"><a href="#cb24-179" aria-hidden="true" tabindex="-1"></a>      __pyx_L12_exit_scope<span class="op">:;</span></span>
<span id="cb24-180"><a href="#cb24-180" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="co">/* exit inner scope */</span></span>
<span id="cb24-181"><a href="#cb24-181" aria-hidden="true" tabindex="-1"></a>    __pyx_v_a <span class="op">=</span> <span class="op">((</span>PyObject<span class="op">*)</span>__pyx_t_4<span class="op">);</span></span>
<span id="cb24-182"><a href="#cb24-182" aria-hidden="true" tabindex="-1"></a>    __pyx_t_4 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-183"><a href="#cb24-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-184"><a href="#cb24-184" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2508</span></span>
<span id="cb24-185"><a href="#cb24-185" aria-hidden="true" tabindex="-1"></a><span class="co"> *         cdef int n = len(args)</span></span>
<span id="cb24-186"><a href="#cb24-186" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb24-187"><a href="#cb24-187" aria-hidden="true" tabindex="-1"></a><span class="co"> *         if n &gt; 0 and n &lt;= 3:             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-188"><a href="#cb24-188" aria-hidden="true" tabindex="-1"></a><span class="co"> *             libgap = self.parent()</span></span>
<span id="cb24-189"><a href="#cb24-189" aria-hidden="true" tabindex="-1"></a><span class="co"> *             a = [x if isinstance(x, GapElement) else libgap(x) for x in args]</span></span>
<span id="cb24-190"><a href="#cb24-190" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-191"><a href="#cb24-191" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb24-192"><a href="#cb24-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-193"><a href="#cb24-193" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2512</span></span>
<span id="cb24-194"><a href="#cb24-194" aria-hidden="true" tabindex="-1"></a><span class="co"> *             a = [x if isinstance(x, GapElement) else libgap(x) for x in args]</span></span>
<span id="cb24-195"><a href="#cb24-195" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb24-196"><a href="#cb24-196" aria-hidden="true" tabindex="-1"></a><span class="co"> *         try:             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-197"><a href="#cb24-197" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_GAP_Enter()</span></span>
<span id="cb24-198"><a href="#cb24-198" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_on()</span></span>
<span id="cb24-199"><a href="#cb24-199" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-200"><a href="#cb24-200" aria-hidden="true" tabindex="-1"></a>  <span class="co">/*try:*/</span> <span class="op">{</span></span>
<span id="cb24-201"><a href="#cb24-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-202"><a href="#cb24-202" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2513</span></span>
<span id="cb24-203"><a href="#cb24-203" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb24-204"><a href="#cb24-204" aria-hidden="true" tabindex="-1"></a><span class="co"> *         try:</span></span>
<span id="cb24-205"><a href="#cb24-205" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_GAP_Enter()             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-206"><a href="#cb24-206" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_on()</span></span>
<span id="cb24-207"><a href="#cb24-207" aria-hidden="true" tabindex="-1"></a><span class="co"> *             if n == 0:</span></span>
<span id="cb24-208"><a href="#cb24-208" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-209"><a href="#cb24-209" aria-hidden="true" tabindex="-1"></a>    sig_GAP_Enter<span class="op">();</span></span>
<span id="cb24-210"><a href="#cb24-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-211"><a href="#cb24-211" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2514</span></span>
<span id="cb24-212"><a href="#cb24-212" aria-hidden="true" tabindex="-1"></a><span class="co"> *         try:</span></span>
<span id="cb24-213"><a href="#cb24-213" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_GAP_Enter()</span></span>
<span id="cb24-214"><a href="#cb24-214" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_on()             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-215"><a href="#cb24-215" aria-hidden="true" tabindex="-1"></a><span class="co"> *             if n == 0:</span></span>
<span id="cb24-216"><a href="#cb24-216" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc0Args(self.value)</span></span>
<span id="cb24-217"><a href="#cb24-217" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-218"><a href="#cb24-218" aria-hidden="true" tabindex="-1"></a>    __pyx_t_7 <span class="op">=</span> sig_on<span class="op">();</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(</span>__pyx_t_7 <span class="op">==</span> <span class="op">((</span><span class="dt">int</span><span class="op">)</span><span class="dv">0</span><span class="op">)))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2514</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span></span>
<span id="cb24-219"><a href="#cb24-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-220"><a href="#cb24-220" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2515</span></span>
<span id="cb24-221"><a href="#cb24-221" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_GAP_Enter()</span></span>
<span id="cb24-222"><a href="#cb24-222" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_on()</span></span>
<span id="cb24-223"><a href="#cb24-223" aria-hidden="true" tabindex="-1"></a><span class="co"> *             if n == 0:             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-224"><a href="#cb24-224" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc0Args(self.value)</span></span>
<span id="cb24-225"><a href="#cb24-225" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 1:</span></span>
<span id="cb24-226"><a href="#cb24-226" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-227"><a href="#cb24-227" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>__pyx_v_n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-228"><a href="#cb24-228" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span></span>
<span id="cb24-229"><a href="#cb24-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-230"><a href="#cb24-230" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2516</span></span>
<span id="cb24-231"><a href="#cb24-231" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_on()</span></span>
<span id="cb24-232"><a href="#cb24-232" aria-hidden="true" tabindex="-1"></a><span class="co"> *             if n == 0:</span></span>
<span id="cb24-233"><a href="#cb24-233" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc0Args(self.value)             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-234"><a href="#cb24-234" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 1:</span></span>
<span id="cb24-235"><a href="#cb24-235" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc1Args(self.value,</span></span>
<span id="cb24-236"><a href="#cb24-236" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-237"><a href="#cb24-237" aria-hidden="true" tabindex="-1"></a>      __pyx_v_result <span class="op">=</span> GAP_CallFunc0Args<span class="op">(</span>__pyx_v_self<span class="op">-&gt;</span>__pyx_base<span class="op">.</span>value<span class="op">);</span></span>
<span id="cb24-238"><a href="#cb24-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-239"><a href="#cb24-239" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2515</span></span>
<span id="cb24-240"><a href="#cb24-240" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_GAP_Enter()</span></span>
<span id="cb24-241"><a href="#cb24-241" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_on()</span></span>
<span id="cb24-242"><a href="#cb24-242" aria-hidden="true" tabindex="-1"></a><span class="co"> *             if n == 0:             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-243"><a href="#cb24-243" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc0Args(self.value)</span></span>
<span id="cb24-244"><a href="#cb24-244" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 1:</span></span>
<span id="cb24-245"><a href="#cb24-245" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-246"><a href="#cb24-246" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb24-247"><a href="#cb24-247" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">1</span><span class="op">:</span></span>
<span id="cb24-248"><a href="#cb24-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-249"><a href="#cb24-249" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2519</span></span>
<span id="cb24-250"><a href="#cb24-250" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 1:</span></span>
<span id="cb24-251"><a href="#cb24-251" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc1Args(self.value,</span></span>
<span id="cb24-252"><a href="#cb24-252" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value)             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-253"><a href="#cb24-253" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 2:</span></span>
<span id="cb24-254"><a href="#cb24-254" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc2Args(self.value,</span></span>
<span id="cb24-255"><a href="#cb24-255" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-256"><a href="#cb24-256" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_v_a<span class="op">))</span> <span class="op">{</span> __Pyx_RaiseUnboundLocalError<span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">);</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2519</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span> <span class="op">}</span></span>
<span id="cb24-257"><a href="#cb24-257" aria-hidden="true" tabindex="-1"></a>      __pyx_t_4 <span class="op">=</span> __Pyx_GetItemInt_List<span class="op">(</span>__pyx_v_a<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">long</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> __Pyx_PyInt_From_long<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_4<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2519</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span></span>
<span id="cb24-258"><a href="#cb24-258" aria-hidden="true" tabindex="-1"></a>      __Pyx_GOTREF<span class="op">(</span>__pyx_t_4<span class="op">);</span></span>
<span id="cb24-259"><a href="#cb24-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-260"><a href="#cb24-260" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2518</span></span>
<span id="cb24-261"><a href="#cb24-261" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc0Args(self.value)</span></span>
<span id="cb24-262"><a href="#cb24-262" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 1:</span></span>
<span id="cb24-263"><a href="#cb24-263" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc1Args(self.value,             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-264"><a href="#cb24-264" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value)</span></span>
<span id="cb24-265"><a href="#cb24-265" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 2:</span></span>
<span id="cb24-266"><a href="#cb24-266" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-267"><a href="#cb24-267" aria-hidden="true" tabindex="-1"></a>      __pyx_v_result <span class="op">=</span> GAP_CallFunc1Args<span class="op">(</span>__pyx_v_self<span class="op">-&gt;</span>__pyx_base<span class="op">.</span>value<span class="op">,</span> <span class="op">((</span><span class="kw">struct</span> __pyx_obj_4sage_4libs_3gap_7element_GapElement <span class="op">*)</span>__pyx_t_4<span class="op">)-&gt;</span>value<span class="op">);</span></span>
<span id="cb24-268"><a href="#cb24-268" aria-hidden="true" tabindex="-1"></a>      __Pyx_DECREF<span class="op">(</span>__pyx_t_4<span class="op">);</span> __pyx_t_4 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-269"><a href="#cb24-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-270"><a href="#cb24-270" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2517</span></span>
<span id="cb24-271"><a href="#cb24-271" aria-hidden="true" tabindex="-1"></a><span class="co"> *             if n == 0:</span></span>
<span id="cb24-272"><a href="#cb24-272" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc0Args(self.value)</span></span>
<span id="cb24-273"><a href="#cb24-273" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 1:             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-274"><a href="#cb24-274" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc1Args(self.value,</span></span>
<span id="cb24-275"><a href="#cb24-275" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value)</span></span>
<span id="cb24-276"><a href="#cb24-276" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-277"><a href="#cb24-277" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb24-278"><a href="#cb24-278" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">2</span><span class="op">:</span></span>
<span id="cb24-279"><a href="#cb24-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-280"><a href="#cb24-280" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2522</span></span>
<span id="cb24-281"><a href="#cb24-281" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 2:</span></span>
<span id="cb24-282"><a href="#cb24-282" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc2Args(self.value,</span></span>
<span id="cb24-283"><a href="#cb24-283" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value,             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-284"><a href="#cb24-284" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[1]).value)</span></span>
<span id="cb24-285"><a href="#cb24-285" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 3:</span></span>
<span id="cb24-286"><a href="#cb24-286" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-287"><a href="#cb24-287" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_v_a<span class="op">))</span> <span class="op">{</span> __Pyx_RaiseUnboundLocalError<span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">);</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2522</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span> <span class="op">}</span></span>
<span id="cb24-288"><a href="#cb24-288" aria-hidden="true" tabindex="-1"></a>      __pyx_t_4 <span class="op">=</span> __Pyx_GetItemInt_List<span class="op">(</span>__pyx_v_a<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">long</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> __Pyx_PyInt_From_long<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_4<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2522</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span></span>
<span id="cb24-289"><a href="#cb24-289" aria-hidden="true" tabindex="-1"></a>      __Pyx_GOTREF<span class="op">(</span>__pyx_t_4<span class="op">);</span></span>
<span id="cb24-290"><a href="#cb24-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-291"><a href="#cb24-291" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2523</span></span>
<span id="cb24-292"><a href="#cb24-292" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc2Args(self.value,</span></span>
<span id="cb24-293"><a href="#cb24-293" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value,</span></span>
<span id="cb24-294"><a href="#cb24-294" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[1]).value)             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-295"><a href="#cb24-295" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 3:</span></span>
<span id="cb24-296"><a href="#cb24-296" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc3Args(self.value,</span></span>
<span id="cb24-297"><a href="#cb24-297" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-298"><a href="#cb24-298" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_v_a<span class="op">))</span> <span class="op">{</span> __Pyx_RaiseUnboundLocalError<span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">);</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2523</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span> <span class="op">}</span></span>
<span id="cb24-299"><a href="#cb24-299" aria-hidden="true" tabindex="-1"></a>      __pyx_t_5 <span class="op">=</span> __Pyx_GetItemInt_List<span class="op">(</span>__pyx_v_a<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">long</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> __Pyx_PyInt_From_long<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_5<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2523</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span></span>
<span id="cb24-300"><a href="#cb24-300" aria-hidden="true" tabindex="-1"></a>      __Pyx_GOTREF<span class="op">(</span>__pyx_t_5<span class="op">);</span></span>
<span id="cb24-301"><a href="#cb24-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-302"><a href="#cb24-302" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2521</span></span>
<span id="cb24-303"><a href="#cb24-303" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value)</span></span>
<span id="cb24-304"><a href="#cb24-304" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 2:</span></span>
<span id="cb24-305"><a href="#cb24-305" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc2Args(self.value,             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-306"><a href="#cb24-306" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value,</span></span>
<span id="cb24-307"><a href="#cb24-307" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[1]).value)</span></span>
<span id="cb24-308"><a href="#cb24-308" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-309"><a href="#cb24-309" aria-hidden="true" tabindex="-1"></a>      __pyx_v_result <span class="op">=</span> GAP_CallFunc2Args<span class="op">(</span>__pyx_v_self<span class="op">-&gt;</span>__pyx_base<span class="op">.</span>value<span class="op">,</span> <span class="op">((</span><span class="kw">struct</span> __pyx_obj_4sage_4libs_3gap_7element_GapElement <span class="op">*)</span>__pyx_t_4<span class="op">)-&gt;</span>value<span class="op">,</span> <span class="op">((</span><span class="kw">struct</span> __pyx_obj_4sage_4libs_3gap_7element_GapElement <span class="op">*)</span>__pyx_t_5<span class="op">)-&gt;</span>value<span class="op">);</span></span>
<span id="cb24-310"><a href="#cb24-310" aria-hidden="true" tabindex="-1"></a>      __Pyx_DECREF<span class="op">(</span>__pyx_t_4<span class="op">);</span> __pyx_t_4 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-311"><a href="#cb24-311" aria-hidden="true" tabindex="-1"></a>      __Pyx_DECREF<span class="op">(</span>__pyx_t_5<span class="op">);</span> __pyx_t_5 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-312"><a href="#cb24-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-313"><a href="#cb24-313" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2520</span></span>
<span id="cb24-314"><a href="#cb24-314" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc1Args(self.value,</span></span>
<span id="cb24-315"><a href="#cb24-315" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value)</span></span>
<span id="cb24-316"><a href="#cb24-316" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 2:             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-317"><a href="#cb24-317" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc2Args(self.value,</span></span>
<span id="cb24-318"><a href="#cb24-318" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value,</span></span>
<span id="cb24-319"><a href="#cb24-319" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-320"><a href="#cb24-320" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb24-321"><a href="#cb24-321" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">3</span><span class="op">:</span></span>
<span id="cb24-322"><a href="#cb24-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-323"><a href="#cb24-323" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2526</span></span>
<span id="cb24-324"><a href="#cb24-324" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 3:</span></span>
<span id="cb24-325"><a href="#cb24-325" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc3Args(self.value,</span></span>
<span id="cb24-326"><a href="#cb24-326" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value,             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-327"><a href="#cb24-327" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[1]).value,</span></span>
<span id="cb24-328"><a href="#cb24-328" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[2]).value)</span></span>
<span id="cb24-329"><a href="#cb24-329" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-330"><a href="#cb24-330" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_v_a<span class="op">))</span> <span class="op">{</span> __Pyx_RaiseUnboundLocalError<span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">);</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2526</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span> <span class="op">}</span></span>
<span id="cb24-331"><a href="#cb24-331" aria-hidden="true" tabindex="-1"></a>      __pyx_t_5 <span class="op">=</span> __Pyx_GetItemInt_List<span class="op">(</span>__pyx_v_a<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">long</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> __Pyx_PyInt_From_long<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_5<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2526</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span></span>
<span id="cb24-332"><a href="#cb24-332" aria-hidden="true" tabindex="-1"></a>      __Pyx_GOTREF<span class="op">(</span>__pyx_t_5<span class="op">);</span></span>
<span id="cb24-333"><a href="#cb24-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-334"><a href="#cb24-334" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2527</span></span>
<span id="cb24-335"><a href="#cb24-335" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc3Args(self.value,</span></span>
<span id="cb24-336"><a href="#cb24-336" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value,</span></span>
<span id="cb24-337"><a href="#cb24-337" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[1]).value,             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-338"><a href="#cb24-338" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[2]).value)</span></span>
<span id="cb24-339"><a href="#cb24-339" aria-hidden="true" tabindex="-1"></a><span class="co"> *             else:</span></span>
<span id="cb24-340"><a href="#cb24-340" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-341"><a href="#cb24-341" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_v_a<span class="op">))</span> <span class="op">{</span> __Pyx_RaiseUnboundLocalError<span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">);</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2527</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span> <span class="op">}</span></span>
<span id="cb24-342"><a href="#cb24-342" aria-hidden="true" tabindex="-1"></a>      __pyx_t_4 <span class="op">=</span> __Pyx_GetItemInt_List<span class="op">(</span>__pyx_v_a<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">long</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> __Pyx_PyInt_From_long<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_4<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2527</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span></span>
<span id="cb24-343"><a href="#cb24-343" aria-hidden="true" tabindex="-1"></a>      __Pyx_GOTREF<span class="op">(</span>__pyx_t_4<span class="op">);</span></span>
<span id="cb24-344"><a href="#cb24-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-345"><a href="#cb24-345" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2528</span></span>
<span id="cb24-346"><a href="#cb24-346" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value,</span></span>
<span id="cb24-347"><a href="#cb24-347" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[1]).value,</span></span>
<span id="cb24-348"><a href="#cb24-348" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[2]).value)             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-349"><a href="#cb24-349" aria-hidden="true" tabindex="-1"></a><span class="co"> *             else:</span></span>
<span id="cb24-350"><a href="#cb24-350" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 arg_list = make_gap_list(args)</span></span>
<span id="cb24-351"><a href="#cb24-351" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-352"><a href="#cb24-352" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_v_a<span class="op">))</span> <span class="op">{</span> __Pyx_RaiseUnboundLocalError<span class="op">(</span><span class="st">&quot;a&quot;</span><span class="op">);</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2528</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span> <span class="op">}</span></span>
<span id="cb24-353"><a href="#cb24-353" aria-hidden="true" tabindex="-1"></a>      __pyx_t_6 <span class="op">=</span> __Pyx_GetItemInt_List<span class="op">(</span>__pyx_v_a<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">long</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> __Pyx_PyInt_From_long<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_6<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2528</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span></span>
<span id="cb24-354"><a href="#cb24-354" aria-hidden="true" tabindex="-1"></a>      __Pyx_GOTREF<span class="op">(</span>__pyx_t_6<span class="op">);</span></span>
<span id="cb24-355"><a href="#cb24-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-356"><a href="#cb24-356" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2525</span></span>
<span id="cb24-357"><a href="#cb24-357" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[1]).value)</span></span>
<span id="cb24-358"><a href="#cb24-358" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 3:</span></span>
<span id="cb24-359"><a href="#cb24-359" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc3Args(self.value,             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-360"><a href="#cb24-360" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value,</span></span>
<span id="cb24-361"><a href="#cb24-361" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[1]).value,</span></span>
<span id="cb24-362"><a href="#cb24-362" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-363"><a href="#cb24-363" aria-hidden="true" tabindex="-1"></a>      __pyx_v_result <span class="op">=</span> GAP_CallFunc3Args<span class="op">(</span>__pyx_v_self<span class="op">-&gt;</span>__pyx_base<span class="op">.</span>value<span class="op">,</span> <span class="op">((</span><span class="kw">struct</span> __pyx_obj_4sage_4libs_3gap_7element_GapElement <span class="op">*)</span>__pyx_t_5<span class="op">)-&gt;</span>value<span class="op">,</span> <span class="op">((</span><span class="kw">struct</span> __pyx_obj_4sage_4libs_3gap_7element_GapElement <span class="op">*)</span>__pyx_t_4<span class="op">)-&gt;</span>value<span class="op">,</span> <span class="op">((</span><span class="kw">struct</span> __pyx_obj_4sage_4libs_3gap_7element_GapElement <span class="op">*)</span>__pyx_t_6<span class="op">)-&gt;</span>value<span class="op">);</span></span>
<span id="cb24-364"><a href="#cb24-364" aria-hidden="true" tabindex="-1"></a>      __Pyx_DECREF<span class="op">(</span>__pyx_t_5<span class="op">);</span> __pyx_t_5 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-365"><a href="#cb24-365" aria-hidden="true" tabindex="-1"></a>      __Pyx_DECREF<span class="op">(</span>__pyx_t_4<span class="op">);</span> __pyx_t_4 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-366"><a href="#cb24-366" aria-hidden="true" tabindex="-1"></a>      __Pyx_DECREF<span class="op">(</span>__pyx_t_6<span class="op">);</span> __pyx_t_6 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-367"><a href="#cb24-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-368"><a href="#cb24-368" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2524</span></span>
<span id="cb24-369"><a href="#cb24-369" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value,</span></span>
<span id="cb24-370"><a href="#cb24-370" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[1]).value)</span></span>
<span id="cb24-371"><a href="#cb24-371" aria-hidden="true" tabindex="-1"></a><span class="co"> *             elif n == 3:             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-372"><a href="#cb24-372" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFunc3Args(self.value,</span></span>
<span id="cb24-373"><a href="#cb24-373" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[0]).value,</span></span>
<span id="cb24-374"><a href="#cb24-374" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-375"><a href="#cb24-375" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb24-376"><a href="#cb24-376" aria-hidden="true" tabindex="-1"></a>      <span class="cf">default</span><span class="op">:</span></span>
<span id="cb24-377"><a href="#cb24-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-378"><a href="#cb24-378" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2530</span></span>
<span id="cb24-379"><a href="#cb24-379" aria-hidden="true" tabindex="-1"></a><span class="co"> *                                            (&lt;GapElement&gt;a[2]).value)</span></span>
<span id="cb24-380"><a href="#cb24-380" aria-hidden="true" tabindex="-1"></a><span class="co"> *             else:</span></span>
<span id="cb24-381"><a href="#cb24-381" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 arg_list = make_gap_list(args)             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-382"><a href="#cb24-382" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFuncList(self.value, arg_list)</span></span>
<span id="cb24-383"><a href="#cb24-383" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_off()</span></span>
<span id="cb24-384"><a href="#cb24-384" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-385"><a href="#cb24-385" aria-hidden="true" tabindex="-1"></a>      __pyx_t_11 <span class="op">=</span> __pyx_f_4sage_4libs_3gap_7element_make_gap_list<span class="op">(</span>__pyx_v_args<span class="op">);</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(</span>__pyx_t_11 <span class="op">==</span> <span class="op">((</span>Obj<span class="op">)</span>NULL<span class="op">)))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2530</span><span class="op">,</span> __pyx_L14_error<span class="op">)</span></span>
<span id="cb24-386"><a href="#cb24-386" aria-hidden="true" tabindex="-1"></a>      __pyx_v_arg_list <span class="op">=</span> __pyx_t_11<span class="op">;</span></span>
<span id="cb24-387"><a href="#cb24-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-388"><a href="#cb24-388" aria-hidden="true" tabindex="-1"></a>      <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2531</span></span>
<span id="cb24-389"><a href="#cb24-389" aria-hidden="true" tabindex="-1"></a><span class="co"> *             else:</span></span>
<span id="cb24-390"><a href="#cb24-390" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 arg_list = make_gap_list(args)</span></span>
<span id="cb24-391"><a href="#cb24-391" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFuncList(self.value, arg_list)             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-392"><a href="#cb24-392" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_off()</span></span>
<span id="cb24-393"><a href="#cb24-393" aria-hidden="true" tabindex="-1"></a><span class="co"> *         finally:</span></span>
<span id="cb24-394"><a href="#cb24-394" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-395"><a href="#cb24-395" aria-hidden="true" tabindex="-1"></a>      __pyx_v_result <span class="op">=</span> GAP_CallFuncList<span class="op">(</span>__pyx_v_self<span class="op">-&gt;</span>__pyx_base<span class="op">.</span>value<span class="op">,</span> __pyx_v_arg_list<span class="op">);</span></span>
<span id="cb24-396"><a href="#cb24-396" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb24-397"><a href="#cb24-397" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-398"><a href="#cb24-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-399"><a href="#cb24-399" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2532</span></span>
<span id="cb24-400"><a href="#cb24-400" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 arg_list = make_gap_list(args)</span></span>
<span id="cb24-401"><a href="#cb24-401" aria-hidden="true" tabindex="-1"></a><span class="co"> *                 result = GAP_CallFuncList(self.value, arg_list)</span></span>
<span id="cb24-402"><a href="#cb24-402" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_off()             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-403"><a href="#cb24-403" aria-hidden="true" tabindex="-1"></a><span class="co"> *         finally:</span></span>
<span id="cb24-404"><a href="#cb24-404" aria-hidden="true" tabindex="-1"></a><span class="co"> *             GAP_Leave()</span></span>
<span id="cb24-405"><a href="#cb24-405" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-406"><a href="#cb24-406" aria-hidden="true" tabindex="-1"></a>    sig_off<span class="op">();</span></span>
<span id="cb24-407"><a href="#cb24-407" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb24-408"><a href="#cb24-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-409"><a href="#cb24-409" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2534</span></span>
<span id="cb24-410"><a href="#cb24-410" aria-hidden="true" tabindex="-1"></a><span class="co"> *             sig_off()</span></span>
<span id="cb24-411"><a href="#cb24-411" aria-hidden="true" tabindex="-1"></a><span class="co"> *         finally:</span></span>
<span id="cb24-412"><a href="#cb24-412" aria-hidden="true" tabindex="-1"></a><span class="co"> *             GAP_Leave()             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-413"><a href="#cb24-413" aria-hidden="true" tabindex="-1"></a><span class="co"> *         if result == NULL:</span></span>
<span id="cb24-414"><a href="#cb24-414" aria-hidden="true" tabindex="-1"></a><span class="co"> *             # We called a procedure that does not return anything</span></span>
<span id="cb24-415"><a href="#cb24-415" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-416"><a href="#cb24-416" aria-hidden="true" tabindex="-1"></a>  <span class="co">/*finally:*/</span> <span class="op">{</span></span>
<span id="cb24-417"><a href="#cb24-417" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*normal exit:*/</span><span class="op">{</span></span>
<span id="cb24-418"><a href="#cb24-418" aria-hidden="true" tabindex="-1"></a>      GAP_Leave<span class="op">();</span></span>
<span id="cb24-419"><a href="#cb24-419" aria-hidden="true" tabindex="-1"></a>      <span class="cf">goto</span> __pyx_L15<span class="op">;</span></span>
<span id="cb24-420"><a href="#cb24-420" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-421"><a href="#cb24-421" aria-hidden="true" tabindex="-1"></a>    __pyx_L14_error<span class="op">:;</span></span>
<span id="cb24-422"><a href="#cb24-422" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*exception exit:*/</span><span class="op">{</span></span>
<span id="cb24-423"><a href="#cb24-423" aria-hidden="true" tabindex="-1"></a>      __Pyx_PyThreadState_declare</span>
<span id="cb24-424"><a href="#cb24-424" aria-hidden="true" tabindex="-1"></a>      __Pyx_PyThreadState_assign</span>
<span id="cb24-425"><a href="#cb24-425" aria-hidden="true" tabindex="-1"></a>      __pyx_t_14 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> __pyx_t_15 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> __pyx_t_16 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> __pyx_t_17 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> __pyx_t_18 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> __pyx_t_19 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-426"><a href="#cb24-426" aria-hidden="true" tabindex="-1"></a>      __Pyx_XDECREF<span class="op">(</span>__pyx_t_10<span class="op">);</span> __pyx_t_10 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-427"><a href="#cb24-427" aria-hidden="true" tabindex="-1"></a>      __Pyx_XDECREF<span class="op">(</span>__pyx_t_4<span class="op">);</span> __pyx_t_4 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-428"><a href="#cb24-428" aria-hidden="true" tabindex="-1"></a>      __Pyx_XDECREF<span class="op">(</span>__pyx_t_5<span class="op">);</span> __pyx_t_5 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-429"><a href="#cb24-429" aria-hidden="true" tabindex="-1"></a>      __Pyx_XDECREF<span class="op">(</span>__pyx_t_6<span class="op">);</span> __pyx_t_6 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-430"><a href="#cb24-430" aria-hidden="true" tabindex="-1"></a>      __Pyx_XDECREF<span class="op">(</span>__pyx_t_8<span class="op">);</span> __pyx_t_8 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-431"><a href="#cb24-431" aria-hidden="true" tabindex="-1"></a>      __Pyx_XDECREF<span class="op">(</span>__pyx_t_9<span class="op">);</span> __pyx_t_9 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-432"><a href="#cb24-432" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>PY_MAJOR_VERSION <span class="op">&gt;=</span> <span class="dv">3</span><span class="op">)</span> __Pyx_ExceptionSwap<span class="op">(&amp;</span>__pyx_t_17<span class="op">,</span> <span class="op">&amp;</span>__pyx_t_18<span class="op">,</span> <span class="op">&amp;</span>__pyx_t_19<span class="op">);</span></span>
<span id="cb24-433"><a href="#cb24-433" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">((</span>PY_MAJOR_VERSION <span class="op">&lt;</span> <span class="dv">3</span><span class="op">)</span> <span class="op">||</span> unlikely<span class="op">(</span>__Pyx_GetException<span class="op">(&amp;</span>__pyx_t_14<span class="op">,</span> <span class="op">&amp;</span>__pyx_t_15<span class="op">,</span> <span class="op">&amp;</span>__pyx_t_16<span class="op">)</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">))</span> __Pyx_ErrFetch<span class="op">(&amp;</span>__pyx_t_14<span class="op">,</span> <span class="op">&amp;</span>__pyx_t_15<span class="op">,</span> <span class="op">&amp;</span>__pyx_t_16<span class="op">);</span></span>
<span id="cb24-434"><a href="#cb24-434" aria-hidden="true" tabindex="-1"></a>      __Pyx_XGOTREF<span class="op">(</span>__pyx_t_14<span class="op">);</span></span>
<span id="cb24-435"><a href="#cb24-435" aria-hidden="true" tabindex="-1"></a>      __Pyx_XGOTREF<span class="op">(</span>__pyx_t_15<span class="op">);</span></span>
<span id="cb24-436"><a href="#cb24-436" aria-hidden="true" tabindex="-1"></a>      __Pyx_XGOTREF<span class="op">(</span>__pyx_t_16<span class="op">);</span></span>
<span id="cb24-437"><a href="#cb24-437" aria-hidden="true" tabindex="-1"></a>      __Pyx_XGOTREF<span class="op">(</span>__pyx_t_17<span class="op">);</span></span>
<span id="cb24-438"><a href="#cb24-438" aria-hidden="true" tabindex="-1"></a>      __Pyx_XGOTREF<span class="op">(</span>__pyx_t_18<span class="op">);</span></span>
<span id="cb24-439"><a href="#cb24-439" aria-hidden="true" tabindex="-1"></a>      __Pyx_XGOTREF<span class="op">(</span>__pyx_t_19<span class="op">);</span></span>
<span id="cb24-440"><a href="#cb24-440" aria-hidden="true" tabindex="-1"></a>      __pyx_t_7 <span class="op">=</span> __pyx_lineno<span class="op">;</span> __pyx_t_12 <span class="op">=</span> __pyx_clineno<span class="op">;</span> __pyx_t_13 <span class="op">=</span> __pyx_filename<span class="op">;</span></span>
<span id="cb24-441"><a href="#cb24-441" aria-hidden="true" tabindex="-1"></a>      <span class="op">{</span></span>
<span id="cb24-442"><a href="#cb24-442" aria-hidden="true" tabindex="-1"></a>        GAP_Leave<span class="op">();</span></span>
<span id="cb24-443"><a href="#cb24-443" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb24-444"><a href="#cb24-444" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>PY_MAJOR_VERSION <span class="op">&gt;=</span> <span class="dv">3</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-445"><a href="#cb24-445" aria-hidden="true" tabindex="-1"></a>        __Pyx_XGIVEREF<span class="op">(</span>__pyx_t_17<span class="op">);</span></span>
<span id="cb24-446"><a href="#cb24-446" aria-hidden="true" tabindex="-1"></a>        __Pyx_XGIVEREF<span class="op">(</span>__pyx_t_18<span class="op">);</span></span>
<span id="cb24-447"><a href="#cb24-447" aria-hidden="true" tabindex="-1"></a>        __Pyx_XGIVEREF<span class="op">(</span>__pyx_t_19<span class="op">);</span></span>
<span id="cb24-448"><a href="#cb24-448" aria-hidden="true" tabindex="-1"></a>        __Pyx_ExceptionReset<span class="op">(</span>__pyx_t_17<span class="op">,</span> __pyx_t_18<span class="op">,</span> __pyx_t_19<span class="op">);</span></span>
<span id="cb24-449"><a href="#cb24-449" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb24-450"><a href="#cb24-450" aria-hidden="true" tabindex="-1"></a>      __Pyx_XGIVEREF<span class="op">(</span>__pyx_t_14<span class="op">);</span></span>
<span id="cb24-451"><a href="#cb24-451" aria-hidden="true" tabindex="-1"></a>      __Pyx_XGIVEREF<span class="op">(</span>__pyx_t_15<span class="op">);</span></span>
<span id="cb24-452"><a href="#cb24-452" aria-hidden="true" tabindex="-1"></a>      __Pyx_XGIVEREF<span class="op">(</span>__pyx_t_16<span class="op">);</span></span>
<span id="cb24-453"><a href="#cb24-453" aria-hidden="true" tabindex="-1"></a>      __Pyx_ErrRestore<span class="op">(</span>__pyx_t_14<span class="op">,</span> __pyx_t_15<span class="op">,</span> __pyx_t_16<span class="op">);</span></span>
<span id="cb24-454"><a href="#cb24-454" aria-hidden="true" tabindex="-1"></a>      __pyx_t_14 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> __pyx_t_15 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> __pyx_t_16 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> __pyx_t_17 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> __pyx_t_18 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> __pyx_t_19 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-455"><a href="#cb24-455" aria-hidden="true" tabindex="-1"></a>      __pyx_lineno <span class="op">=</span> __pyx_t_7<span class="op">;</span> __pyx_clineno <span class="op">=</span> __pyx_t_12<span class="op">;</span> __pyx_filename <span class="op">=</span> __pyx_t_13<span class="op">;</span></span>
<span id="cb24-456"><a href="#cb24-456" aria-hidden="true" tabindex="-1"></a>      <span class="cf">goto</span> __pyx_L1_error<span class="op">;</span></span>
<span id="cb24-457"><a href="#cb24-457" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-458"><a href="#cb24-458" aria-hidden="true" tabindex="-1"></a>    __pyx_L15<span class="op">:;</span></span>
<span id="cb24-459"><a href="#cb24-459" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb24-460"><a href="#cb24-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-461"><a href="#cb24-461" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2535</span></span>
<span id="cb24-462"><a href="#cb24-462" aria-hidden="true" tabindex="-1"></a><span class="co"> *         finally:</span></span>
<span id="cb24-463"><a href="#cb24-463" aria-hidden="true" tabindex="-1"></a><span class="co"> *             GAP_Leave()</span></span>
<span id="cb24-464"><a href="#cb24-464" aria-hidden="true" tabindex="-1"></a><span class="co"> *         if result == NULL:             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-465"><a href="#cb24-465" aria-hidden="true" tabindex="-1"></a><span class="co"> *             # We called a procedure that does not return anything</span></span>
<span id="cb24-466"><a href="#cb24-466" aria-hidden="true" tabindex="-1"></a><span class="co"> *             return None</span></span>
<span id="cb24-467"><a href="#cb24-467" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-468"><a href="#cb24-468" aria-hidden="true" tabindex="-1"></a>  __pyx_t_2 <span class="op">=</span> <span class="op">(</span>__pyx_v_result <span class="op">==</span> NULL<span class="op">);</span></span>
<span id="cb24-469"><a href="#cb24-469" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>__pyx_t_2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb24-470"><a href="#cb24-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-471"><a href="#cb24-471" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2537</span></span>
<span id="cb24-472"><a href="#cb24-472" aria-hidden="true" tabindex="-1"></a><span class="co"> *         if result == NULL:</span></span>
<span id="cb24-473"><a href="#cb24-473" aria-hidden="true" tabindex="-1"></a><span class="co"> *             # We called a procedure that does not return anything</span></span>
<span id="cb24-474"><a href="#cb24-474" aria-hidden="true" tabindex="-1"></a><span class="co"> *             return None             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-475"><a href="#cb24-475" aria-hidden="true" tabindex="-1"></a><span class="co"> *         return make_any_gap_element(self.parent(), result)</span></span>
<span id="cb24-476"><a href="#cb24-476" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb24-477"><a href="#cb24-477" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-478"><a href="#cb24-478" aria-hidden="true" tabindex="-1"></a>    __Pyx_XDECREF<span class="op">(</span>__pyx_r<span class="op">);</span></span>
<span id="cb24-479"><a href="#cb24-479" aria-hidden="true" tabindex="-1"></a>    __pyx_r <span class="op">=</span> Py_None<span class="op">;</span> __Pyx_INCREF<span class="op">(</span>Py_None<span class="op">);</span></span>
<span id="cb24-480"><a href="#cb24-480" aria-hidden="true" tabindex="-1"></a>    <span class="cf">goto</span> __pyx_L0<span class="op">;</span></span>
<span id="cb24-481"><a href="#cb24-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-482"><a href="#cb24-482" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2535</span></span>
<span id="cb24-483"><a href="#cb24-483" aria-hidden="true" tabindex="-1"></a><span class="co"> *         finally:</span></span>
<span id="cb24-484"><a href="#cb24-484" aria-hidden="true" tabindex="-1"></a><span class="co"> *             GAP_Leave()</span></span>
<span id="cb24-485"><a href="#cb24-485" aria-hidden="true" tabindex="-1"></a><span class="co"> *         if result == NULL:             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-486"><a href="#cb24-486" aria-hidden="true" tabindex="-1"></a><span class="co"> *             # We called a procedure that does not return anything</span></span>
<span id="cb24-487"><a href="#cb24-487" aria-hidden="true" tabindex="-1"></a><span class="co"> *             return None</span></span>
<span id="cb24-488"><a href="#cb24-488" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-489"><a href="#cb24-489" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb24-490"><a href="#cb24-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-491"><a href="#cb24-491" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2538</span></span>
<span id="cb24-492"><a href="#cb24-492" aria-hidden="true" tabindex="-1"></a><span class="co"> *             # We called a procedure that does not return anything</span></span>
<span id="cb24-493"><a href="#cb24-493" aria-hidden="true" tabindex="-1"></a><span class="co"> *             return None</span></span>
<span id="cb24-494"><a href="#cb24-494" aria-hidden="true" tabindex="-1"></a><span class="co"> *         return make_any_gap_element(self.parent(), result)             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-495"><a href="#cb24-495" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb24-496"><a href="#cb24-496" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb24-497"><a href="#cb24-497" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-498"><a href="#cb24-498" aria-hidden="true" tabindex="-1"></a>  __Pyx_XDECREF<span class="op">(</span>__pyx_r<span class="op">);</span></span>
<span id="cb24-499"><a href="#cb24-499" aria-hidden="true" tabindex="-1"></a>  __pyx_t_4 <span class="op">=</span> __Pyx_PyObject_GetAttrStr<span class="op">(((</span>PyObject <span class="op">*)</span>__pyx_v_self<span class="op">),</span> __pyx_n_s_parent<span class="op">);</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_4<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2538</span><span class="op">,</span> __pyx_L1_error<span class="op">)</span></span>
<span id="cb24-500"><a href="#cb24-500" aria-hidden="true" tabindex="-1"></a>  __Pyx_GOTREF<span class="op">(</span>__pyx_t_4<span class="op">);</span></span>
<span id="cb24-501"><a href="#cb24-501" aria-hidden="true" tabindex="-1"></a>  __pyx_t_5 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-502"><a href="#cb24-502" aria-hidden="true" tabindex="-1"></a>  __pyx_t_12 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-503"><a href="#cb24-503" aria-hidden="true" tabindex="-1"></a>  <span class="pp">#if CYTHON_UNPACK_METHODS</span></span>
<span id="cb24-504"><a href="#cb24-504" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>likely<span class="op">(</span>PyMethod_Check<span class="op">(</span>__pyx_t_4<span class="op">)))</span> <span class="op">{</span></span>
<span id="cb24-505"><a href="#cb24-505" aria-hidden="true" tabindex="-1"></a>    __pyx_t_5 <span class="op">=</span> PyMethod_GET_SELF<span class="op">(</span>__pyx_t_4<span class="op">);</span></span>
<span id="cb24-506"><a href="#cb24-506" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>likely<span class="op">(</span>__pyx_t_5<span class="op">))</span> <span class="op">{</span></span>
<span id="cb24-507"><a href="#cb24-507" aria-hidden="true" tabindex="-1"></a>      PyObject<span class="op">*</span> function <span class="op">=</span> PyMethod_GET_FUNCTION<span class="op">(</span>__pyx_t_4<span class="op">);</span></span>
<span id="cb24-508"><a href="#cb24-508" aria-hidden="true" tabindex="-1"></a>      __Pyx_INCREF<span class="op">(</span>__pyx_t_5<span class="op">);</span></span>
<span id="cb24-509"><a href="#cb24-509" aria-hidden="true" tabindex="-1"></a>      __Pyx_INCREF<span class="op">(</span>function<span class="op">);</span></span>
<span id="cb24-510"><a href="#cb24-510" aria-hidden="true" tabindex="-1"></a>      __Pyx_DECREF_SET<span class="op">(</span>__pyx_t_4<span class="op">,</span> function<span class="op">);</span></span>
<span id="cb24-511"><a href="#cb24-511" aria-hidden="true" tabindex="-1"></a>      __pyx_t_12 <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb24-512"><a href="#cb24-512" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb24-513"><a href="#cb24-513" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb24-514"><a href="#cb24-514" aria-hidden="true" tabindex="-1"></a>  <span class="pp">#endif</span></span>
<span id="cb24-515"><a href="#cb24-515" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb24-516"><a href="#cb24-516" aria-hidden="true" tabindex="-1"></a>    PyObject <span class="op">*</span>__pyx_callargs<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> <span class="op">{</span>__pyx_t_5<span class="op">,</span> NULL<span class="op">};</span></span>
<span id="cb24-517"><a href="#cb24-517" aria-hidden="true" tabindex="-1"></a>    __pyx_t_6 <span class="op">=</span> __Pyx_PyObject_FastCall<span class="op">(</span>__pyx_t_4<span class="op">,</span> __pyx_callargs<span class="op">+</span><span class="dv">1</span><span class="op">-</span>__pyx_t_12<span class="op">,</span> <span class="dv">0</span><span class="op">+</span>__pyx_t_12<span class="op">);</span></span>
<span id="cb24-518"><a href="#cb24-518" aria-hidden="true" tabindex="-1"></a>    __Pyx_XDECREF<span class="op">(</span>__pyx_t_5<span class="op">);</span> __pyx_t_5 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-519"><a href="#cb24-519" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_6<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2538</span><span class="op">,</span> __pyx_L1_error<span class="op">)</span></span>
<span id="cb24-520"><a href="#cb24-520" aria-hidden="true" tabindex="-1"></a>    __Pyx_GOTREF<span class="op">(</span>__pyx_t_6<span class="op">);</span></span>
<span id="cb24-521"><a href="#cb24-521" aria-hidden="true" tabindex="-1"></a>    __Pyx_DECREF<span class="op">(</span>__pyx_t_4<span class="op">);</span> __pyx_t_4 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-522"><a href="#cb24-522" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb24-523"><a href="#cb24-523" aria-hidden="true" tabindex="-1"></a>  __pyx_t_4 <span class="op">=</span> <span class="op">((</span>PyObject <span class="op">*)</span>__pyx_f_4sage_4libs_3gap_7element_make_any_gap_element<span class="op">(</span>__pyx_t_6<span class="op">,</span> __pyx_v_result<span class="op">));</span> <span class="cf">if</span> <span class="op">(</span>unlikely<span class="op">(!</span>__pyx_t_4<span class="op">))</span> __PYX_ERR<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">2538</span><span class="op">,</span> __pyx_L1_error<span class="op">)</span></span>
<span id="cb24-524"><a href="#cb24-524" aria-hidden="true" tabindex="-1"></a>  __Pyx_GOTREF<span class="op">(</span>__pyx_t_4<span class="op">);</span></span>
<span id="cb24-525"><a href="#cb24-525" aria-hidden="true" tabindex="-1"></a>  __Pyx_DECREF<span class="op">(</span>__pyx_t_6<span class="op">);</span> __pyx_t_6 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-526"><a href="#cb24-526" aria-hidden="true" tabindex="-1"></a>  __pyx_r <span class="op">=</span> __pyx_t_4<span class="op">;</span></span>
<span id="cb24-527"><a href="#cb24-527" aria-hidden="true" tabindex="-1"></a>  __pyx_t_4 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb24-528"><a href="#cb24-528" aria-hidden="true" tabindex="-1"></a>  <span class="cf">goto</span> __pyx_L0<span class="op">;</span></span>
<span id="cb24-529"><a href="#cb24-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-530"><a href="#cb24-530" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* &quot;sage/libs/gap/element.pyx&quot;:2412</span></span>
<span id="cb24-531"><a href="#cb24-531" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb24-532"><a href="#cb24-532" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span></span>
<span id="cb24-533"><a href="#cb24-533" aria-hidden="true" tabindex="-1"></a><span class="co"> *     def __call__(self, *args):             # &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span></span>
<span id="cb24-534"><a href="#cb24-534" aria-hidden="true" tabindex="-1"></a><span class="co"> *         &quot;&quot;&quot;</span></span>
<span id="cb24-535"><a href="#cb24-535" aria-hidden="true" tabindex="-1"></a><span class="co"> *         Call syntax for functions.</span></span>
<span id="cb24-536"><a href="#cb24-536" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb24-537"><a href="#cb24-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-538"><a href="#cb24-538" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* function exit code */</span></span>
<span id="cb24-539"><a href="#cb24-539" aria-hidden="true" tabindex="-1"></a>  __pyx_L1_error<span class="op">:;</span></span>
<span id="cb24-540"><a href="#cb24-540" aria-hidden="true" tabindex="-1"></a>  __Pyx_XDECREF<span class="op">(</span>__pyx_t_4<span class="op">);</span></span>
<span id="cb24-541"><a href="#cb24-541" aria-hidden="true" tabindex="-1"></a>  __Pyx_XDECREF<span class="op">(</span>__pyx_t_5<span class="op">);</span></span>
<span id="cb24-542"><a href="#cb24-542" aria-hidden="true" tabindex="-1"></a>  __Pyx_XDECREF<span class="op">(</span>__pyx_t_6<span class="op">);</span></span>
<span id="cb24-543"><a href="#cb24-543" aria-hidden="true" tabindex="-1"></a>  __Pyx_XDECREF<span class="op">(</span>__pyx_t_8<span class="op">);</span></span>
<span id="cb24-544"><a href="#cb24-544" aria-hidden="true" tabindex="-1"></a>  __Pyx_XDECREF<span class="op">(</span>__pyx_t_9<span class="op">);</span></span>
<span id="cb24-545"><a href="#cb24-545" aria-hidden="true" tabindex="-1"></a>  __Pyx_XDECREF<span class="op">(</span>__pyx_t_10<span class="op">);</span></span>
<span id="cb24-546"><a href="#cb24-546" aria-hidden="true" tabindex="-1"></a>  __Pyx_AddTraceback<span class="op">(</span><span class="st">&quot;sage.libs.gap.element.GapElement_Function.__call__&quot;</span><span class="op">,</span> __pyx_clineno<span class="op">,</span> __pyx_lineno<span class="op">,</span> __pyx_filename<span class="op">);</span></span>
<span id="cb24-547"><a href="#cb24-547" aria-hidden="true" tabindex="-1"></a>  __pyx_r <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb24-548"><a href="#cb24-548" aria-hidden="true" tabindex="-1"></a>  __pyx_L0<span class="op">:;</span></span>
<span id="cb24-549"><a href="#cb24-549" aria-hidden="true" tabindex="-1"></a>  __Pyx_XDECREF<span class="op">(</span>__pyx_v_libgap<span class="op">);</span></span>
<span id="cb24-550"><a href="#cb24-550" aria-hidden="true" tabindex="-1"></a>  __Pyx_XDECREF<span class="op">(</span>__pyx_v_a<span class="op">);</span></span>
<span id="cb24-551"><a href="#cb24-551" aria-hidden="true" tabindex="-1"></a>  __Pyx_XDECREF<span class="op">(</span>__pyx_8genexpr3__pyx_v_x<span class="op">);</span></span>
<span id="cb24-552"><a href="#cb24-552" aria-hidden="true" tabindex="-1"></a>  __Pyx_XGIVEREF<span class="op">(</span>__pyx_r<span class="op">);</span></span>
<span id="cb24-553"><a href="#cb24-553" aria-hidden="true" tabindex="-1"></a>  __Pyx_RefNannyFinishContext<span class="op">();</span></span>
<span id="cb24-554"><a href="#cb24-554" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> __pyx_r<span class="op">;</span></span>
<span id="cb24-555"><a href="#cb24-555" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>cython</code> does a great job annotating generated code with corresponding
source code. Very useful! While it’s a lot of boilerplate the code is
straightforward. A few important facts:</p>
<ol type="1">
<li><code>sig_GAP_Enter()</code> is our <code>setjmp()</code> in disguise of a few
macros defined at the beginning of the file. You can’t see <code>longjmp()</code>
calls here but they are lurking in various <code>GAP_CallFunc3Args()</code> calls.</li>
<li>There is a ton of local variables being updated in this file. And
none of them has <code>volatile</code> annotations.</li>
</ol>
<p>The above strongly suggests we are hitting a <code>volatile</code> <code>setjmp()</code>
<code>CAVEAT</code>. But how to find out for sure?</p>
<h2 id="nailing-down-the-specific-variable-corruption">Nailing down the specific variable corruption</h2>
<p>The general “missing <code>volatile</code>” hint is a bit abstract. Is it easy to
find out what variable is being corrupted here? The <code>gdb</code> is
surprisingly useful here. Let’s look at our <code>SIGSEGV</code> again:</p>
<pre><code>(gdb) bt
#0  0x00007feb544b756f in _Py_IsImmortal (op=0x0) at /usr/include/python3.12/object.h:242
#1  Py_DECREF (op=0x0) at /usr/include/python3.12/object.h:700
#2  Py_XDECREF (op=0x0) at /usr/include/python3.12/object.h:798
#3  __pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__ (
    __pyx_v_self=__pyx_v_self@entry=0x7feb4e274f40,
    __pyx_v_args=__pyx_v_args@entry=(&lt;sage.rings.integer.Integer at remote 0x7feb533456e0&gt;, &lt;sage.rings.integer.Integer at remote 0x7feb4e5dd8c0&gt;, &lt;sage.rings.integer.Integer at remote 0x7feb4e5dd620&gt;))
    at /usr/src/debug/sci-mathematics/sagemath-standard-10.3/sagemath-standard-10.3-python3_12/build/cythonized/sage/libs/gap/element.c:26535
#4  0x00007feb544b84e7 in __pyx_pw_4sage_4libs_3gap_7element_19GapElement_Function_3__call__ (
    __pyx_v_self=&lt;sage.libs.gap.element.GapElement_Function at remote 0x7feb4e274f40&gt;,
    __pyx_args=(&lt;sage.rings.integer.Integer at remote 0x7feb533456e0&gt;, &lt;sage.rings.integer.Integer at remote 0x7feb4e5dd8c0&gt;, &lt;sage.rings.integer.Integer at remote 0x7feb4e5dd620&gt;),
    __pyx_kwds=&lt;optimized out&gt;)
    at /usr/src/debug/sci-mathematics/sagemath-standard-10.3/sagemath-standard-10.3-python3_12/build/cythonized/sage/libs/gap/element.c:26105</code></pre>
<p>Our function is in <code>frame 3</code> right now. Let’s look at it:</p>
<pre><code>(gdb) fr 3
#3  __pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__ (
    __pyx_v_self=__pyx_v_self@entry=0x7feb4e274f40,
    __pyx_v_args=__pyx_v_args@entry=(&lt;sage.rings.integer.Integer at remote 0x7feb533456e0&gt;, &lt;sage.rings.integer.Integer at remote 0x7feb4e5dd8c0&gt;, &lt;sage.rings.integer.Integer at remote 0x7feb4e5dd620&gt;))
    at /usr/src/debug/sci-mathematics/sagemath-standard-10.3/sagemath-standard-10.3-python3_12/build/cythonized/sage/libs/gap/element.c:26535
list
26535         __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;</code></pre>
<p><code>__Pyx_XDECREF()</code> looks promising.</p>
<pre><code>(gdb) list
26530         __Pyx_PyThreadState_assign
26531         __pyx_t_14 = 0; __pyx_t_15 = 0; __pyx_t_16 = 0; __pyx_t_17 = 0; __pyx_t_18 = 0; __pyx_t_19 = 0;
26532         __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
26533         __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
26534         __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
26535         __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
26536         __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
26537         __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
26538         if (PY_MAJOR_VERSION &gt;= 3) __Pyx_ExceptionSwap(&amp;__pyx_t_17, &amp;__pyx_t_18, &amp;__pyx_t_19);
26539         if ((PY_MAJOR_VERSION &lt; 3) || unlikely(__Pyx_GetException(&amp;__pyx_t_14, &amp;__pyx_t_15, &amp;__pyx_t_16) &lt; 0)) __Pyx_ErrFetch(&amp;__pyx_t_14, &amp;__pyx_t_15, &amp;__pyx_t_16);</code></pre>
<p><code>gdb</code> says that crash happens at line
<code>26535 __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;</code>. Thus, <code>__pyx_t_6 = 0;</code>
is our primary suspect.</p>
<p>To trace the life of <code>__pyx_t_6</code> in assembly code I built <code>element.c</code>
with extra <code>-S -fverbose-asm</code> flags and got this tiny snippet of variable
reference:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a># /usr<span class="op">/</span>include<span class="op">/</span>python3<span class="op">.</span><span class="dv">12</span><span class="op">/</span>object<span class="op">.</span>h<span class="op">:</span><span class="dv">242</span><span class="op">:</span>     return _Py_CAST<span class="op">(</span>PY_INT32_T<span class="op">,</span> op<span class="op">-&gt;</span>ob_refcnt<span class="op">)</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="co">;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    .loc <span class="dv">5</span> <span class="dv">242</span> <span class="dv">12</span> is_stmt <span class="dv">0</span> view <span class="op">.</span>LVU66168</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span> <span class="op">-</span><span class="dv">200</span><span class="op">(%</span><span class="kw">rbp</span><span class="op">),</span> <span class="op">%</span><span class="kw">rdx</span> <span class="op">#</span> <span class="op">%</span>sfp<span class="op">,</span> r</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">movq</span> <span class="op">(%</span><span class="kw">rdx</span><span class="op">),</span> <span class="op">%</span><span class="kw">rax</span> <span class="op">#</span> __pyx_t_6_10<span class="op">(</span>ab<span class="op">)-&gt;</span>D<span class="op">.</span><span class="fl">11083.</span><span class="er">ob_refcnt</span><span class="op">,</span> _1070</span></code></pre></div>
<p>It’s the first few instructions of <code>__Pyx_XDECREF()</code> implementation.
The main takeaway here is that <code>__pyx_t_6</code> is stored on stack at the
address <code>%rbp-200</code>. We can trace all the updates at that location and
see what is missing.
Before doing that I navigated to the beginning of crashing
<code>__pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__</code>
function as:</p>
<pre><code>$ gdb -p `pgrep sage-ipython`
(gdb) break __pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__
(gdb) continue

    # trigger break with with ` libgap.AbelianGroup(0,0,0)`

(gdb) disassemble
Dump of assembler code for function __pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__:
=&gt; 0x00007f4ed9981b60 &lt;+0&gt;:     push   %rbp
   0x00007f4ed9981b61 &lt;+1&gt;:     mov    %rsp,%rbp</code></pre>
<p>And then executed first two instructions to initialize <code>%rbp</code>
register (as our variable lives at a constant offset from <code>%rbp</code> on
stack):</p>
<pre><code>(gdb) nexti
(gdb) nexti
(gdb) disassemble
Dump of assembler code for function __pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__:
   0x00007f4ed9981b60 &lt;+0&gt;:     push   %rbp
   0x00007f4ed9981b61 &lt;+1&gt;:     mov    %rsp,%rbp
=&gt; 0x00007f4ed9981b64 &lt;+4&gt;:     push   %r15</code></pre>
<p>Now I set the watch point at stack memory where we expect <code>__pyx_t_6</code> to
reside:</p>
<pre><code>(gdb) print $rbp-200
$2 = (void *) 0x7ffd2824c5e8

(gdb) watch *(int*)(void *) 0x7ffd2824c5e8
Hardware watchpoint 2: *(int*)(void *) 0x7ffd2824c5e8

(gdb) continue
Continuing.

Thread 1 &quot;sage-ipython&quot; hit Hardware watchpoint 2: *(int*)(void *) 0x7ffd2824c5e8

Old value = 673498624
New value = 0
0x00007f98e609d2a8 in __pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__ (
    __pyx_v_self=__pyx_v_self@entry=0x7f98dfe70dc0,
    __pyx_v_args=__pyx_v_args@entry=(&lt;sage.rings.integer.Integer at remote 0x7f98e4722c40&gt;, &lt;sage.rings.integer.Integer at remote 0x7f98dfe7afd0&gt;, &lt;sage.rings.integer.Integer at remote 0x7f98e01dd5c0&gt;))
    at /usr/src/debug/sci-mathematics/sagemath-standard-10.3/sagemath-standard-10.3-python3_12/build/cythonized/sage/libs/gap/element.c:26192
26192       __pyx_t_6 = NULL;</code></pre>
<p>This break is our initial <code>__pyx_t_6 = NULL;</code> store. Nothing unusual.
Moving to the next update:</p>
<pre><code>(gdb) continue
Continuing.

Thread 1 &quot;sage-ipython&quot; hit Hardware watchpoint 2: *(int*)(void *) 0x7ffd2824c5e8

Old value = 0
New value = -538669696
__Pyx_GetItemInt_List_Fast (wraparound=0, boundscheck=1, i=2,
    o=[&lt;sage.libs.gap.element.GapElement_Integer at remote 0x7f98e0ac5c00&gt;, &lt;sage.libs.gap.element.GapElement_Integer at remote 0x7f98dfe4b500&gt;, &lt;sage.libs.gap.element.GapElement_Integer at remote 0x7f98dfe48d80&gt;])
    at /usr/src/debug/sci-mathematics/sagemath-standard-10.3/sagemath-standard-10.3-python3_12/build/cythonized/sage/libs/gap/element.c:38070
38070           Py_INCREF(r);</code></pre>
<p>Here we create an object and increment a reference via <code>__pyx_t_6</code> address.
Moving on:</p>
<pre><code>(gdb) continue
Continuing.

Thread 1 &quot;sage-ipython&quot; received signal SIGABRT, Aborted.
0x00007f99428617a7 in __GI_kill () at ../sysdeps/unix/syscall-template.S:120
120     T_PSEUDO (SYSCALL_SYMBOL, SYSCALL_NAME, SYSCALL_NARGS)</code></pre>
<p>Got to <code>SIGABRT</code> signal, <code>longjmp()</code> is about to be called. Moving on.</p>
<pre><code>(gdb) continue
Continuing.

Thread 1 &quot;sage-ipython&quot; received signal SIGSEGV, Segmentation fault.
0x00007f98e609c56f in _Py_IsImmortal (op=0x0) at /usr/include/python3.12/object.h:242
242         return _Py_CAST(PY_INT32_T, op-&gt;ob_refcnt) &lt; 0;</code></pre>
<p>We arrived at a final <code>SIGSEGV</code> signal.
Curiously we see only two stores (one <code>NULL</code> store and one
non-<code>NULL</code> store) at inspected address. Both are before the <code>SIGABRT</code>
signal (and thus <code>longjmp()</code> call). I was initially afraid that stack
got corrupted by stack reuse in nested functions. But it’s not the case
and our case is a lot simpler than it could be. Phew.
This session allowed me to finally understand the control flow happening
here.</p>
<h2 id="sagemath-breakage-mechanics"><code>sagemath</code> breakage mechanics</h2>
<p>Armed with <code>__pyx_t_6</code> <code>runtime</code> behavior I think I got the properties
<code>__pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__</code> had
to force <code>gcc</code> into <code>SIGSEGV</code>.
Slightly oversimplified function has the following form:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>__pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__<span class="op">()</span> <span class="op">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    __pyx_t_6 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> mode <span class="op">=</span> setjmp<span class="op">(</span>jb<span class="op">);</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>mode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">1</span><span class="op">:</span>                                  <span class="co">// longjmp() case</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span>                                  <span class="co">// regular case (`case 3:` in real code)</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        __pyx_t_6 <span class="op">=</span> something_else<span class="op">();</span>          <span class="co">// set __pyx_t_6 to non-zero</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> done <span class="op">=</span> use_post_setjmp<span class="op">(</span>__pyx_t_6<span class="op">);</span> <span class="co">// call longjmp(jb, 1) here</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>        __pyx_t_6 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// get here via longjmp() or via natural execution flow</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">//</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Note: natural execution flow always gets here with `__pyx_t_6 = NULL`.</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>__pyx_t_6 <span class="op">!=</span> NULL<span class="op">)</span> deref<span class="op">(</span>__pyx_t_6<span class="op">);</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Similar to our contrived example we save the function state at the
beginning of a function and return back to it from <code>use_post_setjmp()</code>
helper after we changed the value of a local variable.</p>
<p><code>__pyx_t_6</code> is not marked <code>volatile</code>. <code>gcc</code> noticed that <code>__pyx_t_6</code> is
always expected to be <code>NULL</code> when it reaches the final statement. And
<code>gcc</code> optimizes the function code into the following equivalent:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>__pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__<span class="op">()</span> <span class="op">{</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    __pyx_t_6 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> mode <span class="op">=</span> setjmp<span class="op">(</span>jb<span class="op">);</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>mode<span class="op">)</span> <span class="op">{</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">1</span><span class="op">:</span>                                  <span class="co">// longjmp() case</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span>                                  <span class="co">// regular case (`case 3:` in real code)</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>        __pyx_t_6 <span class="op">=</span> something_else<span class="op">();</span>          <span class="co">// set __pyx_t_6 to non-zero</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> done <span class="op">=</span> use_post_setjmp<span class="op">(</span>__pyx_t_6<span class="op">);</span> <span class="co">// call longjmp(jb, 1) here</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>        __pyx_t_6 <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Constant-fold `__pyx_t_6 = NULL` in `deref()` call site</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>__pyx_t_6 <span class="op">!=</span> NULL<span class="op">)</span> deref<span class="op">(</span>NULL<span class="op">);</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note that <code>gcc</code> did not eliminate the <code>if (__pyx_t_6 != NULL)</code> even
though the condition is always expected to be <code>false</code> (Richard explains
it <a href="https://gcc.gnu.org/PR114872#c24">here</a>).</p>
<p>The presence of <code>longjmp()</code> effectively skips the
<code>__pyx_t_6 = NULL;</code> assignment and executes <code>if (__pyx_t_6 != NULL) deref(NULL);</code>.
That leads to <code>SIGSEGV</code>.
Phew. We finally have the breakage mechanics caused by <code>gcc</code> code motion.</p>
<p>This bug is known for a while in <code>sagemath</code> bug tracker as an
<a href="https://github.com/sagemath/sage/issues/37026"><code>Issue#37026</code></a>.
Fixing it will probably require adding <code>volatile</code> marking to quite a few
temporary variables in <code>.pyx</code> files of <code>sagemath</code>. Or alternatively
avoid the <code>setjmp()</code> / <code>longjmp()</code> pattern in inner functions if
feasible. They are just too large to be auditable for <code>setjmp()</code>
constraints.</p>
<h2 id="bonus-how-setjmp-longjmp-works-in-glibc">Bonus: how <code>setjmp()</code> / <code>longjmp()</code> works in <code>glibc</code></h2>
<p>Let’s look at what <code>glibc</code> does in <code>setjmp()</code> on <code>x86_64</code> at
<a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=sysdeps/x86_64/setjmp.S;h=40807e73b51c362464730212d7c973848be612bf;hb=HEAD"><code>sysdeps/x86_64/setjmp.S</code></a>:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="bu">ENTRY</span> <span class="op">(</span>__sigsetjmp<span class="op">)</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>        /* Save registers<span class="op">.</span>  <span class="op">*/</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">movq</span> <span class="op">%</span><span class="kw">rbx</span><span class="op">,</span> <span class="op">(</span>JB_RBX<span class="op">*</span><span class="dv">8</span><span class="op">)(%</span><span class="kw">rdi</span><span class="op">)</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>#ifdef PTR_MANGLE</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">mov</span> <span class="op">%</span>RBP_LP<span class="op">,</span> <span class="op">%</span>RAX_LP</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        PTR_MANGLE <span class="op">(%</span>RAX_LP<span class="op">)</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">mov</span> <span class="op">%</span>RAX_LP<span class="op">,</span> <span class="op">(</span>JB_RBP<span class="op">*</span><span class="dv">8</span><span class="op">)(%</span><span class="kw">rdi</span><span class="op">)</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>#else</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">movq</span> <span class="op">%</span><span class="kw">rbp</span><span class="op">,</span> <span class="op">(</span>JB_RBP<span class="op">*</span><span class="dv">8</span><span class="op">)(%</span><span class="kw">rdi</span><span class="op">)</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>#endif</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">movq</span> <span class="op">%</span><span class="kw">r12</span><span class="op">,</span> <span class="op">(</span>JB_R12<span class="op">*</span><span class="dv">8</span><span class="op">)(%</span><span class="kw">rdi</span><span class="op">)</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">movq</span> <span class="op">%</span><span class="kw">r13</span><span class="op">,</span> <span class="op">(</span>JB_R13<span class="op">*</span><span class="dv">8</span><span class="op">)(%</span><span class="kw">rdi</span><span class="op">)</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">movq</span> <span class="op">%</span><span class="kw">r14</span><span class="op">,</span> <span class="op">(</span>JB_R14<span class="op">*</span><span class="dv">8</span><span class="op">)(%</span><span class="kw">rdi</span><span class="op">)</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">movq</span> <span class="op">%</span><span class="kw">r15</span><span class="op">,</span> <span class="op">(</span>JB_R15<span class="op">*</span><span class="dv">8</span><span class="op">)(%</span><span class="kw">rdi</span><span class="op">)</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">lea</span> <span class="dv">8</span><span class="op">(%</span><span class="kw">rsp</span><span class="op">),</span> <span class="op">%</span>RDX_LP    <span class="op">/*</span> Save <span class="kw">SP</span> as it will be after we return<span class="op">.</span>  <span class="op">*/</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>#ifdef PTR_MANGLE</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>        PTR_MANGLE <span class="op">(%</span>RDX_LP<span class="op">)</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>#endif</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">movq</span> <span class="op">%</span><span class="kw">rdx</span><span class="op">,</span> <span class="op">(</span>JB_RSP<span class="op">*</span><span class="dv">8</span><span class="op">)(%</span><span class="kw">rdi</span><span class="op">)</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">mov</span> <span class="op">(%</span><span class="kw">rsp</span><span class="op">),</span> <span class="op">%</span>RAX_LP     <span class="op">/*</span> Save PC we are returning to now<span class="op">.</span>  <span class="op">*/</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        LIBC_PROBE <span class="op">(</span>setjmp<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> LP_SIZE<span class="fu">@</span><span class="er">%</span>RDI_LP<span class="op">,</span> <span class="op">-</span><span class="dv">4</span><span class="fu">@</span><span class="er">%</span><span class="kw">esi</span><span class="op">,</span> LP_SIZE<span class="fu">@</span><span class="er">%</span>RAX_LP<span class="op">)</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>#ifdef PTR_MANGLE</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>        PTR_MANGLE <span class="op">(%</span>RAX_LP<span class="op">)</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>#endif</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">movq</span> <span class="op">%</span><span class="kw">rax</span><span class="op">,</span> <span class="op">(</span>JB_PC<span class="op">*</span><span class="dv">8</span><span class="op">)(%</span><span class="kw">rdi</span><span class="op">)</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>        /* Make a tail call to __sigjmp_save<span class="co">; it takes the same args.  */</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">jmp</span> __sigjmp_save</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a><span class="pp">END</span> <span class="op">(</span>__sigsetjmp<span class="op">)</span></span></code></pre></div>
<p><code>%rdi</code> is our <code>env</code> parameter in <code>int setjmp(jmp_buf env);</code> signature.
<code>__sigsetjmp</code> does a few things:</p>
<ul>
<li>is saves <code>r12</code>, <code>r13</code>, <code>r14</code>, <code>r15</code>, <code>rbx</code>, <code>rsp</code>, <code>rbp</code> registers into
<code>jmp_buf env</code> parameter. These registers happen to be all <code>callee-save</code>
registers on <code>System V x86_64 ABI</code>. Any <code>ABI</code>-conformant <code>C</code> function
does the same if it plans to use these registers locally.</li>
<li>the only twist is that some of the stack-related registers are
obfuscated with <code>PTR_MANGLE</code> macro. The macro mixes in stack canary
into the value.</li>
<li><code>__sigsetjmp</code> also saves return address as <code>mov (%rsp), %RAX_LP</code> to be
able to resume from it later.</li>
<li><code>__sigsetjmp</code> also handles shadow call stack if that exists, I skipped
it entirely for simplicity</li>
</ul>
<p>Importantly <code>__sigsetjmp</code> does not save any stack contents. It assumes
that <code>gcc</code> and the code author make sure it does not get corrupted on
return.</p>
<p>The <code>longjmp()</code> recovery is a mirror-image of <code>setjmp()</code>
in <a href="https://sourceware.org/git/?p=glibc.git;a=blob;f=sysdeps/x86_64/__longjmp.S;h=22fedc49970eba0ab86cb8dec8411197bec95d37;hb=HEAD"><code>sysdeps/x86_64/__longjmp.S</code></a>. I’ll skip
pasting <code>longjmp()</code> implementation here.</p>
<h2 id="bonus-2--wclobbered-is-able-to-detect-some-of-the-clobber-cases">Bonus 2: <code>-Wclobbered</code> is able to detect some of the clobber cases</h2>
<p>Alexander Monakov <a href="https://fosstodon.org/@amonakov@mastodon.gamedev.place/112429019564307874">pointed out</a>
that <code>gcc</code> actually has an option to detect some of the clobbering cases
with <code>-Wclobbered</code>.</p>
<p>On a contrived example it reports nothing:</p>
<pre><code>$ gcc -O2 -c example.c -Wclobbered -Wall -Wextra -W</code></pre>
<p>It’s unfortunate as we can clearly see the different output.</p>
<p>But on the real <code>element.c</code> it complains as:</p>
<pre><code>$ gcc -O2 -Wclobbered -c element.i
...
element.c: In function '__pyx_pf_4sage_4libs_3gap_7element_19GapElement_Function_2__call__':
element.c:26122:13: warning: variable '__pyx_v_libgap' might be clobbered by 'longjmp' or 'vfork' [-Wclobbered]
element.c:26123:13: warning: variable '__pyx_v_a' might be clobbered by 'longjmp' or 'vfork' [-Wclobbered]
element.c:26125:13: warning: variable '__pyx_r' might be clobbered by 'longjmp' or 'vfork' [-Wclobbered]
element.c:26130:13: warning: variable '__pyx_t_4' might be clobbered by 'longjmp' or 'vfork' [-Wclobbered]
element.c:26131:13: warning: variable '__pyx_t_5' might be clobbered by 'longjmp' or 'vfork' [-Wclobbered]
element.c:26132:13: warning: variable '__pyx_t_6' might be clobbered by 'longjmp' or 'vfork' [-Wclobbered]
element.c:26134:13: warning: variable '__pyx_t_8' might be clobbered by 'longjmp' or 'vfork' [-Wclobbered]
element.c:26135:13: warning: variable '__pyx_t_9' might be clobbered by 'longjmp' or 'vfork' [-Wclobbered]
element.c:26136:13: warning: variable '__pyx_t_10' might be clobbered by 'longjmp' or 'vfork' [-Wclobbered]
element.c:38074:19: warning: variable 'r' might be clobbered by 'longjmp' or 'vfork' [-Wclobbered]
element.c:38074:19: warning: variable 'r' might be clobbered by 'longjmp' or 'vfork' [-Wclobbered]</code></pre>
<p>And that includes our <code>__pyx_t_6</code> variable!</p>
<h2 id="parting-words">Parting words</h2>
<p>Python ecosystem did not fully update to latest <code>python</code> release:
<code>python-3.12</code> was out in October 2023 and many packages did not yet
catch up with it. That makes it tedious to fix a long tail of issues
like <code>sagemath</code> crashes. Also makes it hard to reproduce issues on some
distributions that follow upstream packages without much patching.</p>
<p>While it was a bit unfortunate that <code>sagemath</code> is not packaged in
<code>::gentoo</code> I was pleasantly surprised by the responsive maintainer of
<code>::sage-on-gentoo</code> overlay. I managed to build <code>sagemath-standard</code> with
their help relatively quickly.</p>
<p><code>scikit-build-core</code> package is invasive and is able to break the build
of packages that don’t import it directly or indirectly, like
<a href="https://github.com/cschwan/sage-on-gentoo/issues/783"><code>sagemath-standard</code></a>.</p>
<p><code>cysignals</code> in <code>::gentoo</code> has a <a href="https://bugs.gentoo.org/927767">broken path</a>
to the <code>gdb</code> helper which makes it more tedious to debug <code>sagemath</code>
crashes.</p>
<p><code>cysignals</code> uses <code>SIGABRT</code> and <code>setjmp()</code> / <code>longjmp()</code> to recover from
errors. <code>sagemath</code> decided to use it in <code>C</code> bindings. Unfortunately it
does not mix well with <code>cython</code> use of local variables and leads to
broken code.</p>
<p>I was lucky to look at the <code>SIGABRT</code> handler first to notice <code>longjmp()</code>
there. If <code>gdb</code> hook would not fail for a wrong <code>share</code> path I would
take me a lot more time to discover <code>setjmp()</code> clue.</p>
<p>I was lucky as <code>gcc</code> did not delete <code>NULL</code>-dereferencing code and
generated something that crashes on execution. Otherwise, it would be
at best resource leak and use-after-free or data corruption at worst.</p>
<p><code>setjmp()</code> / <code>longjmp()</code> is very hard to use correctly in large
functions. One has to be very careful to sprinkle enough <code>volatile</code>
keywords to inhibit enough compiler optimizations to get expected
semantics from the program.</p>
<p>It was not a compiler bug after all but the <code>sagemath</code> one. It was
interaction between two aspects <code>sagemath</code> used:</p>
<ul>
<li><code>cython</code> usage that generates a ton of local variables it mutates
along the way without the <code>volatile</code> annotations</li>
<li>use of <code>cysignals</code> <code>sig_GAP_Enter()</code> (aka <code>setjmp()</code>) error recovery
in the same function</li>
</ul>
<p><code>gcc</code> can detect some of the clobber cases with <code>-Wclobbered</code> flag.</p>
<p>Have fun!</p>
        </div>
    </body>
</html>
