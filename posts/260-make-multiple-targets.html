<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>GNU make amends rules with multiple targets</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/code.css" />
        <link rel="stylesheet" type="text/css" href="../css/skylighting.css" />

        <link rel="alternate" type="application/atom+xml" href="../feed/atom.xml" title="Atom 1.0" />
        <link rel="alternate" type="application/rss+xml" href="../feed/rss.xml" title="RSS 2.0" />
        <link rel="shortcut icon" href="../images/favicon.ico" />
    </head>
    <body>
        <div id="navigation">
            <a href="../">home</a>
            <a href="../blog.html">blog</a>
            <a href="../log.html">log</a>
            <a href="../feed/atom.xml">atom</a>
            <a href="../feed/rss.xml">rss</a>
            <a href="../about.html">about</a>
            <a href="../contact.html">contact</a>
        </div>

        <div id="content">
            <h1>GNU make amends rules with multiple targets</h1>
            
                <div class="info">September 25, 2022</div>
            

            <h2 id="tldr">TL;DR</h2>
<p>Starting from <code>GNU make-4.4</code> rules with multiple targets that include
commands will trigger if any of the targets does not exist. This will
require a few projects to adapt. Older versions of <code>ghc</code> are affected.</p>
<p>Typical example would need to adapt from something like:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dv">%.gen.c %.gen.h %.gen.not-always-present:</span><span class="dt"> %.src</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>	<span class="ch">$(</span><span class="dt">CMD</span><span class="ch">)</span> ...</span></code></pre></div>
<p>to something like:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dv">%.gen.c %.gen.h:</span><span class="dt"> %.src</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>	<span class="ch">$(</span><span class="dt">CMD</span><span class="ch">)</span> ...</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="dv">%.gen.not-always-present:</span><span class="dt"> %.gen.c</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>	: <span class="co"># generated by previous rule or not generated at all</span></span></code></pre></div>
<p>See <a href="https://savannah.gnu.org/bugs/index.php?63098" class="uri">https://savannah.gnu.org/bugs/index.php?63098</a> for other options.</p>
<h2 id="more-words">More words</h2>
<p><code>Makefile</code> usually defines a bunch of prerequisites per single target:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dv">foo:</span><span class="dt"> foo.c foo.h</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>	<span class="ch">$(</span><span class="dt">CC</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">CFLAGS</span><span class="ch">)</span> <span class="ch">$(</span><span class="dt">LDLIBS</span><span class="ch">)</span> foo.c -o foo</span></code></pre></div>
<p>For dependency-only rules without commands it’s customary to specify
multiple targets:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dv">all:</span><span class="dt"> foo bar</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># multiple targets</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="dv">foo bar:</span><span class="dt"> foo.h</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co"># equivalent to</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   foo: foo.h</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">#   bar: foo.h</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="dv">foo:</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>	touch foo</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="dv">bar:</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>	touch bar</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="dv">foo.h:</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>	touch foo.h</span></code></pre></div>
<p>In all the cases above the behavior is straightforward: if <code>foo.h</code>
changes then <code>foo</code> and <code>bar</code> are outdated and have to be rebuilt (if
rebuild is requested). And specifically <code>make foo</code> should cause only
<code>foo</code> rebuild. Example session:</p>
<pre><code>$ make
touch foo.h
touch foo
touch bar

$ touch foo.h
$ make foo
touch foo</code></pre>
<p>No surprise here: in a second run <code>bar</code> is not rebuilt and stays
outdated (we did not ask for its update). And <code>foo</code> is rebuilt
as expected.</p>
<p>In <code>GNU make</code> before <code>4.3.90</code> the same rule applied to rules with
commands as well:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dv">all:</span><span class="dt"> foo bar</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="dv">foo bar:</span><span class="dt"> foo.h</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>	touch foo bar</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="dv">foo.h:</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>	touch foo.h</span></code></pre></div>
<p>Note that the command for <code>foo bar: foo.h</code> rule always builds both
targets.</p>
<p>Let’s try to delete <code>bar</code> and ask <code>foo</code> to be rebuilt. Would <code>foo</code> get
rebuilt? Would <code>bar</code> get rebuilt? Here is the answer:</p>
<pre><code>$ make-4.3
touch foo.h
touch foo bar

$ rm bar
$ make-4.3 foo
make: 'foo' is up to date.</code></pre>
<p>Looks exactly the same as above: <code>foo</code> does not require a refresh.</p>
<p>Now let’s try <code>make-4.3.90</code>:</p>
<pre><code>$ rm -f foo bar foo.h

$ make-4.3.90
touch foo bar

$ rm bar
$ make-4.3.90 foo
touch foo bar</code></pre>
<p>That’s a different behavior: absence of <code>bar</code> triggers both <code>foo</code>
and <code>bar</code> rebuilds. This behavior change is intentional and is added in
<a href="https://savannah.gnu.org/bugs/?62809" class="uri">https://savannah.gnu.org/bugs/?62809</a>.</p>
<h2 id="the-impact">The impact</h2>
<p>So far it looks benign: we’ll build just a bit more than we used to
in some incremental builds. Fresh-from-zero builds should not be
affected, right? Right?</p>
<p>I installed fresh <code>make-4.3.90</code> and attempted to build the world.</p>
<h3 id="opensp-case"><code>opensp</code> case</h3>
<p><code>opensp-1.5.2</code> being an <code>autotools</code> package provides tarballs with pre-generated
files as part of the release:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dv">%.h %.cxx %.rc:</span><span class="dt"> %.msg</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>	[ ! -f <span class="ch">$(</span><span class="dt">top_srcdir</span><span class="ch">)</span>/msggen.pl ] || <span class="ch">$(</span><span class="dt">PERL</span><span class="ch">)</span> -w <span class="ch">$(</span><span class="dt">top_srcdir</span><span class="ch">)</span>/msggen.pl <span class="ch">$(</span><span class="dt">MSGGENFLAGS</span><span class="ch">)</span> <span class="ch">$&lt;</span></span></code></pre></div>
<p>All <code>.h</code>, <code>.cxx</code> and <code>.rc</code> files are already present in
<code>OpenSP-1.5.2.tar.gz</code>. User never has to run <code>msggen.pl</code> script to get
<code>opensp</code> built.</p>
<p>Except that <code>msggen.pl</code> does not always produce <code>.cxx</code> files. It does so
only for <code>.msg</code> files that have a <code>!cxx</code> directive. I noticed it only
because <code>msggen.pl</code> does not really work on any modern <code>perl</code> version
(and because <code>nix</code> does not expose <code>perl</code> to build sandbox by default).
Fun fact: <code>OpenSP-1.5.2.tar.gz</code> was released in 2007.</p>
<p>The build fails on <code>make-4.3.90</code> as:</p>
<pre><code>$ make-4.3.90
make[2]: Entering directory '/build/OpenSP-1.5.2/lib'
[ ! -f ../msggen.pl ] || perl -w ../msggen.pl -l libModule PosixStorageMessages.msg
bash: line 1: perl: command not found
make[2]: *** [Makefile:778: PosixStorageMessages.h] Error 127 shuffle=1663959693</code></pre>
<p>The <a href="https://sourceforge.net/p/openjade/bugs/151/">proposed fix</a> makes
<code>.cxx</code> as optional by splitting out <code>.cxx</code> into a separate rule:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/lib/Makefile.am</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/lib/Makefile.am</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -125,5 +125,7 @@ SUFFIXES = .msg .m4 .rc</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a> .m4.cxx:</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a> 	$(PERL) $(top_srcdir)/instmac.pl $&lt; &gt;$@</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="st">-%.h %.cxx %.rc: %.msg</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="va">+%.h %.rc: %.msg</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>	[ ! -f $(top_srcdir)/msggen.pl ] || $(PERL) -w $(top_srcdir)/msggen.pl $(MSGGENFLAGS) $&lt;</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="va">+%.cxx: %.rc</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="va">+	: # built by perl rule above</span></span></code></pre></div>
<p>Here we move <code>.cxx</code> part as a separate no-op target to avoid <code>perl</code>
build rule from triggering. Similar fix had to be applied to a few
more <code>Makefile.am</code> files in <code>opensp</code> tree.</p>
<p>The failure Does not look bad: it was easy to diagnose and workaround.</p>
<h3 id="ghc-case"><code>ghc</code> case</h3>
<p><code>ghc</code> was another heavy <code>GNU make</code> user until
<a href="https://gitlab.haskell.org/ghc/ghc/-/commit/6fd9b0a1c6b076ef1977db1a2ce8b9505b9a3254">recently</a>.
Many distributions still package older <code>ghc</code> versions and still use
<code>GNU make</code> based build system. <code>ghc</code> was broken by <code>make-4.3.90</code> as:</p>
<pre><code>$ ./configure
$ make-4.3.90
...
ghc&gt;   HSC2HS libraries/hpc/dist-boot/build/Trace/Hpc/Reflect.hs
ghc&gt;   HSC2HS libraries/ghc-heap/dist-boot/build/GHC/Exts/Heap/Constants.hs
ghc&gt;   HSC2HS libraries/ghc-heap/dist-boot/build/GHC/Exts/Heap/InfoTable/Types.hs
ghc&gt;   HSC2HS libraries/ghc-heap/dist-boot/build/GHC/Exts/Heap/InfoTableProf.hs
ghc&gt;   HSC2HS libraries/ghc-heap/dist-boot/build/GHC/Exts/Heap/InfoTable.hs
ghc&gt;   HSC2HS libraries/ghc-heap/dist-boot/build/GHC/Exts/Heap/Utils.hs
ghc&gt;   HSC2HS libraries/ghci/dist-boot/build/GHCi/InfoTable.hs
ghc&gt;   HSC2HS libraries/ghci/dist-boot/build/GHCi/FFI.hs
...
ghc&gt;   HSC2HS libraries/hpc/dist-boot/build/Trace/Hpc/Reflect.hs
ghc&gt;   HSC2HS libraries/ghc-heap/dist-boot/build/GHC/Exts/Heap/Constants.hs
ghc&gt;   HSC2HS libraries/ghc-heap/dist-boot/build/GHC/Exts/Heap/InfoTable/Types.hs
ghc&gt;   HSC2HS libraries/ghc-heap/dist-boot/build/GHC/Exts/Heap/InfoTableProf.hs
ghc&gt;   HSC2HS libraries/ghc-heap/dist-boot/build/GHC/Exts/Heap/InfoTable.hs
ghc&gt;   HSC2HS libraries/ghc-heap/dist-boot/build/GHC/Exts/Heap/Utils.hs
ghc&gt;   HSC2HS libraries/ghci/dist-boot/build/GHCi/InfoTable.hs
ghc&gt;   HSC2HS libraries/ghci/dist-boot/build/GHCi/FFI.hs
...
ghc&gt; ghc.mk:100: *** Make has restarted itself 2 times; is there a makefile bug? See https://gitlab.haskell.org/ghc/ghc/wikis/building/troubleshooting#make-has-restarted-itself-3-times-is-there-a-makefile-bug for details.  Stop.
ghc&gt; make: *** [Makefile:126: all] Error 2 shuffle=1664105902</code></pre>
<p>Looks simple, right? No, it does not. <code>ghc</code> build system detected
infinite rebuild loop and bailed out. Note how <code>Reflect.hs</code> gets
generated at least twice with <code>HSC2HS</code> <code>haskell</code> code generator.</p>
<p>To explain its mechanics I’ll build a contrived example:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dv">foo:</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>	touch foo</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="dv">%.d:</span><span class="dt"> %.c</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>	echo <span class="st">&quot;foo.d: foo.c&quot;</span>  &gt; foo.d</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>	echo <span class="st">&quot;foo: foo.d foo.c&quot;</span> &gt;&gt; foo.d</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="dv">%.c:</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>	touch <span class="ch">$*</span>.c</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="kw">-include</span> foo.d</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="ot">.PRECIOUS:</span><span class="dt"> foo.c</span></span></code></pre></div>
<p>Here we dynamically generate a part of a <code>Makefile</code> by generating
<code>foo.d</code> file and by including it via <code>-include foo.d</code>. Leading
minus(<code>-</code>) ignores some error conditions when including files.</p>
<p>Let’s try it:</p>
<pre><code>$ rm -f foo* &amp;&amp; make-4.3.90
touch foo.c
echo &quot;foo.d: foo.c&quot;  &gt; foo.d
echo &quot;foo: foo.d foo.c&quot; &gt;&gt; foo.d
touch foo</code></pre>
<p>Note that initially <code>foo</code> does not contain any dependencies.
<code>GNU make</code> has to build <code>foo.d</code> part first to see the rest of the
dependencies.</p>
<p>Interestingly <code>GNU make</code> has to re-execute itself after <code>foo.d</code> is
available. We can see it in debug (<code>-d</code>) mode by looking up
<code>Re-executing</code> lines:</p>
<pre><code>$ rm -f foo* &amp;&amp; LANG=C make-4.3.90 -d |&amp; grep Re-
Re-executing[1]: make -d</code></pre>
<p>Now let’s extend our <code>foo.c</code> rule (<code>foo.d</code> dependency) to include an
unrelated and non-existent <code>foo.h</code> file as an output target:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/makefile</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/makefile</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -5,8 +5,9 @@ foo:</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a> 	echo &quot;foo.d: foo.c&quot;  &gt; foo.d</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a> 	echo &quot;foo: foo.d foo.c&quot; &gt;&gt; foo.d</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="st">-%.c:</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="va">+%.c %.h:</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a> 	touch $*.c</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="va">+	# missing 'touch $*.h'</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a> -include foo.d</span></code></pre></div>
<p>Running:</p>
<pre><code>$ rm -f foo* &amp;&amp; make-4.3.90
touch foo.c
# missing 'touch foo.h'
echo &quot;foo.d: foo.c&quot;  &gt; foo.d
echo &quot;foo: foo.d foo.c&quot; &gt;&gt; foo.d

touch foo.c
# missing 'touch foo.h'
echo &quot;foo.d: foo.c&quot;  &gt; foo.d
echo &quot;foo: foo.d foo.c&quot; &gt;&gt; foo.d

touch foo.c
# missing 'touch foo.h'
echo &quot;foo.d: foo.c&quot;  &gt; foo.d
echo &quot;foo: foo.d foo.c&quot; &gt;&gt; foo.d

touch foo.c
# missing 'touch foo.h'
echo &quot;foo.d: foo.c&quot;  &gt; foo.d
echo &quot;foo: foo.d foo.c&quot; &gt;&gt; foo.d

touch foo.c
# missing 'touch foo.h'
echo &quot;foo.d: foo.c&quot;  &gt; foo.d
echo &quot;foo: foo.d foo.c&quot; &gt;&gt; foo.d
...</code></pre>
<p><code>GNU make</code> fell into an infinite loop. Here missing <code>foo.h</code> file triggers
<code>make</code> to always regenerate <code>foo.d</code> on each re-execution. Regenerated
<code>foo.d</code> requires another re-execution. We get the loop. Previous
<code>make-4.3</code> version did not exhibit this behavior:</p>
<pre><code>$ rm -f foo* &amp;&amp; make-4.3
touch foo.c
# missing 'touch foo.h'
echo &quot;foo.d: foo.c&quot;  &gt; foo.d
echo &quot;foo: foo.d foo.c&quot; &gt;&gt; foo.d
touch foo</code></pre>
<p>Now back to <code>ghc</code>. It took me some time to read through <code>make -d</code> output
to find the offending rule. The following fix was enough to fix <code>ghc</code>:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/rules/hs-suffix-rules-srcdir.mk</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/rules/hs-suffix-rules-srcdir.mk</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -33,9 +33,12 @@ $1/$2/build/%.hs : $1/$2/build/%.y | $$$$(dir $$$$@)/.</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a> $1/$2/build/%.hs : $1/$3/%.x | $$$$(dir $$$$@)/.</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a> 	$$(call cmd,ALEX) $$($1_$2_ALL_ALEX_OPTS) $$&lt; -o $$@</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="st">-$1/$2/build/%_hsc.c $1/$2/build/%_hsc.h $1/$2/build/%.hs : $1/$3/%.hsc $$$$(hsc2hs_INPLACE) | $$$$(dir $$$$@)/.</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="va">+$1/$2/build/%.hs : $1/$3/%.hsc $$$$(hsc2hs_INPLACE) | $$$$(dir $$$$@)/.</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a> 	$$(call cmd,hsc2hs_INPLACE) $$($1_$2_ALL_HSC2HS_OPTS) $$&lt; -o $$@</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="va">+$1/$2/build/%_hsc.c $1/$2/build/%_hsc.h: $1/$2/build/%.hs</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="va">+		: # rely on previous rule to build targets</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a> # Now the rules for hs-boot files.</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a> $1/$2/build/%.hs-boot : $1/$3/%.hs-boot | $$$$(dir $$$$@)/.</span></code></pre></div>
<p><code>hsc2hs</code> does not always emit <code>C</code> stub part. The fix is almost identical
to <code>opensp</code> case: we split out optional output into a separate rule.</p>
<p>As <code>ghc</code> dropped <code>GNU make</code>-based build system I did not try to upstream
the change. Downstreams would have to carry something similar for older
<code>ghc</code> versions they ship.</p>
<h3 id="dtc-case"><code>dtc</code> case</h3>
<p><code>dtc</code> also happens to use <code>GNU make</code>-based build system. It’s <code>Makefile</code>
is a lot smaller than <code>ghc</code>’s one. The symptom was very similar to our
contrived example:</p>
<pre><code>$ make-4.3.90
...
        CHK version_gen.h
         BISON dtc-parser.tab.h
         DEP dtc-lexer.lex.c
         DEP dtc-parser.tab.c
        CHK version_gen.h
         BISON dtc-parser.tab.h
         DEP dtc-lexer.lex.c
         DEP dtc-parser.tab.c
        CHK version_gen.h
         BISON dtc-parser.tab.h
         DEP dtc-lexer.lex.c
         DEP dtc-parser.tab.c
        CHK version_gen.h
         BISON dtc-parser.tab.h
         DEP dtc-lexer.lex.c
         DEP dtc-parser.tab.c
...</code></pre>
<p>It took me a few hours to notice that <code>dtc</code> build was stuck.</p>
<p>The cause of cycle was again <code>make</code> re-execution caused by a missing
file in <code>bison</code> rule with multiple targets. <code>bison</code> rule contained
output that is never used by anything. The fix is trivial:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/Makefile</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/Makefile</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -384,4 +384,4 @@ clean: libfdt_clean pylibfdt_clean tests_clean</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="st">-%.tab.c %.tab.h %.output: %.y</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="va">+%.tab.c %.tab.h: %.y</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a> 	@$(VECHO) BISON $@</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a> 	$(BISON) -b $(basename $(basename $@)) -d $&lt;</span></code></pre></div>
<p>While at it, I added a guard against infinite re-execution similar to
<code>ghc</code> guard:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/Makefile</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/Makefile</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -389,3 +389,3 @@ clean: libfdt_clean pylibfdt_clean tests_clean</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="va">+ifeq ($(MAKE_RESTARTS),10)</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="va">+$(error &quot;Make re-executed itself $(MAKE_RESTARTS) times. Infinite recursion?&quot;)</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="va">+endif</span></span></code></pre></div>
<p><code>GNU make</code> provides <code>$(MAKE_RESTARTS)</code> variable to detect <code>make</code> restarts.</p>
<p>Both fixes are proposed upstream as <a href="https://github.com/dgibson/dtc/pull/73" class="uri">https://github.com/dgibson/dtc/pull/73</a>.</p>
<h2 id="parting-words">Parting words</h2>
<p>Rules with multiple targets are tricky and fun. <code>GNU make-4.4</code> will be a
bit more eager at rebuilding all the targets if prerequisite changes.
This will expose bugs in a few programs. They should be easy to adapt.
Otherwise, keeping an older version of <code>GNU make</code> in parallel to the
newer one should be a reasonable workaround as well.</p>
<p>So far only <code>opensp</code>, <code>ghc</code> and <code>dtc</code> needed fixing.</p>
<p>Have fun!</p>
        </div>
    </body>
</html>
