<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Linker script weird tricks or EFI on ia64</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/code.css" />
        <link rel="stylesheet" type="text/css" href="../css/skylighting.css" />

        <link rel="alternate" type="application/atom+xml" href="../feed/atom.xml" title="Atom 1.0" />
        <link rel="alternate" type="application/rss+xml" href="../feed/rss.xml" title="RSS 2.0" />
        <link rel="shortcut icon" href="../images/favicon.ico" />
    </head>
    <body>
        <div id="navigation">
            <a href="../">home</a>
            <a href="../blog.html">blog</a>
            <a href="../log.html">log</a>
            <a href="../feed/atom.xml">atom</a>
            <a href="../feed/rss.xml">rss</a>
            <a href="../about.html">about</a>
            <a href="../contact.html">contact</a>
        </div>

        <div id="content">
            <h1>Linker script weird tricks or EFI on ia64</h1>
            
                <div class="info">February  2, 2018</div>
            

            <p>One of <code>gentoo</code> <a href="https://bugs.gentoo.org/579278">bugs</a> was about
<code>gentoo</code> install <code>CD</code> not being able to boot <code>Itanium</code> (<code>ia64</code>) boxes.</p>
<h2 id="the-bug">The bug</h2>
<p>The symptom is <code>EFI</code> loader error:</p>
<pre><code>Loading.: Gentoo Linux
ImageAddress: pointer is outside of image
ImageAddress: pointer is outside of image
LoadPe: Section 1 was not loaded
Load of Gentoo Linux failed: Not Found
Paused - press any key to continue</code></pre>
<p>This looks like a simple error if you have the hardware and source code
of the loader that prints the error. I had neither.</p>
<p>My plan was to extend <code>ski</code> emulator to be able to handle early
<code>EFI</code> stuff. I started reading <a href="https://www.thailand.intel.com/content/dam/www/public/us/en/documents/specification-updates/itanium-system-abstraction-layer-specification.pdf">docs on early <code>itanium</code> boot
life</a>:
on <code>SAL</code>s (system abstraction layers), <code>PAL</code>s (platform abstraction
layers), monarch processors, rendezvous protocols to handle <code>MCA</code>s
(machine check aborts) and expected system state when hand off to
<code>EFI</code> happens. But <code>SAL</code> spec touches <code>EFI</code> only at <code>SAL</code> -&gt; <code>EFI</code>
interface boundary. I dreaded to open <code>EFI</code> spec before finishing reading
<code>SAL</code> paper.</p>
<h2 id="how-ia64-actually-boots">How <code>ia64</code> actually boots</h2>
<p>Recently I got access to real management processor (sometimes also
called <code>MP</code>, <code>BMC</code> (baseboard management controller): <code>iLO</code>
(integrated lights-out)) on <code>rx3600</code> machine and I gave up on
extending <code>ski</code> for a while.
The very first thing I attempted is to get to serial console of
operating system from <code>iLO</code>. It happened to be not as straightforward
as passing <code>console=ttyS0</code> to kernel. I ended up learning a bit about
<code>EFI</code> shell, <code>ia64</code>-specific <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/ia64/serial.txt">serial port
numbering</a>
and <code>elilo</code>.
Eventually I was able to boot arbitrary kernel directly from <code>EFI</code>
shell and get to kernel’s console! I needed that as a fallback in case
I screw default boot loader, boot loader config or default boot options
as I don’t have physical access to <code>ia64</code> machine.
Here is an example of booting from <code>CD</code> and controlling it from
<code>iLO</code> virtual serial console:</p>
<pre><code>fs0:\efi\boot\bootia64.efi -i gentoo.igz gentoo initrd=gentoo.igz root=/dev/ram0 init=/linuxrc dokeymap looptype=squashfs loop=/image.squashfs cdroot console=ttyS1,115200n8</code></pre>
<p>Here <code>fs0</code> is a <code>FAT</code> file system (on <code>CD</code>, could be on <code>HDD</code>) with
<code>EFI</code> applications. <code>bootia64.efi</code> is a <code>sys-boot/elilo</code>
application in disguise. <code>console=ttyS1,115200n8</code> matches <code>EFI</code> setup
of second serial console.
After successful boot from <code>CD</code> of known good old kernel (from 2009) I
was not afraid of messing with main <code>HDD</code> install or even upgrading to
brand new kernels, I even managed to squash another <code>ia64</code>-specific
kernel and GCC bug! I’ll try to write another post about that.
This poking also helped me to understand boot process in more detail.
<code>ia64</code> boots in the following way:</p>
<ol type="1">
<li><code>SAL</code>: when machine powers on it executes <code>SAL</code> (and <code>PAL</code>)
code to initialize System and Processors. This code is not
easily to update and usually stays the same across <code>OS</code> updates.</li>
<li><code>EFI</code>: Then <code>SAL</code> hands control to <code>EFI</code> (also not easily
to update) where I can interactively pick boot device or even get
<code>EFI</code> shell to run <code>EFI</code> applications (programs for <code>EFI</code>
environment).</li>
<li><code>Bootloader (EFI application)</code>: Normally <code>EFI</code> is set up to
start boot loader after a few seconds. It’s up to the user
(finally!) to provide a boot loader implementation. <a href="https://wiki.gentoo.org/wiki/Handbook:IA64">Gentoo <code>ia64</code>
handbook</a> suggests
<code>sys-boot/elilo</code> package.</li>
<li><code>OS kernel</code>: boot loader finds <code>OS</code> kernel, loads it and hands
control off to kernel.</li>
</ol>
<h2 id="searching-for-the-clues">Searching for the clues</h2>
<p>Our problem happened at stage <code>3</code> where <code>EFI</code> failed to load
<code>elilo</code> application.
<code>gentoo</code> builds <code>.iso</code> images automatically and continuously. Here you
can find <a href="http://distfiles.gentoo.org/releases/ia64/autobuilds/"><code>ia64</code>
isos</a>. Older
disks are available on actual builder machines.
As <code>elilo</code> used to work on images from 2008 and even <code>2016</code> (!) I
passed through a few autobuilt <code>ISO</code> images and collected a few
working and non-working samples and started comparing them.
I extracted <code>elilo.efi</code> files from 3 disks:</p>
<ul>
<li><code>elilo-2014-works.efi</code>: good, picked from machine I have access to</li>
<li><code>elilo-2016-works.efi</code>: good, picked from <code>2016</code> install <code>CD</code></li>
<li><code>elilo-2018-does-not-work.efi</code>: bad, freshly built on modern
software</li>
</ul>
<p>Normally I would start from running <code>readelf -a</code> on each executable
and diff for suspicious changes. The files however are not <code>ELF</code>s:</p>
<pre><code>$ file *.efi
elilo-2014-works.efi:         PE32+ executable (EFI application) Intel Itanium (stripped to external PDB), for MS Windows
elilo-2016-works.efi:         PE32 executable (EFI application) Intel Itanium (stripped to external PDB), for MS Windows
elilo-2018-does-not-work.efi: PE32+ executable (EFI application) Intel Itanium (stripped to external PDB), for MS Windows</code></pre>
<p>One of them is not even <code>PE32+</code> but still happens to boot.
<code>binutils</code> has more generic <code>readelf -a</code> equivalent: it’s
<code>objdump -x</code>. Comparing two good files:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>$ objdump -x elilo-2014-works.efi &gt; 2014.good</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>$ objdump -x elilo-2016-works.efi &gt; 2016.good</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">--- 2014.good   2018-01-27 23:34:10.118197637 +0000</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ 2016.good   2018-01-27 23:34:23.590191456 +0000</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -2,2 +2,2 @@</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="st">-elilo-2014-works.efi:     file format pei-ia64</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="st">-elilo-2014-works.efi</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="va">+elilo-2016-works.efi:     file format pei-ia64</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="va">+elilo-2016-works.efi</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -6 +6 @@</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="st">-start address 0x0000000000043a20</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="va">+start address 0x000000000003a6a0</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -14,2 +14,2 @@</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="st">-Time/Date              Tue Jun 24 22:05:17 2014</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="st">-Magic                  020b    (PE32+)</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="va">+Time/Date              Mon Jan  9 21:18:46 2006</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="va">+Magic                  010b    (PE32)</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -17,3 +17,3 @@</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="st">-MinorLinkerVersion     23</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="st">-SizeOfCode             00036e00</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="st">-SizeOfInitializedData  00020800</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="va">+MinorLinkerVersion     56</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="va">+SizeOfCode             0002e000</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="va">+SizeOfInitializedData  00028a00</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -21 +21 @@</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="st">-AddressOfEntryPoint    0000000000043a20</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="va">+AddressOfEntryPoint    000000000003a6a0</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -34,2 +34,2 @@</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="st">-SizeOfHeaders          000002c0</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="st">-CheckSum               00067705</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="va">+SizeOfHeaders          00000400</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="va">+CheckSum               00069054</span></span></code></pre></div>
<p>There is a lot of odd going on here: the file on 2016 live <code>CD</code> is
actually from 2006 and it’s actually older than file from 2014. It has
different PE type and as a result different file alignment. Thus I
discarded <code>elilo-2016-works.efi</code> as too old.
Comparing bad/good:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>$ objdump -x elilo-2014-works.efi &gt; 2014.good</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>$ objdump -x elilo-2018-does-not-work.efi &gt; 2018.bad</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>$ diff -U0 2014.good 2018.bad</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">--- 2014.good   2018-01-27 23:42:58.355002114 +0000</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ 2018.bad    2018-01-27 23:43:02.042000991 +0000</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -2,2 +2,2 @@</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="st">-elilo-2014-works.efi:     file format pei-ia64</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="st">-elilo-2014-works.efi</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="va">+elilo-2018-does-not-work.efi:     file format pei-ia64</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="va">+elilo-2018-does-not-work.efi</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -6 +6 @@</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="st">-start address 0x0000000000043a20</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="va">+start address 0x0000000000046d80</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -14 +14 @@</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="st">-Time/Date              Tue Jun 24 22:05:17 2014</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="va">+Time/Date              Thu Jan  1 01:00:00 1970</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -17,3 +17,3 @@</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="st">-MinorLinkerVersion     23</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="st">-SizeOfCode             00036e00</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="st">-SizeOfInitializedData  00020800</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="va">+MinorLinkerVersion     29</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="va">+SizeOfCode             0003a200</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="va">+SizeOfInitializedData  00020e00</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -21,2 +21,2 @@</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="st">-AddressOfEntryPoint    0000000000043a20</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="st">-BaseOfCode             0000000000001000</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="va">+AddressOfEntryPoint    0000000000046d80</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="va">+BaseOfCode             0000000000000000</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -33 +33 @@</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="st">-SizeOfImage            0005c000</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="va">+SizeOfImage            0005f000</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -35 +35 @@</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="st">-CheckSum               00067705</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="va">+CheckSum               0005f6a3</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -51 +51 @@</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="st">-Entry 5 0000000000058000 0000000c Base Relocation Directory [.reloc]</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="va">+Entry 5 000000000005b000 0000000c Base Relocation Directory [.reloc]</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -66,3 +66,3 @@</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="st">-Virtual Address: 00043a20 Chunk size 12 (0xc) Number of fixups 2</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a><span class="st">-       reloc    0 offset    0 [43a20] DIR64</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a><span class="st">-       reloc    1 offset    8 [43a28] DIR64</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="va">+Virtual Address: 00046d80 Chunk size 12 (0xc) Number of fixups 2</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a><span class="va">+       reloc    0 offset    0 [46d80] DIR64</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a><span class="va">+       reloc    1 offset    8 [46d88] DIR64</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -87,571 +87,585 @@</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="st">-[  0](sec  3)(fl 0x00)(ty   0)(scl   3) (nx 0) 0x0000000000006a04 edd30_guid</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="st">-[  1](sec  2)(fl 0x00)(ty   0)(scl   3) (nx 0) 0x00000000000001f8 done_fixups</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="st">-[570](sec  2)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x0000000000000110 Optind</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a><span class="va">+[  0](sec  3)(fl 0x00)(ty   0)(scl   3) (nx 0) 0x0000000000006ccc edd30_guid</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="va">+[  1](sec  2)(fl 0x00)(ty   0)(scl   3) (nx 0) 0x0000000000000208 done_fixups</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a><span class="va">+[584](sec  2)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x0000000000000110 Optind</span></span></code></pre></div>
<p>This looks better. A few notable things:</p>
<ul>
<li><code>Time/Date</code> field is not initialized for the bad file: sane date vs.
all zeros</li>
<li><code>BaseOfCode</code> looks uninitialized: <code>0x1000</code> vs. <code>0x0000</code></li>
<li><code>MinorLinkerVersion</code> says good file was built with
<code>binutils-2.23</code>, bad file was built with <code>binutils-2.29</code></li>
<li>File has only 2 relocations: <code>Number of fixups 2</code>. We could check
them manually!</li>
<li>And a lot of symbols: <code>570</code> vs. <code>580</code></li>
</ul>
<p>I tried to build <code>elilo</code> with <code>binutils-2.25</code>: it produced the same
binary as <code>elilo-2018-does-not-work.efi</code>.
My only clue was that <code>BaseOfCode</code> is zero. It felt like something
used to reside in the first page before code section and now it does not
anymore. What could it be?</p>
<h2 id="gnu-binutils-linker-scripts">GNU <code>binutils</code> linker scripts</h2>
<p>Time to look at how the decision is made what to put into the first page at
link time!
The build process of <code>elilo.efi</code> is truly unusual. Let’s run <code>emerge -1 sys-boot/elilo</code> and check what commands are being executed to yield
it:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># emerge -1 sys-boot/elilo</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> <span class="at">-j1</span> ... ARCH=ia64</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ex">ia64-unknown-linux-gnu-gcc</span> <span class="dt">\</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">-I.</span> <span class="at">-I.</span> <span class="at">-I</span>/usr/include/efi <span class="at">-I</span>/usr/include/efi/ia64 <span class="at">-I</span>/usr/include/efi/protocol <span class="at">-I.</span>/efi110  <span class="dt">\</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">-O2</span>  <span class="at">-fno-stack-protector</span> <span class="at">-fno-strict-aliasing</span> <span class="at">-fpic</span> <span class="at">-fshort-wchar</span> <span class="dt">\</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">-Wall</span> <span class="dt">\</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DENABLE_MACHINE_SPECIFIC_NETCONFIG</span> <span class="at">-DCONFIG_LOCALFS</span> <span class="at">-DCONFIG_NETFS</span> <span class="at">-DCONFIG_CHOOSER_SIMPLE</span> <span class="dt">\</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DCONFIG_CHOOSER_TEXTMENU</span> <span class="dt">\</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">-frename-registers</span> <span class="at">-mfixed-range</span><span class="op">=</span>f32-f127 <span class="dt">\</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">-DCONFIG_ia64</span>  <span class="dt">\</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">-c</span> glue_netfs.c <span class="at">-o</span> glue_netfs.o</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="ex">ia64-unknown-linux-gnu-ld</span> <span class="dt">\</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">-nostdlib</span> <span class="at">-znocombreloc</span> <span class="dt">\</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">-T</span> /usr/lib/elf_ia64_efi.lds <span class="dt">\</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">-shared</span> <span class="at">-Bsymbolic</span> <span class="dt">\</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">-L</span>/usr/lib <span class="at">-L</span>/usr/lib <span class="dt">\</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    /usr/lib/crt0-efi-ia64.o elilo.o getopt.o strops.o loader.o fileops.o util.o vars.o alloc.o <span class="dt">\</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    chooser.o config.o initrd.o alternate.o bootparams.o gunzip.o console.o fs/fs.o choosers/choosers.o <span class="dt">\</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    devschemes/devschemes.o ia64/sysdeps.o glue_localfs.o glue_netfs.o <span class="dt">\</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">-o</span> elilo.so <span class="dt">\</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">\</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">-lefi</span> <span class="at">-lgnuefi</span> <span class="dt">\</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    /usr/lib/gcc/ia64-unknown-linux-gnu/7.2.0/libgcc.a</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="ex">ia64-unknown-linux-gnu-ld:</span> warning: creating a DT_TEXTREL in a shared object.</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="ex">objcopy</span> <span class="at">-j</span> .text <span class="at">-j</span> .sdata <span class="at">-j</span> .data <span class="at">-j</span> .dynamic <span class="at">-j</span> .dynsym <span class="at">-j</span> .rel <span class="dt">\</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">-j</span> .rela <span class="at">-j</span> .reloc <span class="at">--target</span><span class="op">=</span>efi-app-ia64 elilo.so elilo.efi</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> Source <span class="ex">compiled.</span></span></code></pre></div>
<p>Here we see the following steps:</p>
<ul>
<li>With exception of <code>-frename-registers -mfixed-range=f32-f127</code> the
process of building <code>EFI</code> application is almost like building normal
shared library.</li>
<li>Non-standard <code>/usr/lib/elf_ia64_efi.lds</code> linker script is used.</li>
<li><code>objcopy --target=efi-app-ia64</code> is used to create <code>PE32+</code> file
out of <code>ELF64</code>. Very dark magic.</li>
</ul>
<p>Luckily <code>gnu-efi</code> and <code>elilo</code> have <a href="https://sourceforge.net/p/gnu-efi/code/ci/master/tree/README.gnuefi">superb
documentation</a>
(10 pages). All the obscure corners are explained in every detail.
<code>Part 2: Inner Workings</code> is the short description of how every dynamic
linker works with a light touch of <code>ELF</code> -&gt; <code>PE32+</code> conversion. I
wish I have seen this doc years ago :)
Let’s looks at the <code>elf_ia64_efi.lds</code> linker script to get full
understanding of where every byte comes from when <code>elilo.so</code> is being
linked (<a href="https://sourceforge.net/p/gnu-efi/code/ci/master/tree/gnuefi/elf_ia64_efi.lds">sourceforge
viewer</a>):</p>
<pre><code>OUTPUT_FORMAT(&quot;elf64-ia64-little&quot;)
OUTPUT_ARCH(ia64)
ENTRY(_start_plabel)
SECTIONS
{
  . = 0;
  ImageBase = .;
  .hash : { *(.hash) }/* this MUST come first! */
  . = ALIGN(4096);
  .text :
  {
   _text = .;
   *(.text)
   *(.text.*)
   *(.gnu.linkonce.t.*)
   . = ALIGN(16);
  }
  _etext = .;
  _text_size = . - _text;
  . = ALIGN(4096);
  __gp = ALIGN (8) + 0x200000;
  .sdata :
  {
   _data = .;
   *(.got.plt)
   *(.got)
   *(.srodata)
   *(.sdata)
   *(.sbss)
   *(.scommon)
  }
  . = ALIGN(4096);
  .data :
  {
   *(.rodata*)
   *(.ctors)
   *(.data*)
   *(.gnu.linkonce.d*)
   *(.plabel)/* data whose relocs we want to ignore */
   /* the EFI loader doesn't seem to like a .bss section, so we stick
      it all into .data: */
   *(.dynbss)
   *(.bss)
   *(COMMON)
  }
  .note.gnu.build-id : { *(.note.gnu.build-id) }

  . = ALIGN(4096);
  .dynamic  : { *(.dynamic) }
  . = ALIGN(4096);
  .rela :
  {
    *(.rela.text)
    *(.rela.data*)
    *(.rela.sdata)
    *(.rela.got)
    *(.rela.gnu.linkonce.d*)
    *(.rela.stab)
    *(.rela.ctors)
  }
  _edata = .;
  _data_size = . - _etext;
  . = ALIGN(4096);
  .reloc :/* This is the PECOFF .reloc section! */
  {
    *(.reloc)
  }
  . = ALIGN(4096);
  .dynsym   : { *(.dynsym) }
  . = ALIGN(4096);
  .dynstr   : { *(.dynstr) }
  /DISCARD/ :
  {
    *(.rela.plabel)
    *(.rela.reloc)
    *(.IA_64.unwind*)
    *(.IA64.unwind*)
  }
}</code></pre>
<p>Even though the file is very big it’s easy to read. Linker script
defines symbols (as <code>symbol = expression</code>, <code>.</code> (dot) means “current
address”) and output section (as *<code>output-section : { expressions }</code>)
in terms of input sections.
Here is what linker script tries to achieve:</p>
<ul>
<li><code>. = 0;</code> sets load address to <code>0</code>. It does not really matter. At
load time module will be relocated anyway.</li>
<li><code>ImageBase = .</code> means that the new symbol <code>ImageBase</code> is created and
pointed at current address: the very start of the whole output as
nothing was collected yet.</li>
<li><code>.hash : { *(.hash) }</code> means to collect all <code>DT_HASH</code> input
symbol sections into output <code>DT_HASH</code> section. <code>DT_HASH</code> defines
mandatory section of fast symbol lookup. Linker uses that section to
resolve symbol name to symbol type and offset in the file.</li>
<li><code>. = ALIGN(4096)</code> forces linker to pad output (with zeros) to <code>4K</code>
boundary (<code>EFI</code> defines page size as <code>4K</code>).</li>
<li>Only then goes <code>.text : ...</code> section. <code>BaseOfCode</code> is the very
first byte of <code>.text</code> section.</li>
<li>Other things go below.</li>
</ul>
<h2 id="gnu-hash-mystery">GNU hash mystery</h2>
<p>Later <code>objcopy</code> is used to produce final (<code>PE32+</code>) binary by copying
whitelisted sections passed via <code>-j</code>:</p>
<pre><code>objcopy -j .text -j .sdata -j .data -j .dynamic -j .dynsym -j .rel \
        -j .rela -j .reloc --target=efi-app-ia64 elilo.so elilo.efi</code></pre>
<p>While <code>objcopy</code> does not copy <code>.hash</code> section into final binary
it’s mere presence in <code>elilo.so</code> file changes <code>.text</code> offset as
linker already allocated space for it in <code>elilo.so</code> and resolved other
relocations taking offset into account.
So why offset disappeared? Simple! Because <code>gentoo</code> does not generate
<code>.hash</code> sections <a href="https://bugs.gentoo.org/575300#c20">since 2014</a>!
<code>.gnu.hash</code> (<strong>DT_GNU_HASH</strong>) is being used instead. <code>DT_GNU_HASH</code>
was <a href="https://sourceware.org/ml/binutils/2006-06/msg00418.html">added to
binutils/glibc</a>
around 2006 as an optional mechanism to speed up dynamic linking and
dynamic loading.
But linker script does not deal with <code>.gnu.hash</code> sections!
It’s easy to mimic handling of both section types:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/gnuefi/elf_ia64_efi.lds</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/gnuefi/elf_ia64_efi.lds</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -7,2 +7,3 @@ SECTIONS</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>   ImageBase = .;</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>   .hash : { *(.hash) } /* this MUST come first! */</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="va">+  .gnu.hash : { *(.gnu.hash) }</span></span></code></pre></div>
<p>This fix alone was enough to restore <code>elilo.efi</code>! A few other
architectures did not handle it either. See full <a href="https://sourceforge.net/p/gnu-efi/code/ci/2cc0b085fb82e80d43cc08c8376dff9f9532a72d/">upstream
fix</a>.</p>
<h2 id="breakage-mechanics">Breakage mechanics</h2>
<p>But why does it matter? What does it mean to drop <code>.hash</code> section
completely? <code>PE</code> format does not have a <code>.hash</code> equivalent.
Let’s inspect what actually changes in <code>elilo.so</code> file before and
after the patch:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>$ objdump -x elilo.efi.no.gnu.hash &gt; elilo.efi.no.gnu.hash.od</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>$ objdump -x elilo.efi.gnu.hash &gt; elilo.efi.gnu.hash.od</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">--- elilo.efi.no.gnu.hash.od    2018-01-29 23:05:25.776000000 +0000</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ elilo.efi.gnu.hash.od       2018-01-29 23:05:31.700000000 +0000</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -2,2 +2,2 @@</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="st">-elilo.efi.no.gnu.hash:     file format pei-ia64</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="st">-elilo.efi.no.gnu.hash</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="va">+elilo.efi.gnu.hash:     file format pei-ia64</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="va">+elilo.efi.gnu.hash</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -6 +6 @@</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="st">-start address 0x0000000000046d80</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="va">+start address 0x0000000000047d80</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -21,2 +21,2 @@</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="st">-AddressOfEntryPoint    0000000000046d80</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="st">-BaseOfCode             0000000000000000</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="va">+AddressOfEntryPoint    0000000000047d80</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="va">+BaseOfCode             0000000000001000</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -33 +33 @@</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="st">-SizeOfImage            0005f000</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="va">+SizeOfImage            00060000</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -633,39 +633,38 @@</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="st">-[546](sec  1)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x0000000000000000 ImageBase</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="st">-[547](sec  3)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x0000000000007560 Udp4ServiceBindingProtocol</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="st">-[584](sec  2)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x0000000000000110 Optind</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="va">+[546](sec  3)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x0000000000007560 Udp4ServiceBindingProtocol</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="va">+[583](sec  2)(fl 0x00)(ty   0)(scl   2) (nx 0) 0x0000000000000110 Optind</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>...</span></code></pre></div>
<p>Here internal <code>ImageBase</code> symbol became external symbol! Which means
<code>EFI</code> would have to resolve <code>ImageBase</code> at application startup.
That’s why we have seen loader error (as opposed to <code>elilo.efi</code>
runtime errors or kernel boot errors).
<code>ELF</code> spec says shared objects and dynamic executables are required to
have <code>.hash</code> (or <code>.gnu.hash</code>) section to be valid executable but
linker script did not maintain this requirement and all hell broke
loose.
Perhaps linker could be tweaked to report warnings when symbol table is
missing from output file. But as you can see linker scripts are much
more powerful than just implementing fixed output format.</p>
<h2 id="fun-details">Fun details</h2>
<p><code>gnu-efi</code> has a lot of other jewels!</p>
<p>For example, entry point has to point to <code>ia64</code> function descriptor
(<code>FDESCR</code>). <code>FDESCR</code> is a pair of pointers: pointer to code section
(actual entry point) and value of <code>gp</code> register (global pointer, base
pointer used by <code>PIC</code> code).
These two pointers are both absolute addresses. But <code>EFI</code> application
needs to be relocatable (loadable at different addresses).
Entry point <code>FDESCR</code> needs to be relocated by <code>EFI</code> loader.
How would you inject <code>ia64</code> relocation to two 64-bit pointers in
`<code>PE32+</code> format? <code>gnu-efi</code> does a very crazy thing (even more crazy
than relying on <code>objcopy</code> to Just Work)): it injects <code>PE32+</code>
relocation directly into <code>ia64</code> <code>ELF</code> code! That’s how it does the
trick (the snippet below is the very tail of <a href="https://sourceforge.net/p/gnu-efi/code/ci/master/tree/gnuefi/crt0-efi-ia64.S">crt0-efi-ia64.S
file</a>):</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>// PE32<span class="op">+</span> wants a PLABEL<span class="op">,</span> <span class="op">not</span> the code address of the entry point<span class="op">:</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>.<span class="bu">align</span> <span class="dv">16</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>.global _start_plabel</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>.<span class="bu">section</span> <span class="op">.</span>plabel<span class="op">,</span> <span class="st">&quot;a&quot;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="fu">_start_plabel:</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    data8    _start</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    data8    __gp</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>// hand<span class="op">-</span>craft a <span class="op">.</span>reloc section for the plabel<span class="op">:</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>#define IMAGE_REL_BASED_DIR64 <span class="dv">10</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>.<span class="bu">section</span> <span class="op">.</span>reloc<span class="op">,</span> <span class="st">&quot;a&quot;</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    data4    _start_plabel                    <span class="op">//</span> Page <span class="op">RVA</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    data4    <span class="dv">12</span>                               <span class="op">//</span> Block Size <span class="op">(</span><span class="dv">2</span><span class="op">*</span><span class="dv">4</span><span class="op">+</span><span class="dv">2</span><span class="op">*</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    data2    <span class="op">(</span>IMAGE_REL_BASED_DIR64<span class="op">&lt;&lt;</span><span class="dv">12</span><span class="op">)</span> <span class="op">+</span>  <span class="dv">0</span> <span class="op">//</span> reloc for plabel<span class="st">'s entry point</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    data2    <span class="op">(</span>IMAGE_REL_BASED_DIR64<span class="op">&lt;&lt;</span><span class="dv">12</span><span class="op">)</span> <span class="op">+</span>  <span class="dv">8</span> <span class="op">//</span> reloc for plabel<span class="st">'s global pointer</span></span></code></pre></div>
<p>This code generates two sections:</p>
<ul>
<li><code>.plabel</code> with yet unrelocated <code>_start</code> and <code>_gp</code> pointers
(crafts <code>FDESCR</code> itself)</li>
<li><code>.reloc</code> with synthesised raw bytes that look like <code>PE32+</code>
relocation. It’s format is slightly more complicated and is defined
by <code>PE32+</code> spec:
<ul>
<li><code>[4 bytes]</code> 32-bit offset to some blob where relocations are to be
applied, in our case it’s <code>_start_plabel</code></li>
<li><code>[4 bytes]</code> full size of this relocation entry</li>
<li><code>[2 bytes * N relocations]</code> list of tuples: (4 bits for relocation
type, 12-bit offset to data to relocate)</li>
</ul></li>
</ul>
<p>Here we have two relocations that add <code>ImageBase</code>: to <code>_start</code> and
to <code>_gp</code>. And it’s precisely these two relocations that <code>EFI</code>
loader reported as invalid:</p>
<pre><code>ImageAddress: pointer is outside of image
ImageAddress: pointer is outside of image
LoadPe: Section 1 was not loaded</code></pre>
<p>Before <code>.gnu.hash</code> fix <code>ImageBase</code> (<code>ImageAddress</code> in <code>EFI</code>
terminology) was indeed pointing somewhere else.
How about searching internets for source of this <code>EFI</code> loader error?
<code>tianocore</code> has <a href="https://github.com/tianocore/edk2/blob/master/DuetPkg/EfiLdr/PeLoader.c#L324">one
hit</a>
in commented out code:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">//...</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>Base <span class="op">=</span> EfiLdrPeCoffImageAddress <span class="op">(</span>Image<span class="op">,</span> <span class="op">(</span>UINTN<span class="op">)</span>Section<span class="op">-&gt;</span>VirtualAddress<span class="op">);</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>End <span class="op">=</span> EfiLdrPeCoffImageAddress <span class="op">(</span>Image<span class="op">,</span> <span class="op">(</span>UINTN<span class="op">)(</span>Section<span class="op">-&gt;</span>VirtualAddress <span class="op">+</span> Section<span class="op">-&gt;</span>Misc<span class="op">.</span>VirtualSize<span class="op">));</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>EFI_ERROR<span class="op">(</span>Status<span class="op">)</span> <span class="op">||</span> <span class="op">!</span>Base <span class="op">||</span> <span class="op">!</span>End<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">//      DEBUG((D_LOAD|D_ERROR, &quot;LoadPe: Section %d was not loaded\n&quot;, Index));</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    PrintHeader <span class="op">(</span><span class="ch">'L'</span><span class="op">);</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> EFI_LOAD_ERROR<span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">//...</span></span></code></pre></div>
<p>Not very useful but still fun :)</p>
<h2 id="parting-words">Parting words</h2>
<p><code>Itanium</code> was the first system <code>EFI</code> was targeted at and was later
morphed into <code>UEFI</code>. Surprisingly I managed to ignore <code>(U)EFI</code>-based
boot on modern machines and this bug was my first experience to deal
with it. And it was not too bad! :)
I found out a few things along the way:</p>
<ul>
<li><code>ia64</code> <code>EFI</code> is a rich interface to <code>OS</code> and <code>iLO</code> to control
the machine remotely</li>
<li>Linker scripts can do a lot more than I realized:
<ul>
<li>merge sections</li>
<li>discard sections</li>
<li>inject symbols</li>
<li>handle alignments</li>
<li>rename sections</li>
</ul></li>
<li>With certain care <code>objcopy</code> can convert binaries across different
object file formats. In this case <code>ELF64</code> to <code>PE32+</code></li>
<li>Assembler allows you to inject absolutely arbitrary sections into
object files. Just make sure you handle those in your linker script.</li>
<li>Modern GNU toolchain still can breathe life into decade old hardware
to teach us a trick or two.</li>
<li><code>objdump -x</code> is a cool equivalent of <code>readelf</code>.</li>
</ul>
<p>Have fun!</p>
        </div>
    </body>
</html>
