<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>trofi's blog: Bisects all the way down</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/code.css" />
        <link rel="stylesheet" type="text/css" href="../css/highlighting-kate.css" />

        <link rel="alternate" type="application/atom+xml" href="../feed/atom.xml" title="Atom 1.0" />
        <link rel="alternate" type="application/rss+xml" href="../feed/rss.xml" title="RSS 2.0" />
        <link rel="shortcut icon" href="../images/favicon.ico" />
    </head>
    <body>
        <div id="navigation">
            <a href="../">/</a>
            <a href="../archive.html">/archive</a>
            <a href="../feed/atom.xml">/atom</a>
            <a href="../feed/rss.xml">/rss</a>
        </div>

        <div id="content">
            <h1>Bisects all the way down</h1>

            <p>Bisect is a great tool to nail down regression in a project like
<strong>linux</strong> where you usually have no slightest idea what broke
your
<a href="https://fa.linux.kernel.narkive.com/hk0pvpD8/bisected-regression-v3-6-rc1-resume-from-s2ram-does-not-restore-ata-piix-v3-5-worked">suspend</a>,
<a href="https://www.spinics.net/lists/kernel/msg3840785.html">boot</a>,
<a href="https://linux-kernel.vger.kernel.narkive.com/epI9yBFu/bisected-i915-linux-2-6-32-rc3-regression">video</a>,
<a href="https://lore.kernel.org/lkml/YKUjvoaKKggAmpIR@sf/">more video</a>,
<a href="http://yhbt.net/lore/all/20091225162528.5dbbbea0@mosly/">audio</a>,
<a href="https://gitlab.freedesktop.org/pulseaudio/pulseaudio/-/issues/164">tcp</a>,
<a href="https://linux-kernel.vger.kernel.narkive.com/v3qKMlzd/oops-2-6-31-rc1-tun">tun</a>,
<a href="https://www.spinics.net/lists/kernel/msg3840823.html">toaster</a>
and whatnot.</p>
<p>Example of other complex projects are <strong>firefox</strong>, <strong>gcc</strong>, <strong>glibc</strong>
and … complete linux distributions!</p>
<p>Rolling release linux distributions tend to have frequent incremental
updates where each update produces mostly working system. And when
update breaks roll back is cheap and feedback loop to upstream is fast.</p>
<p>The key for rolling release system to work is to be able to narrow down
quickly on faulty component to be able to isolate it.</p>
<p>A typical example of distribution regression would be Firefox failure to
render fonts correctly. What package update caused the regression?
Sometimes we might guess easily if font-related package updated recently
and we might try rolling it back to verify.</p>
<p>But sometimes it’s a compiler or even build environment bug (like bash
<a href="https://gcc.gnu.org/PR88936">miscompilation</a> caused by a gcc bug).
In that case it will take a while until we get to the culprit. Or it
might be a <strong>glibc</strong> regression which is not trivial to rollback at all.</p>
<p>Wouldn’t it be nice to mechanically bisect package repository the same
way we do projects like linux?</p>
<p>Today’s real world example is <a href="https://github.com/NixOS/nixpkgs">nixpkgs</a>
repository. <strong>nixpkgs</strong> is a package tree available via <strong>nix</strong> tool.</p>
<p>One of <strong>nix</strong>’s fancy features is the ability to install packages (and
it’s dependencies) as an unprivileged user. Or even fetch the package
into local cache for one-off use without installing it. Another feature
is precise hermetic dependencies tracking.</p>
<p>Example one-off package usage session:</p>
<pre class><code># existing systemwide package (installed outside nixpkgs)
$ re2c -v
re2c 2.2

# fetching version from nixpkgs:
$ nix-shell -p re2c
[nix-shell:~]$ re2c -v
re2c 2.1.1</code></pre>
<p><strong>nixpkgs</strong> repository has a few branches of different stabilities.
Most frequently encountered are:</p>
<ul>
<li><strong>staging</strong>: things are truly bleeding edge there, no binary cache,
very fresh versions</li>
<li><strong>staging-next</strong>: things are being stabilized here to build and pass
tests before merge to <strong>master</strong></li>
<li><strong>master</strong>: things mostly build there and have binary cache of most
packages</li>
</ul>
<p>More branching details are at <a href="https://github.com/NixOS/rfcs/blob/master/rfcs/0026-staging-workflow.md">https://github.com/NixOS/rfcs/blob/master/rfcs/0026-staging-workflow.md</a>.</p>
<p>I was foolish enough to try building <strong>ccache</strong> out of <strong>staging</strong>
branch (I planned to update it’s version there):</p>
<pre class><code># fetch repository:
$ cd /tmp
$ git clone https://github.com/NixOS/nixpkgs.git
$ cd nixpkgs
$ git checkout staging

# build ccache:
$ nix-build -A ccache
... &lt;a few minutes later&gt;
make[1]: *** [Makefile:998: fig2dev/Makefile] Error 1
make[1]: Leaving directory '/build/transfig.3.2.4'
make: [Makefile:1006: Makefiles] Error 2 (ignored)
make includes
including in ./fig2dev...
make[1]: Entering directory '/build/transfig.3.2.4/fig2dev'
make[1]: *** No rule to make target 'includes'.  Stop.
make[1]: Leaving directory '/build/transfig.3.2.4/fig2dev'
make: *** [Makefile:1064: includes] Error 2
error: builder for '/nix/store/149n49648mzf1c9g199jhq9qi6x35c9v-transfig-3.2.4.drv' failed with exit code 2;</code></pre>
<p>Here we fetched git repository of the whole <strong>nixpkgs</strong> repo and tried
to build <strong>ccache</strong> along with all it’s dependencies. One of them
(<strong>transfig</strong>) failed to build.</p>
<p><strong>transfig</strong> happens to use <strong>imake</strong> build system. I knew nothing
about it and had no idea how to debug it. I looked at the generated
<strong>Makefile</strong>s and still had no idea why (or if) things are wrong there.</p>
<p>Having failed at understanding the failure mode I checked if <strong>master</strong>
branch was able to build <strong>transfig</strong> (it’s normally expected to):</p>
<pre class><code>$ git checkout master

$ nix-build -A transfig
/nix/store/pfzhccslyzgl0wl127yahrk902gj54xs-transfig-3.2.4

$ nix-build -A transfig --check
... &lt;build log&gt;
/nix/store/pfzhccslyzgl0wl127yahrk902gj54xs-transfig-3.2.4</code></pre>
<p>Built fine. <strong>--check</strong> forces local rebuild instead of using binary
available in cache. I used it to get a build log from successful package
and to make sure I don’t have something else horribly broken in my
build environment.</p>
<p>Now I could bisect against <strong>master</strong> and <strong>staging</strong> states:</p>
<pre class><code>$ git bisect start staging master
$ git bisect run nix-build -A transfig
... &lt; a few minutes later&gt;
commit 8675ca0e947f7e847d82828e6bfd4d08822c489c
Date:   Wed Aug 4 08:29:53 2021 +0000

  xorg.xorgcffiles: 1.0.6 -&gt; 1.0.7

  https://lists.x.org/archives/xorg-announce/2021-August/003105.html</code></pre>
<p>Just two shell commands and wer are there! The commit looks vaguely
related to <strong>imake</strong>. Reverting:</p>
<pre class><code>$ git bisect reset
$ git checkout staging
$ git revert 8675ca0e947f7e847d82828e6bfd4d08822c489c # minor conflict fix
$ nix-build -A transfig
...
/nix/store/7z7q1a9176cy0adcs98l4dc8rh9ks4ki-transfig-3.2.4</code></pre>
<p>Revert worked. I looked at the difference between <strong>1.0.6</strong> and
<strong>1.0.7</strong> sources and found nothing obviously broken. I still had no
idea what I was looking at.</p>
<p>We can bisect <strong>xorg-cf-files</strong> project as well. For that we can repoint our
<strong>xorg.xorgcffiles</strong> package to local checkout we could modify:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/pkgs/servers/x11/xorg/overrides.nix</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/pkgs/servers/x11/xorg/overrides.nix</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -841,6 +841,7 @@ self: super:</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>   });</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>   xorgcffiles = super.xorgcffiles.overrideAttrs (attrs: {</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="va">+    src = /tmp/cf; # added line</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>     postInstall = lib.optionalString stdenv.isDarwin ''</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>       substituteInPlace $out/lib/X11/config/darwin.cf --replace &quot;/usr/bin/&quot; &quot;&quot;</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>     '';</span></code></pre></div>
<p>Let’s prepare source tree in <strong>/tmp/cf</strong> as if it was just from tarball:</p>
<pre class><code>$ cd /tmp
$ git clone https://gitlab.freedesktop.org/xorg/util/cf.git
$ cd cf
$ ./autogen.sh</code></pre>
<p>Now we can build <strong>transfig</strong> against local checkout:</p>
<pre class><code>$ nix-build /tmp/nixpkgs -A transfig
... a few seconds later
make: *** No rule to make target 'install'.  Stop.</code></pre>
<p>Same problem.</p>
<p><strong>nix</strong> will rebuild <strong>xorg-cf-files</strong> from local checkout and then will
rebuild all dependencies that need to change automatically. No need to
manually calculate the effect of the update. Sometimes it means a lot of
rebuilds (say, if you bisect <strong>gcc</strong>). But in our case <strong>xorg-cf-files</strong>
dependencies are just <strong>imake</strong> and <strong>transfig</strong>:</p>
<pre class><code>$ nix why-depends -f . --derivation transfig xorg.xorgcffiles
/nix/store/...-transfig-3.2.4.drv
    → /nix/store/...-imake-1.0.8.drv
        → /nix/store/...-xorg-cf-files-1.0.7.drv</code></pre>
<p>Both are tiny packages. Bisecting:</p>
<pre class><code>$ git bisect start xorg-cf-files-1.0.7 xorg-cf-files-1.0.6
$ git bisect run nix-build /tmp/nixpkgs -A transfig
... a second later
commit d47131ed97ee491bb883c29ec0b106e8d5acfcd3
Date:   Thu Jul 5 10:42:09 2018 -0400

    linux: Update LinuxDistribution == LinuxRedHat section</code></pre>
<p>That was simpler than I thought! But still very confusing :) The
<a href="https://gitlab.freedesktop.org/xorg/util/cf/-/commit/d47131ed97ee491bb883c29ec0b106e8d5acfcd3">upstream commit</a>
is literally a few defines under seemingly unrelated <strong>#if</strong>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/linux.cf</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/linux.cf</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -190,7 +190,13 @@ InstallNamedTargetNoClobber(install,file.ad,$(INSTAPPFLAGS),$(XAPPLOADDIR),class</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a> #endif /* LinuxDebian */</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a> #if LinuxDistribution == LinuxRedHat</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="st">-#define FSUseSyslog		YES</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="va">+# define FSUseSyslog		YES</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="va">+# define BuildRman		NO</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="va">+# define BuildHtmlManPages	NO</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="va">+# define ProjectRoot		/usr</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="va">+# define ManPath		/usr/share/man</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="va">+# define XAppLoadDir		/usr/share/X11/app-defaults</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="va">+# define ConfigDir		/usr/share/X11/config</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a> #endif</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a> #ifndef HasDevRandom</span></code></pre></div>
<p><strong>nix</strong> does not use <strong>/usr</strong> host OS hierarchy (in my case host OS is
Gentoo) and always uses <strong>/nix/store</strong> path instead. Thus I would expect
<strong>LinuxDistribution</strong> to be something different from <strong>LinuxRedHat</strong>
(unless it’s a way for <strong>cf</strong> to say “any linux”).</p>
<p>Let’s check how <strong>LinuxDistribution</strong> gets defined. It’s hidden in
<strong>imake</strong> itself. We can extract unpatched and patched <strong>imake</strong>
right from <strong>nixpkgs</strong>:</p>
<pre class><code>$ cd /tmp/nixpkgs
$ nix-shell -A xorg.imake

# unpack vanilla source:
$$ unpackPhase
  unpacking source archive /nix/store/dfjcsfxf15zxrbcw62ml1zbczm8zf7d0-imake-1.0.8.tar.bz2
  source root is imake-1.0.8
  setting SOURCE_DATE_EPOCH to timestamp 1552778797 of file imake-1.0.8/INSTALL

# apply nixkpgs-specific patches:
$$ cd imake-1.0.8
$$ patchPhase
  applying patch /nix/store/9hl5c2sg2n6yfia0hy06wdf7yiry4arq-imake.patch
  patching file imake.c
  applying patch /nix/store/kmhjr434iv05bgazd5xbzwygn59pl9k0-imake-cc-wrapper-uberhack.patch
  patching file imake.c</code></pre>
<p>Here is the unpatched bit of <strong>LinuxRedHat</strong> definition from <a href="https://gitlab.freedesktop.org/xorg/util/imake/-/blob/master/imake.c#L1046">https://gitlab.freedesktop.org/xorg/util/imake/-/blob/master/imake.c#L1046</a>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if defined CROSSCOMPILE || defined linux || defined(__GLIBC__)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>get_distrib<span class="op">(</span><span class="dt">FILE</span> <span class="op">*</span>inFile<span class="op">)</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> stat sb<span class="op">;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">static</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span>   suse <span class="op">=</span> <span class="st">&quot;/etc/SuSE-release&quot;</span><span class="op">;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">static</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> redhat <span class="op">=</span> <span class="st">&quot;/etc/redhat-release&quot;</span><span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">static</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> debian <span class="op">=</span> <span class="st">&quot;/etc/debian_version&quot;</span><span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxUnknown    0&quot;</span><span class="op">);</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxSuSE       1&quot;</span><span class="op">);</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxCaldera    2&quot;</span><span class="op">);</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxCraftworks 3&quot;</span><span class="op">);</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxDebian     4&quot;</span><span class="op">);</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxInfoMagic  5&quot;</span><span class="op">);</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxKheops     6&quot;</span><span class="op">);</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxPro        7&quot;</span><span class="op">);</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxRedHat     8&quot;</span><span class="op">);</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxSlackware  9&quot;</span><span class="op">);</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxTurbo      10&quot;</span><span class="op">);</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxWare       11&quot;</span><span class="op">);</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxYggdrasil  12&quot;</span><span class="op">);</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="pp"># ifdef CROSSCOMPILE</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>CrossCompiling<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>      fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>           <span class="st">&quot;#define DefaultLinuxDistribution LinuxUnknown&quot;</span><span class="op">);</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>      fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistName Unknown&quot;</span><span class="op">);</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="pp"># endif</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>lstat <span class="op">(</span>suse<span class="op">,</span> <span class="op">&amp;</span>sb<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistribution LinuxSuSE&quot;</span><span class="op">);</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistName SuSE&quot;</span><span class="op">);</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>lstat <span class="op">(</span>redhat<span class="op">,</span> <span class="op">&amp;</span>sb<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistribution LinuxRedHat&quot;</span><span class="op">);</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistName RedHat&quot;</span><span class="op">);</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>lstat <span class="op">(</span>debian<span class="op">,</span> <span class="op">&amp;</span>sb<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistribution LinuxDebian&quot;</span><span class="op">);</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistName Debian&quot;</span><span class="op">);</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* You could also try to get the version of the Debian distrib by looking</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="co">     * at the content of /etc/debian_version */</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* what's the definitive way to tell what any particular distribution is? */</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistribution LinuxUnknown&quot;</span><span class="op">);</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistName Unknown&quot;</span><span class="op">);</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* would like to know what version of the distribution it is */</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Distribution flavour is defined by presence of <strong>/etc/redhat-release</strong>
file on disk. But I dont have it! I should have gotten <strong>LinuxUnknown</strong>.</p>
<p>The culprit is in that suspicious <strong>/nix/store/9hl5c2sg2n6yfia0hy06wdf7yiry4arq-imake.patch</strong>
patch we see in <strong>patchPhase</strong> log. It turns the code above to the
following:</p>
<pre class><code>#if defined CROSSCOMPILE || defined linux || defined(__GLIBC__)
static void
get_distrib(FILE *inFile)
{
#if 0
  struct stat sb;

  static const char*   suse = &quot;/etc/SuSE-release&quot;;
  static const char* redhat = &quot;/etc/redhat-release&quot;;
  static const char* debian = &quot;/etc/debian_version&quot;;

  fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxUnknown    0&quot;);
  fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxSuSE       1&quot;);
  fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxCaldera    2&quot;);
  fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxCraftworks 3&quot;);
  fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxDebian     4&quot;);
  fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxInfoMagic  5&quot;);
  fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxKheops     6&quot;);
  fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxPro        7&quot;);
  fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxRedHat     8&quot;);
  fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxSlackware  9&quot;);
  fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxTurbo      10&quot;);
  fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxWare       11&quot;);
  fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxYggdrasil  12&quot;);

# ifdef CROSSCOMPILE
  if (CrossCompiling) {
      fprintf (inFile, &quot;%s\n&quot;,
               &quot;#define DefaultLinuxDistribution LinuxUnknown&quot;);
      fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName Unknown&quot;);
      return;
  }
# endif
  if (lstat (suse, &amp;sb) == 0) {
    fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistribution LinuxSuSE&quot;);
    fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName SuSE&quot;);
    return;
  }
  if (lstat (redhat, &amp;sb) == 0) {
    fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistribution LinuxRedHat&quot;);
    fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName RedHat&quot;);
    return;
  }
  if (lstat (debian, &amp;sb) == 0) {
    fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistribution LinuxDebian&quot;);
    fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName Debian&quot;);
    /* You could also try to get the version of the Debian distrib by looking
     * at the content of /etc/debian_version */
    return;
  }
#endif
  /* what's the definitive way to tell what any particular distribution is? */

  fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistribution LinuxUnknown&quot;);
  fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName Unknown&quot;);
  /* would like to know what version of the distribution it is */
}</code></pre>
<p>Note now <strong>#if 0</strong> removes not just <strong>#define DefaultLinuxDistName LinuxRedHat</strong>
but also <strong>#define LinuxUnknown 0</strong> and <strong>#define LinuxRedHat 8</strong>.</p>
<p>Or in diff form imake’s output change is:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -1,3 +1 @@</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="st">-#define LinuxUnknown    0</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="st">-#define LinuxRedHat     8</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a> #define DefaultLinuxDistName Unknown</span></code></pre></div>
<p>Is it a big deal? How does it change
<strong>#if LinuxDistribution == LinuxRedHat</strong> condition? Let’s try two
following examples:</p>
<pre class><code>$ printf &quot;#define a 1\n#define b 2\n#if a == b\n    EQUAL\n#else\n    DIFFERENT\n#endif\n&quot;
#define a 1
#define b 2
#if a == b
    EQUAL
#else
    DIFFERENT

$ printf &quot;#if a == b\n    EQUAL\n#else\n    DIFFERENT\n#endif\n&quot;
#if a == b
    EQUAL
#else
    DIFFERENT</code></pre>
<p>Running the preprocessor:</p>
<pre class><code>$ printf &quot;#define a 1\n#define b 2\n#if a == b\n    EQUAL\n#else\n    DIFFERENT\n#endif\n&quot; | gcc -E -
    DIFFERENT

$ printf &quot;#if a == b\n    EQUAL\n#else\n    DIFFERENT\n#endif\n&quot; | gcc -E -
    EQUAL</code></pre>
<p>According to great <strong>imake</strong> intro at <a href="http://www.snake.net/software/imake-stuff/config-X11R4.pdf">http://www.snake.net/software/imake-stuff/config-X11R4.pdf</a>
it’s one of the common <strong>imake</strong> pitfalls: in integer evaluation
contexts unknown symbols get turned onto zeros.</p>
<pre class><code>$ printf &quot;#if undef == 0\n    ZERO\n#endif\n&quot;
#if undef == 0
    ZERO
#endif
$ printf &quot;#if undef == 0\n    ZERO\n#endif\n&quot; | gcc -E -
    ZERO</code></pre>
<p>Thus the fix is trivial: don’t omit any enum definition
as other packages using <strong>imake</strong> actually rely on them being present.
Possible fix:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/imake.c</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/imake.c</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -998,121 +998,121 @@ get_libc_version(FILE *inFile)</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a> #if defined CROSSCOMPILE || defined linux || defined(__GLIBC__)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a> static void</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a> get_distrib(FILE *inFile)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a> {</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="st">-#if 0</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>   struct stat sb;</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>   static const char*   suse = &quot;/etc/SuSE-release&quot;;</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>   static const char* redhat = &quot;/etc/redhat-release&quot;;</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>   static const char* debian = &quot;/etc/debian_version&quot;;</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxUnknown    0&quot;);</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxSuSE       1&quot;);</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxCaldera    2&quot;);</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxCraftworks 3&quot;);</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxDebian     4&quot;);</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxInfoMagic  5&quot;);</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxKheops     6&quot;);</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxPro        7&quot;);</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxRedHat     8&quot;);</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxSlackware  9&quot;);</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxTurbo      10&quot;);</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxWare       11&quot;);</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxYggdrasil  12&quot;);</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="va">+#if 0</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a> # ifdef CROSSCOMPILE</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>   if (CrossCompiling) {</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>       fprintf (inFile, &quot;%s\n&quot;,</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>               &quot;#define DefaultLinuxDistribution LinuxUnknown&quot;);</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>       fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName Unknown&quot;);</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>       return;</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a> # endif</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>   if (lstat (suse, &amp;sb) == 0) {</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>     fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistribution LinuxSuSE&quot;);</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>     fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName SuSE&quot;);</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>     return;</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>   if (lstat (redhat, &amp;sb) == 0) {</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>     fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistribution LinuxRedHat&quot;);</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>     fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName RedHat&quot;);</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>     return;</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>   if (lstat (debian, &amp;sb) == 0) {</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>     fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistribution LinuxDebian&quot;);</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>     fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName Debian&quot;);</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>     /* You could also try to get the version of the Debian distrib by looking</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>      * at the content of /etc/debian_version */</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>     return;</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a> #endif</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>   /* what's the definitive way to tell what any particular distribution is? */</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistribution LinuxUnknown&quot;);</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName Unknown&quot;);</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>   /* would like to know what version of the distribution it is */</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a> }</span></code></pre></div>
<p>We move <strong>#if 0</strong> below to always define <strong>#define LinuxRedHat 8</strong> and friends.</p>
<p>Original <a href="https://github.com/NixOS/nixpkgs/commit/7dba8848ed4bcceb4187a754f221af26f10b2063">imake.patch</a>
was added in 2006. This makes it 15 years old bug.</p>
<p>The fix is pending at <a href="https://github.com/NixOS/nixpkgs/pull/135414">https://github.com/NixOS/nixpkgs/pull/135414</a>
pull request. Fixing <strong>imake</strong> immediately broke <strong>xcruiser</strong>,
<strong>xvkbd</strong> and <strong>xxkb</strong> packages (reviewers++). It was failing for the
lack of path overrides that were now exposed on non-<strong>LinuxRedHat</strong>
systems. We will probably see more subtle breakages. I hope future
breakages will not be as magic as this one.</p>
<p>Now I can test my <strong>ccache</strong> update against <strong>nixpkgs/staging</strong>.</p>
<p><a href="http://www.snake.net/software/imake-stuff/config-X11R4.pdf">Imake doc</a>
shares a few amusing facts and subtle tips on how to workaround certain
C preprocessor behaviours to force it to generate valid makefiles. For
example if you want cpp to print ‘#’ you need to prepend it with … a
C comment!</p>
<pre class><code>$ printf '# Makefile comment\n'
# Makefile comment

$ printf '# Makefile comment\n' | gcc -traditional -E -
&lt;stdin&gt;:1:3: error: invalid preprocessing directive #Makefile

$ printf '/**/# Makefile comment\n' | gcc -traditional -E -
# Makefile comment</code></pre>
<h1 id="parting-words">Parting words</h1>
<p><strong>nixpkgs</strong> makes it trivial to bisect faulty package updates on
a package level as you would normally do it on project level.</p>
<p>I found a few new things along the way:</p>
<ul>
<li><strong>nixs</strong>’s dependency “resolution” is instant. Constructing
dependency graph is so much faster than trying to search a path in
existing graph (like Gentoo’s portage does).</li>
<li><strong>nix-shell</strong> is a nice way to poke at package unpacking,
building and intallation steps.</li>
<li><strong>imake</strong> is both fun and scary way to (ab)use C preprocessor to
generate <strong>Makefile</strong>s.</li>
</ul>
<p>Have fun!</p>

<div class="info">
    Posted on September  1, 2021 by trofi. <a href="mailto:slyich@gmail.com">Email</a>,
    <a href="https://github.com/trofi/trofi.github.io.gen">pull requests or comments</a>
    are welcome!
</div>

        </div>
        <div id="footer">
            powered by <a href="http://jaspervdj.be/hakyll">hakyll</a>
        </div>
    </body>
</html>
