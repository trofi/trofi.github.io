<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bisects all the way down</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="stylesheet" type="text/css" href="../css/code.css" />
        <link rel="stylesheet" type="text/css" href="../css/skylighting.css" />

        <link rel="alternate" type="application/atom+xml" href="../feed/atom.xml" title="Atom 1.0" />
        <link rel="alternate" type="application/rss+xml" href="../feed/rss.xml" title="RSS 2.0" />
        <link rel="shortcut icon" href="../images/favicon.ico" />
    </head>
    <body>
        <div id="navigation">
            <a href="../">home</a>
            <a href="../blog.html">blog</a>
            <a href="../log.html">log</a>
            <a href="../feed/atom.xml">atom</a>
            <a href="../feed/rss.xml">rss</a>
            <a href="../about.html">about</a>
            <a href="../contact.html">contact</a>
        </div>

        <div id="content">
            <h1>Bisects all the way down</h1>
            
                <div class="info">September  1, 2021</div>
            

            <p>Bisect is a great tool to nail down regression in a project like
<code>linux</code> where you usually have no slightest idea what broke your
<a href="https://fa.linux.kernel.narkive.com/hk0pvpD8/bisected-regression-v3-6-rc1-resume-from-s2ram-does-not-restore-ata-piix-v3-5-worked">suspend</a>,
<a href="https://www.spinics.net/lists/kernel/msg3840785.html">boot</a>,
<a href="https://linux-kernel.vger.kernel.narkive.com/epI9yBFu/bisected-i915-linux-2-6-32-rc3-regression">video</a>,
<a href="https://lore.kernel.org/lkml/YKUjvoaKKggAmpIR@sf/">more video</a>,
<a href="http://yhbt.net/lore/all/20091225162528.5dbbbea0@mosly/">audio</a>,
<a href="https://gitlab.freedesktop.org/pulseaudio/pulseaudio/-/issues/164">TCP</a>,
<a href="https://linux-kernel.vger.kernel.narkive.com/v3qKMlzd/oops-2-6-31-rc1-tun">tun</a>,
<a href="https://www.spinics.net/lists/kernel/msg3840823.html">toaster</a> and
whatnot.</p>
<p>Examples of other complex projects are <code>firefox</code>, <code>gcc</code>, <code>glibc</code>
and … complete <code>linux</code> distributions!
Rolling release <code>linux</code> distributions tend to have frequent incremental
updates where each update produces mostly working system. And when
update breaks roll back is cheap and feedback loop to upstream is fast.
The key for rolling release system to work smoothly is to be able to
narrow down quickly on faulty component to be able to isolate it.
A typical example of distribution regression would be <code>firefox</code> failure
to render fonts correctly. What package update caused the regression?
Sometimes we might guess easily if font-related package updated recently
and we might try rolling it back to verify.
But sometimes it’s a compiler or even build environment bug (like <code>bash</code>
<a href="https://gcc.gnu.org/PR88936">miscompilation</a> caused by a <code>gcc</code> bug). In
that case it will take a while until we get to the culprit. Or it might
be a <code>glibc</code> regression which is not trivial to rollback at all.
Wouldn’t it be nice to mechanically bisect package repository the same
way we do projects like <code>linux</code>?</p>
<p>Today’s real world example is
<a href="https://github.com/NixOS/nixpkgs"><code>nixpkgs</code></a> repository. <code>nixpkgs</code> is a
package tree available via <code>nix</code> tool.
One of <code>nix</code> fancy features is the ability to install packages (and
it’s dependencies) as an unprivileged user. Or even fetch the package
into local cache for one-off use without installing it. Another feature
is precise hermetic dependencies tracking.</p>
<p>Example one-off package usage session:</p>
<pre><code># existing systemwide package (installed outside nixpkgs)
$ re2c -v
re2c 2.2

# fetching version from nixpkgs:
$ nix-shell -p re2c
[nix-shell:~]$ re2c -v
re2c 2.1.1</code></pre>
<p><code>nixpkgs</code> repository has a few branches of different stability. Most
frequently encountered are:</p>
<ul>
<li><code>staging</code>: things are truly bleeding edge there, no binary cache,
very fresh versions</li>
<li><code>staging-next</code>: things are being stabilized here to build and pass
tests before merge to <code>master</code></li>
<li><code>master</code>: things mostly build there and have binary cache of most
packages</li>
</ul>
<p>More branching details are at
<a href="https://github.com/NixOS/rfcs/blob/master/rfcs/0026-staging-workflow.md" class="uri">https://github.com/NixOS/rfcs/blob/master/rfcs/0026-staging-workflow.md</a>.</p>
<p>Back to the example at hand. I was foolish enough to try building
<code>ccache</code> out of <code>staging</code> branch (I planned to update it’s version
there) and got the build failure:</p>
<pre><code># fetch repository:
$ cd /tmp
$ git clone https://github.com/NixOS/nixpkgs.git
$ cd nixpkgs
$ git checkout staging

# build ccache:
$ nix-build -A ccache
... &lt;a few minutes later&gt;
make[1]: *** [Makefile:998: fig2dev/Makefile] Error 1
make[1]: Leaving directory '/build/transfig.3.2.4'
make: [Makefile:1006: Makefiles] Error 2 (ignored)
make includes
including in ./fig2dev...
make[1]: Entering directory '/build/transfig.3.2.4/fig2dev'
make[1]: *** No rule to make target 'includes'.  Stop.
make[1]: Leaving directory '/build/transfig.3.2.4/fig2dev'
make: *** [Makefile:1064: includes] Error 2
error: builder for '/nix/store/149n49648mzf1c9g199jhq9qi6x35c9v-transfig-3.2.4.drv' failed with exit code 2;</code></pre>
<p>Here we fetched git repository of the whole <code>nixpkgs</code> and tried
to build <code>ccache</code> along with all of it’s dependencies. One of them
(<code>transfig</code>) failed to build.
<code>transfig</code> happens to use <code>imake</code> build system. I knew nothing about
it and had no idea how to debug it. I looked at the generated
<code>Makefile</code> and still had no idea why (or if) things are wrong there.
Having failed at understanding the failure mode I checked if <code>master</code>
branch was able to build <code>transfig</code> (most packages ar normally expected
to build on <code>master</code>):</p>
<pre><code>$ git checkout master

$ nix-build -A transfig
/nix/store/pfzhccslyzgl0wl127yahrk902gj54xs-transfig-3.2.4

$ nix-build -A transfig --check
... &lt;build log&gt;
/nix/store/pfzhccslyzgl0wl127yahrk902gj54xs-transfig-3.2.4</code></pre>
<p>Built fine. <code>--check</code> forces local rebuild instead of using binary
available in cache. I used it to get a build log from successful package
and to make sure I don’t have something else horribly broken in my
build environment.
Now I could bisect against <code>master</code> and <code>staging</code> range:</p>
<pre><code>$ git bisect start staging master
$ git bisect run nix-build -A transfig
... &lt; a few minutes later&gt;
commit 8675ca0e947f7e847d82828e6bfd4d08822c489c
Date:   Wed Aug 4 08:29:53 2021 +0000

  xorg.xorgcffiles: 1.0.6 -&gt; 1.0.7

  https://lists.x.org/archives/xorg-announce/2021-August/003105.html</code></pre>
<p>Just two shell commands and we are there! The commit looks vaguely
related to <code>imake</code>. Reverting:</p>
<pre><code>$ git bisect reset
$ git checkout staging
$ git revert 8675ca0e947f7e847d82828e6bfd4d08822c489c # minor conflict fix
$ nix-build -A transfig
...
/nix/store/7z7q1a9176cy0adcs98l4dc8rh9ks4ki-transfig-3.2.4</code></pre>
<p>Revert worked. I looked at the difference between <code>1.0.6</code> and
<code>1.0.7</code> sources and found nothing obviously broken. I still had no
idea what I was looking at.
We can bisect <code>xorg-cf-files</code> project as well! For that we can point
our <code>xorg.xorgcffiles</code> package to local checkout we could modify:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/pkgs/servers/x11/xorg/overrides.nix</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/pkgs/servers/x11/xorg/overrides.nix</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -841,6 +841,7 @@ self: super:</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>   });</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>   xorgcffiles = super.xorgcffiles.overrideAttrs (attrs: {</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="va">+    src = /tmp/cf; # added line</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>     postInstall = lib.optionalString stdenv.isDarwin ''</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>       substituteInPlace $out/lib/X11/config/darwin.cf --replace &quot;/usr/bin/&quot; &quot;&quot;</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>     '';</span></code></pre></div>
<p>Let’s prepare source tree in <code>/tmp/cf</code> as if it was just from
tarball:</p>
<pre><code>$ cd /tmp
$ git clone https://gitlab.freedesktop.org/xorg/util/cf.git
$ cd cf
$ ./autogen.sh</code></pre>
<p>Now we can build <code>transfig</code> against local checkout:</p>
<pre><code>$ nix-build /tmp/nixpkgs -A transfig
... a few seconds later
make: *** No rule to make target 'install'.  Stop.</code></pre>
<p>Same problem.</p>
<p><code>nix</code> will rebuild <code>xorg-cf-files</code> from local checkout and then will
rebuild all dependencies that need to change automatically. No need to
manually calculate the effect of the update. Sometimes it means a lot of
rebuilds (say, if you bisect <code>gcc</code> itself). But in our case
<code>xorg-cf-files</code> dependencies are just <code>imake</code> and <code>transfig</code>:</p>
<pre><code>$ nix why-depends -f . --derivation transfig xorg.xorgcffiles
/nix/store/...-transfig-3.2.4.drv
    → /nix/store/...-imake-1.0.8.drv
        → /nix/store/...-xorg-cf-files-1.0.7.drv</code></pre>
<p>Both are tiny packages. Bisecting:</p>
<pre><code>$ git bisect start xorg-cf-files-1.0.7 xorg-cf-files-1.0.6
$ git bisect run nix-build /tmp/nixpkgs -A transfig
... a second later
commit d47131ed97ee491bb883c29ec0b106e8d5acfcd3
Date:   Thu Jul 5 10:42:09 2018 -0400

    linux: Update LinuxDistribution == LinuxRedHat section</code></pre>
<p>That was simpler than I thought! But still very confusing :) The
<a href="https://gitlab.freedesktop.org/xorg/util/cf/-/commit/d47131ed97ee491bb883c29ec0b106e8d5acfcd3">upstream
commit</a>
is literally a few defines under seemingly unrelated <code>#if</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/linux.cf</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/linux.cf</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -190,7 +190,13 @@ InstallNamedTargetNoClobber(install,file.ad,$(INSTAPPFLAGS),$(XAPPLOADDIR),class</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a> #endif /* LinuxDebian */</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a> #if LinuxDistribution == LinuxRedHat</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="st">-#define FSUseSyslog        YES</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="va">+# define FSUseSyslog       YES</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="va">+# define BuildRman     NO</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="va">+# define BuildHtmlManPages NO</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="va">+# define ProjectRoot       /usr</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="va">+# define ManPath       /usr/share/man</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="va">+# define XAppLoadDir       /usr/share/X11/app-defaults</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="va">+# define ConfigDir     /usr/share/X11/config</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a> #endif</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a> #ifndef HasDevRandom</span></code></pre></div>
<p><code>nix</code> does not use <code>/usr</code> host OS hierarchy (in my case host OS is
<code>gentoo</code>) and always uses <code>/nix/store</code> path instead. Thus I would expect
<code>LinuxDistribution</code> to be something different from <code>LinuxRedHat</code>
(unless it’s a way for <code>cf</code> to say “any linux”).
Let’s check how <code>LinuxDistribution</code> gets defined. It’s hidden in
<code>imake</code> itself. We can extract unpatched and patched <code>imake</code> right
from <code>nixpkgs</code>:</p>
<pre><code>$ cd /tmp/nixpkgs
$ nix-shell -A xorg.imake

# unpack vanilla source:
$$ unpackPhase
  unpacking source archive /nix/store/dfjcsfxf15zxrbcw62ml1zbczm8zf7d0-imake-1.0.8.tar.bz2
  source root is imake-1.0.8
  setting SOURCE_DATE_EPOCH to timestamp 1552778797 of file imake-1.0.8/INSTALL

# apply nixkpgs-specific patches:
$$ cd imake-1.0.8
$$ patchPhase
  applying patch /nix/store/9hl5c2sg2n6yfia0hy06wdf7yiry4arq-imake.patch
  patching file imake.c
  applying patch /nix/store/kmhjr434iv05bgazd5xbzwygn59pl9k0-imake-cc-wrapper-uberhack.patch
  patching file imake.c</code></pre>
<p>Here is the unpatched bit of <code>LinuxRedHat</code> definition from
<a href="https://gitlab.freedesktop.org/xorg/util/imake/-/blob/master/imake.c#L1046" class="uri">https://gitlab.freedesktop.org/xorg/util/imake/-/blob/master/imake.c#L1046</a>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if defined CROSSCOMPILE || defined linux || defined(__GLIBC__)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>get_distrib<span class="op">(</span><span class="dt">FILE</span> <span class="op">*</span>inFile<span class="op">)</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> stat sb<span class="op">;</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">static</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span>   suse <span class="op">=</span> <span class="st">&quot;/etc/SuSE-release&quot;</span><span class="op">;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">static</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> redhat <span class="op">=</span> <span class="st">&quot;/etc/redhat-release&quot;</span><span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">static</span> <span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> debian <span class="op">=</span> <span class="st">&quot;/etc/debian_version&quot;</span><span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxUnknown    0&quot;</span><span class="op">);</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxSuSE       1&quot;</span><span class="op">);</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxCaldera    2&quot;</span><span class="op">);</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxCraftworks 3&quot;</span><span class="op">);</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxDebian     4&quot;</span><span class="op">);</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxInfoMagic  5&quot;</span><span class="op">);</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxKheops     6&quot;</span><span class="op">);</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxPro        7&quot;</span><span class="op">);</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxRedHat     8&quot;</span><span class="op">);</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxSlackware  9&quot;</span><span class="op">);</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxTurbo      10&quot;</span><span class="op">);</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxWare       11&quot;</span><span class="op">);</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define LinuxYggdrasil  12&quot;</span><span class="op">);</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="pp"># ifdef CROSSCOMPILE</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>CrossCompiling<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>      fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>           <span class="st">&quot;#define DefaultLinuxDistribution LinuxUnknown&quot;</span><span class="op">);</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>      fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistName Unknown&quot;</span><span class="op">);</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span><span class="op">;</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="pp"># endif</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>lstat <span class="op">(</span>suse<span class="op">,</span> <span class="op">&amp;</span>sb<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistribution LinuxSuSE&quot;</span><span class="op">);</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistName SuSE&quot;</span><span class="op">);</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>lstat <span class="op">(</span>redhat<span class="op">,</span> <span class="op">&amp;</span>sb<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistribution LinuxRedHat&quot;</span><span class="op">);</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistName RedHat&quot;</span><span class="op">);</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>lstat <span class="op">(</span>debian<span class="op">,</span> <span class="op">&amp;</span>sb<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistribution LinuxDebian&quot;</span><span class="op">);</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistName Debian&quot;</span><span class="op">);</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* You could also try to get the version of the Debian distrib by looking</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="co">     * at the content of /etc/debian_version */</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* what's the definitive way to tell what any particular distribution is? */</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistribution LinuxUnknown&quot;</span><span class="op">);</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistName Unknown&quot;</span><span class="op">);</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* would like to know what version of the distribution it is */</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Distribution flavor is defined by presence of <code>/etc/redhat-release</code>
file on disk. But I don’t have it! I should have gotten <code>LinuxUnknown</code>.
The culprit is in that suspicious
<code>/nix/store/9hl5c2sg2n6yfia0hy06wdf7yiry4arq-imake.patch</code> patch we see
in <code>patchPhase</code> log. It turns the code above to the following:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if defined CROSSCOMPILE || defined linux || defined(__GLIBC__)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>get_distrib<span class="op">(</span><span class="dt">FILE</span> <span class="op">*</span>inFile<span class="op">)</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#if 0</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">  struct stat sb;</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">  static const char*   suse = </span><span class="st">&quot;/etc/SuSE-release&quot;</span><span class="co">;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">  static const char* redhat = </span><span class="st">&quot;/etc/redhat-release&quot;</span><span class="co">;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">  static const char* debian = </span><span class="st">&quot;/etc/debian_version&quot;</span><span class="co">;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">  fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define LinuxUnknown    0&quot;</span><span class="co">);</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">  fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define LinuxSuSE       1&quot;</span><span class="co">);</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">  fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define LinuxCaldera    2&quot;</span><span class="co">);</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">  fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define LinuxCraftworks 3&quot;</span><span class="co">);</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">  fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define LinuxDebian     4&quot;</span><span class="co">);</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">  fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define LinuxInfoMagic  5&quot;</span><span class="co">);</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">  fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define LinuxKheops     6&quot;</span><span class="co">);</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">  fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define LinuxPro        7&quot;</span><span class="co">);</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co">  fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define LinuxRedHat     8&quot;</span><span class="co">);</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co">  fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define LinuxSlackware  9&quot;</span><span class="co">);</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co">  fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define LinuxTurbo      10&quot;</span><span class="co">);</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co">  fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define LinuxWare       11&quot;</span><span class="co">);</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co">  fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define LinuxYggdrasil  12&quot;</span><span class="co">);</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co"># ifdef CROSSCOMPILE</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co">  if (CrossCompiling) {</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="co">      fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">,</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co">               </span><span class="st">&quot;#define DefaultLinuxDistribution LinuxUnknown&quot;</span><span class="co">);</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co">      fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define DefaultLinuxDistName Unknown&quot;</span><span class="co">);</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="co">      return;</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co">  }</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co"># endif</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="co">  if (lstat (suse, &amp;sb) == 0) {</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="co">    fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define DefaultLinuxDistribution LinuxSuSE&quot;</span><span class="co">);</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="co">    fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define DefaultLinuxDistName SuSE&quot;</span><span class="co">);</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a><span class="co">    return;</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="co">  }</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="co">  if (lstat (redhat, &amp;sb) == 0) {</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="co">    fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define DefaultLinuxDistribution LinuxRedHat&quot;</span><span class="co">);</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="co">    fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define DefaultLinuxDistName RedHat&quot;</span><span class="co">);</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="co">    return;</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="co">  }</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="co">  if (lstat (debian, &amp;sb) == 0) {</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="co">    fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define DefaultLinuxDistribution LinuxDebian&quot;</span><span class="co">);</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a><span class="co">    fprintf (inFile, </span><span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="co">, </span><span class="st">&quot;#define DefaultLinuxDistName Debian&quot;</span><span class="co">);</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="co">    /* You could also try to get the version of the Debian distrib by looking</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a><span class="co">     * at the content of /etc/debian_version */</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a><span class="co">    return;</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a><span class="co">  }</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* what's the definitive way to tell what any particular distribution is? */</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistribution LinuxUnknown&quot;</span><span class="op">);</span></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>  fprintf <span class="op">(</span>inFile<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> <span class="st">&quot;#define DefaultLinuxDistName Unknown&quot;</span><span class="op">);</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>  <span class="co">/* would like to know what version of the distribution it is */</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note now <code>#if 0</code> removes not just <code>#define DefaultLinuxDistName LinuxRedHat</code> but also <code>#define LinuxUnknown 0</code> and <code>#define LinuxRedHat 8</code>. In diff form <code>imake</code> output change is:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -1,3 +1 @@</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="st">-#define LinuxUnknown    0</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="st">-#define LinuxRedHat     8</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a> #define DefaultLinuxDistName Unknown</span></code></pre></div>
<p>Is it a big deal? How does it change <code>#if LinuxDistribution == LinuxRedHat</code> condition? Let’s try two following examples:</p>
<pre><code>$ printf &quot;#define a 1\n#define b 2\n#if a == b\n    EQUAL\n#else\n    DIFFERENT\n#endif\n&quot;
#define a 1
#define b 2
#if a == b
    EQUAL
#else
    DIFFERENT

$ printf &quot;#if a == b\n    EQUAL\n#else\n    DIFFERENT\n#endif\n&quot;
#if a == b
    EQUAL
#else
    DIFFERENT</code></pre>
<p>Running the preprocessor:</p>
<pre><code>$ printf &quot;#define a 1\n#define b 2\n#if a == b\n    EQUAL\n#else\n    DIFFERENT\n#endif\n&quot; | gcc -E -
    DIFFERENT

$ printf &quot;#if a == b\n    EQUAL\n#else\n    DIFFERENT\n#endif\n&quot; | gcc -E -
    EQUAL</code></pre>
<p>According to great <code>imake</code> intro at
<a href="http://www.snake.net/software/imake-stuff/config-X11R4.pdf" class="uri">http://www.snake.net/software/imake-stuff/config-X11R4.pdf</a> it’s one
of the common <code>imake</code> pitfalls: in integer evaluation contexts unknown
symbols get turned onto zeros.</p>
<pre><code>$ printf &quot;#if undef == 0\n    ZERO\n#endif\n&quot;
#if undef == 0
    ZERO
#endif

$ printf &quot;#if undef == 0\n    ZERO\n#endif\n&quot; | gcc -E -
    ZERO</code></pre>
<p>Thus the fix is trivial: don’t omit any enum definition as other
packages using <code>imake</code> actually rely on them being present. Possible
fix:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">--- a/imake.c</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/imake.c</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -998,121 +998,121 @@ get_libc_version(FILE *inFile)</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a> #if defined CROSSCOMPILE || defined linux || defined(__GLIBC__)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a> static void</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a> get_distrib(FILE *inFile)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a> {</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="st">-#if 0</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>   struct stat sb;</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>   static const char*   suse = &quot;/etc/SuSE-release&quot;;</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>   static const char* redhat = &quot;/etc/redhat-release&quot;;</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>   static const char* debian = &quot;/etc/debian_version&quot;;</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxUnknown    0&quot;);</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxSuSE       1&quot;);</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxCaldera    2&quot;);</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxCraftworks 3&quot;);</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxDebian     4&quot;);</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxInfoMagic  5&quot;);</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxKheops     6&quot;);</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxPro        7&quot;);</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxRedHat     8&quot;);</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxSlackware  9&quot;);</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxTurbo      10&quot;);</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxWare       11&quot;);</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define LinuxYggdrasil  12&quot;);</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="va">+#if 0</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a> # ifdef CROSSCOMPILE</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>   if (CrossCompiling) {</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>       fprintf (inFile, &quot;%s\n&quot;,</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>               &quot;#define DefaultLinuxDistribution LinuxUnknown&quot;);</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>       fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName Unknown&quot;);</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>       return;</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a> # endif</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>   if (lstat (suse, &amp;sb) == 0) {</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>     fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistribution LinuxSuSE&quot;);</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>     fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName SuSE&quot;);</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>     return;</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>   if (lstat (redhat, &amp;sb) == 0) {</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>     fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistribution LinuxRedHat&quot;);</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>     fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName RedHat&quot;);</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>     return;</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>   if (lstat (debian, &amp;sb) == 0) {</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>     fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistribution LinuxDebian&quot;);</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>     fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName Debian&quot;);</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>     /* You could also try to get the version of the Debian distrib by looking</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>      * at the content of /etc/debian_version */</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>     return;</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a> #endif</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>   /* what's the definitive way to tell what any particular distribution is? */</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistribution LinuxUnknown&quot;);</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>   fprintf (inFile, &quot;%s\n&quot;, &quot;#define DefaultLinuxDistName Unknown&quot;);</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>   /* would like to know what version of the distribution it is */</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a> }</span></code></pre></div>
<p>We move <code>#if 0</code> below to always define <code>#define LinuxRedHat 8</code> and
friends.
Original
<a href="https://github.com/NixOS/nixpkgs/commit/7dba8848ed4bcceb4187a754f221af26f10b2063"><code>imake.patch</code></a>
was added in 2006. This makes it 15 years old bug.</p>
<p>The fix is pending at <a href="https://github.com/NixOS/nixpkgs/pull/135414" class="uri">https://github.com/NixOS/nixpkgs/pull/135414</a>
pull request. Fixing <code>imake</code> immediately broke <code>xcruiser</code>, <code>xvkbd</code>
and <code>xxkb</code> packages (reviewers++). It was failing for the lack of path
overrides that were now exposed on non-<code>LinuxRedHat</code> systems. We will
probably see more subtle breakages. I hope future breakages will not be
as magic as this one.
Now I can test my <code>ccache</code> update against <code>nixpkgs/staging</code>.</p>
<p><a href="http://www.snake.net/software/imake-stuff/config-X11R4.pdf">Imake doc</a>
shares a few amusing facts and subtle tips on how to work around certain
C preprocessor behaviours to force it to generate valid <code>Makefile</code>. For
example if you want <code>cpp</code> to print <code>'#'</code> you need to prepend it with …
a <code>c</code> comment!</p>
<pre><code>$ printf '# Makefile comment\n'
# Makefile comment

$ printf '# Makefile comment\n' | gcc -traditional -E -
&lt;stdin&gt;:1:3: error: invalid preprocessing directive #Makefile

$ printf '/**/# Makefile comment\n' | gcc -traditional -E -
# Makefile comment</code></pre>
<h2 id="parting-words">Parting words</h2>
<p><code>nixpkgs</code> makes it trivial to bisect faulty package updates on a
package level as you would normally do it on project level.</p>
<p>I found a few new things along the way:</p>
<ul>
<li><code>nix</code> dependency “resolution” is instant. Constructing
dependency graph is so much faster than trying to search a path in
existing graph (like <code>gentoo</code>s <code>portage</code> does).</li>
<li><code>nix-shell</code> is a nice way to poke at package unpacking, building and
installation steps.</li>
<li><code>imake</code> is both fun and scary way to (ab)use <code>c</code> preprocessor to
generate <code>Makefile</code>s.</li>
</ul>
<p>Have fun!</p>
        </div>
    </body>
</html>
